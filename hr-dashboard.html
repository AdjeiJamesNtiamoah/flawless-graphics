<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Flawless Graphics — HR Dashboard (Advanced)</title>

<!-- Fonts & icons -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- jsPDF (export PDF) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{
    --bg:#f6f8fb; --card:#ffffff; --muted:#6b7a89; --accent:#0b63a3; --accent2:#00a6b6;
    --success:#16a34a; --danger:#e02424; --glass: rgba(2,10,30,0.03);
  }
  .dark{ --bg:#071027; --card:#0f1b2b; --muted:#9fb4c9; --accent:#00d1ff; --accent2:#7a00ff; color:#e8f6ff;}
  *{box-sizing:border-box}
  body{margin:0;font-family:'Poppins',sans-serif;background:var(--bg);color:inherit;transition:background .25s}
  header{display:flex;align-items:center;gap:12px;padding:14px 20px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff}
  header .brand{font-weight:700;font-size:18px}
  .wrap{max-width:1200px;margin:20px auto;padding:0 16px}
  .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:16px}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{background:transparent;border:1px solid rgba(0,0,0,0.08);padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600}
  .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;border:0}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 20px var(--glass);border:1px solid rgba(0,0,0,0.04)}
  .col-3{grid-column:span 3}
  .col-4{grid-column:span 4}
  .col-6{grid-column:span 6}
  .col-12{grid-column:span 12}
  h3{margin:0 0 8px 0}
  .kpi{display:flex;flex-direction:column;gap:6px}
  .kpi .value{font-size:22px;font-weight:700}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:left;font-size:14px}
  th{background:linear-gradient(90deg,rgba(0,0,0,0.02),transparent);position:sticky;top:0}
  .scroll{max-height:320px;overflow:auto}
  .small{font-size:13px;color:var(--muted)}
  /* Toast */
  #toast{position:fixed;right:20px;bottom:20px;padding:12px 16px;border-radius:10px;background:#022;color:#fff;display:none;z-index:9999}
  #toast.show{display:block;animation:toastIn .35s ease}
  @keyframes toastIn{from{transform:translateY(12px);opacity:0}to{transform:none;opacity:1}}
  /* draggable placeholder */
  .widget{cursor:grab}
  .dragging{opacity:0.6}
  /* responsive */
  @media(max-width:960px){ .col-3,.col-4{grid-column:span 6} .col-6{grid-column:span 12} }
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:12px">
    <img src="logo.gif" alt="logo" width="36" style="border-radius:8px">
    <div class="brand">FLAWLESS GRAPHICS — HR Dashboard</div>
  </div>
  <div style="margin-left:auto" class="small">Advanced HR Console</div>
</header>

<div class="wrap">
  <div class="topbar">
    <div style="display:flex;gap:10px;align-items:center">
      <label class="small">Organization</label>
      <select id="orgSelect" class="btn"></select>

      <label class="small">View</label>
      <select id="viewMode" class="btn">
        <option value="overview">Overview</option>
        <option value="analytics">Analytics</option>
        <option value="payroll">Payroll</option>
        <option value="attendance">Attendance</option>
        <option value="messages">Messages</option>
      </select>

      <button class="btn" id="refreshBtn" title="Refresh data">Refresh</button>
    </div>

    <div class="controls">
      <button class="btn" id="exportPdfBtn">Export PDF</button>
      <button class="btn" id="exportDataBtn">Export JSON</button>
      <button class="btn" id="toggleThemeBtn">Dark / Light</button>
      <button class="btn primary" id="newEmployeeBtn">+ New Employee</button>
    </div>
  </div>

  <!-- draggable grid -->
  <div id="dashboardGrid" class="grid" style="align-items:start">
    <!-- KPIs -->
    <div id="widgetKpis" class="card col-3 widget" data-widget="kpis">
      <h3>Key Metrics</h3>
      <div class="kpi">
        <div class="small">Employees</div><div class="value" id="k_employees">0</div>
      </div>
      <div class="kpi">
        <div class="small">Departments</div><div class="value" id="k_departments">0</div>
      </div>
      <div class="kpi">
        <div class="small">Attendance Rate (30d)</div><div class="value" id="k_attendance">0%</div>
      </div>
      <div class="kpi">
        <div class="small">Projected Payroll (Monthly)</div><div class="value" id="k_payroll">GHS 0</div>
      </div>
    </div>

    <!-- Live Attendance -->
    <div id="widgetLive" class="card col-4 widget" data-widget="live">
      <h3>Live Attendance Board</h3>
      <div class="small">Recent clock-ins / outs (real-time)</div>
      <div id="liveList" class="scroll" style="margin-top:8px"></div>
      <div style="margin-top:8px">
        <button class="btn" id="clearLiveBtn">Clear</button>
      </div>
    </div>

    <!-- Attendance Chart -->
    <div id="widgetAttendanceChart" class="card col-5 widget" data-widget="attchart">
      <h3>Attendance Analytics</h3>
      <canvas id="attChart" height="160"></canvas>
    </div>

    <!-- Department Productivity -->
    <div id="widgetDeptProd" class="card col-6 widget" data-widget="deptprod">
      <h3>Department Productivity</h3>
      <canvas id="deptChart" height="160"></canvas>
    </div>

    <!-- Payroll Summary -->
    <div id="widgetPayroll" class="card col-6 widget" data-widget="payroll">
      <h3>Payroll Summary</h3>
      <div class="small">Total payroll, breakdown & quick payslip generator</div>
      <div style="margin-top:8px" id="payrollSummary"></div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <select id="payEmployee" class="btn"></select>
        <input id="payAmount" type="number" placeholder="Amount" style="padding:8px;border-radius:8px;border:1px solid #ddd" />
        <button class="btn primary" id="recordPaymentBtn">Record Payment</button>
        <button class="btn" id="downloadPayslipBtn">Payslip PDF</button>
      </div>
    </div>

    <!-- Messages / Announcements -->
    <div id="widgetMessages" class="card col-6 widget" data-widget="messages">
      <h3>Announcements & Messages</h3>
      <div style="display:flex;gap:8px">
        <input id="annTitle" placeholder="Announcement title" style="flex:1;padding:8px;border-radius:8px;border:1px solid #ddd">
        <button class="btn primary" id="postAnnBtn">Post</button>
      </div>
      <textarea id="annBody" placeholder="Write announcement..." style="width:100%;margin-top:8px;padding:8px;border-radius:8px;border:1px solid #ddd"></textarea>

      <div style="margin-top:10px">
        <strong>Inbox</strong>
        <div id="inboxList" class="scroll" style="margin-top:8px;max-height:160px"></div>
      </div>
    </div>

    <!-- Activity Log -->
    <div id="widgetLog" class="card col-12 widget" data-widget="log">
      <h3>Activity / Audit Log</h3>
      <div class="small">Track HR actions (edits, payroll, deletes)</div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn" id="downloadLogBtn">Export Log</button>
        <button class="btn" id="clearLogBtn">Clear Log</button>
      </div>
      <div id="logList" class="scroll" style="margin-top:8px;max-height:180px"></div>
    </div>

  </div> <!-- grid end -->

</div> <!-- wrap end -->

<!-- Toast -->
<div id="toast"></div>

<script>
/* ----------------------------
  Utilities & Keys
---------------------------- */
function safeParse(s){ try{return JSON.parse(s)}catch(e){return null} }
const DEFAULT_ORG = localStorage.getItem('active_org') || 'Flawless_Graphics';
let ACTIVE_ORG = localStorage.getItem('active_org') || DEFAULT_ORG;

function orgKey(s){ return `${ACTIVE_ORG}_${s}`; }

/* Keys used (per-org)
   employees -> employees
   attendance -> attendance
   payments -> payments
   announcements -> announcements
   messages -> messages (employee->hr)
   activity_log -> activity_log
*/
function read(k){ return safeParse(localStorage.getItem(orgKey(k))) || [] }
function save(k,v){ localStorage.setItem(orgKey(k), JSON.stringify(v)); }
function pushLog(action, meta = {}) {
  const log = read('activity_log');
  log.unshift({ ts: Date.now(), action, meta });
  save('activity_log', log);
  renderLog();
}

/* Toast helper */
function showToast(msg, t=2600){ const el=document.getElementById('toast'); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), t); }

/* init org list from stored orgs */
function getKnownOrgs(){ return safeParse(localStorage.getItem('org_list')) || [DEFAULT_ORG]; }
function saveKnownOrgs(arr){ localStorage.setItem('org_list', JSON.stringify(arr)); }

/* ----------------------------
  Theme & UI + Animated counters
---------------------------- */
const body = document.body;
const themeBtn = document.getElementById('toggleThemeBtn');
themeBtn.addEventListener('click', ()=> {
  body.classList.toggle('dark');
  localStorage.setItem('fg_dark_mode', body.classList.contains('dark') ? '1' : '0');
});
if(localStorage.getItem('fg_dark_mode') === '1') body.classList.add('dark');

/* Simple counter animation */
function animateCount(el, to, prefix='') {
  const from = Number(el.dataset.from || 0);
  const duration = 800;
  const start = performance.now();
  function frame(now){
    const p = Math.min(1, (now - start)/duration);
    const val = Math.round(from + (to - from) * p);
    el.textContent = prefix + val;
    if(p < 1) requestAnimationFrame(frame);
    else el.dataset.from = to;
  }
  requestAnimationFrame(frame);
}

/* ----------------------------
  Organization Switcher
---------------------------- */
const orgSelect = document.getElementById('orgSelect');
function populateOrgs(){
  const known = getKnownOrgs();
  orgSelect.innerHTML = '';
  known.forEach(o => {
    const opt = document.createElement('option'); opt.value = o; opt.textContent = o.replace(/_/g,' ');
    if(o === ACTIVE_ORG) opt.selected = true;
    orgSelect.appendChild(opt);
  });
  const addOpt = document.createElement('option'); addOpt.value = '__add__'; addOpt.textContent = '+ Add organization'; orgSelect.appendChild(addOpt);
}
orgSelect.addEventListener('change', ()=>{
  const v = orgSelect.value;
  if(v === '__add__'){
    const name = prompt('New organization name (short, no spaces)').trim().replace(/\s+/g,'_');
    if(!name) { populateOrgs(); return; }
    const known = getKnownOrgs(); if(!known.includes(name)) known.push(name); saveKnownOrgs(known);
    localStorage.setItem('active_org', name); ACTIVE_ORG = name;
    populateOrgs(); loadAll();
  } else {
    ACTIVE_ORG = v; localStorage.setItem('active_org', v); loadAll();
  }
});

/* ----------------------------
  Data loaders / renders
---------------------------- */

const k_employees = document.getElementById('k_employees');
const k_departments = document.getElementById('k_departments');
const k_attendance = document.getElementById('k_attendance');
const k_payroll = document.getElementById('k_payroll');

function computeKPIs(){
  const employees = read('employees');
  animateCount(k_employees, employees.length);
  const departments = [...new Set(employees.map(e=>e.department||'Unassigned'))].length;
  animateCount(k_departments, departments);
  // attendance rate last 30 days
  const attendance = read('attendance');
  const cutoff = Date.now() - 30*24*3600*1000;
  const last30 = attendance.filter(a => new Date(a.date).getTime() >= cutoff);
  const present = last30.filter(a => a.action === 'in').length;
  const total = Math.max(1, last30.length);
  const rate = Math.round((present / total) * 100);
  animateCount(k_attendance, rate, '');
  // payroll projected = sum of salaries
  const payroll = employees.reduce((s,e)=> s + Number(e.salary||0), 0);
  k_payroll.textContent = `GHS ${payroll.toLocaleString()}`;
  k_payroll.dataset.from = payroll;
}

/* render live attendance list */
const liveList = document.getElementById('liveList');
function renderLive(){
  const attendance = read('attendance').slice().reverse().slice(0,60);
  liveList.innerHTML = attendance.map(a => {
    const who = a.name || a.fullName || a.email || 'Unknown';
    const time = new Date(a.date).toLocaleString();
    return `<div style="padding:6px 0;border-bottom:1px dashed rgba(0,0,0,0.04)"><strong>${who}</strong> — ${a.action.toUpperCase()} <span class="small">(${time})</span></div>`;
  }).join('') || '<div class="small">No records</div>';
}

/* Attendance analytics chart */
let attChart = null;
function renderAttendanceChart(){
  const attendance = read('attendance');
  const last30days = Array.from({length:30}).map((_,i) => {
    const d = new Date(); d.setDate(d.getDate() - (29 - i));
    const key = d.toISOString().split('T')[0];
    const countIn = attendance.filter(a => a.action === 'in' && a.date.startsWith(key)).length;
    return { day: key, in: countIn };
  });
  const labels = last30days.map(r=>r.day.substr(5));
  const data = last30days.map(r=>r.in);
  const ctx = document.getElementById('attChart').getContext('2d');
  if(attChart) attChart.destroy();
  attChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label:'Clock-ins (30d)', data, borderColor:'#0b63a3', backgroundColor:'rgba(11,99,163,0.12)', fill:true }]},
    options: {responsive:true, plugins:{legend:{display:false}}}
  });
}

/* Department productivity chart */
let deptChart = null;
function renderDeptChart(){
  const employees = read('employees');
  const attendance = read('attendance');
  const depts = {};
  employees.forEach(e => {
    const d = e.department || 'Unassigned';
    depts[d] = depts[d] || { employees:0, clockins:0, payroll:0 };
    depts[d].employees++;
    depts[d].payroll += Number(e.salary||0);
    const hits = attendance.filter(a => (a.email || a.fullName) && ((a.email && a.email === e.email) || (a.fullName && a.fullName === e.fullName)) && a.action === 'in').length;
    depts[d].clockins += hits;
  });
  const labels = Object.keys(depts);
  const data = labels.map(l => depts[l].clockins);
  const ctx = document.getElementById('deptChart').getContext('2d');
  if(deptChart) deptChart.destroy();
  deptChart = new Chart(ctx, {
    type:'bar',
    data:{ labels, datasets:[{ label:'Clockins', data, backgroundColor: labels.map((_,i)=> `hsl(${i*60 % 360} 65% 55% / 0.9)` ) }]},
    options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
  });
}

/* Payroll summary render */
function renderPayrollSummary(){
  const employees = read('employees');
  const payments = read('payments');
  const totalPayroll = employees.reduce((s,e)=> s + Number(e.salary||0), 0);
  const paid = payments.reduce((s,p)=> s + Number(p.amount||0), 0);
  const due = totalPayroll - paid;
  document.getElementById('payrollSummary').innerHTML = `
    <div class="small">Total monthly payroll: <strong>GHS ${totalPayroll.toLocaleString()}</strong></div>
    <div class="small">Paid (this period): <strong>GHS ${paid.toLocaleString()}</strong></div>
    <div class="small">Outstanding: <strong>GHS ${due.toLocaleString()}</strong></div>
  `;
  // populate payEmployee select
  const sel = document.getElementById('payEmployee'); sel.innerHTML = '<option value="">-- select --</option>';
  read('employees').forEach((e,i) => {
    const opt = document.createElement('option'); opt.value = i; opt.textContent = `${e.fullName || e.email} — GHS ${Number(e.salary||0)}`;
    sel.appendChild(opt);
  });
}

/* render inbox */
function renderInbox(){
  const msgs = read('messages').slice().reverse();
  const out = document.getElementById('inboxList');
  out.innerHTML = msgs.map(m => `<div style="padding:8px;border-bottom:1px dashed rgba(0,0,0,0.04)"><strong>${m.subject||'Message'}</strong> • <span class="small">${new Date(m.date).toLocaleString()}</span><div class="small">${m.body}</div></div>`).join('') || '<div class="small">No messages</div>';
}

/* render log */
function renderLog(){
  const log = read('activity_log').slice(0,200);
  const out = document.getElementById('logList');
  out.innerHTML = log.map(l => `<div style="padding:6px;border-bottom:1px dashed rgba(0,0,0,0.05)"><strong>${l.action}</strong> <span class="small">• ${new Date(l.ts).toLocaleString()}</span><div class="small">${JSON.stringify(l.meta)}</div></div>`).join('') || '<div class="small">No actions yet</div>';
}

/* render everything */
function loadAll(){
  computeKPIs();
  renderLive();
  renderAttendanceChart();
  renderDeptChart();
  renderPayrollSummary();
  renderInbox();
  renderLog();
  populateEmployeeSelector();
}
window.addEventListener('storage', (e) => {
  // if other tabs create attendance or payments we respond
  if(e.key && (e.key.endsWith('_attendance') || e.key.endsWith('_employees') || e.key.endsWith('_payments') || e.key.endsWith('_messages'))) {
    // slight delay to allow consistent read
    setTimeout(()=> loadAll(), 60);
    // show notification when teacher clocks in/out
    if(e.key && e.key.includes('_attendance')) {
      const arr = safeParse(e.newValue) || [];
      const last = arr[arr.length - 1];
      if(last) showLiveNotification(last);
    }
  }
});

/* ----------------------------
  Actions (payments, announcements, messages)
---------------------------- */

/* New employee modal (simple prompt flow) */
document.getElementById('newEmployeeBtn').addEventListener('click', ()=>{
  const fullName = prompt('Full name'); if(!fullName) return;
  const email = prompt('Email') || '';
  const department = prompt('Department') || 'General';
  const position = prompt('Position') || '';
  const phone = prompt('Phone') || '';
  const salary = Number(prompt('Monthly salary (number)') || 0);
  const hireDate = prompt('Hire date (yyyy-mm-dd)') || new Date().toISOString().split('T')[0];
  const employees = read('employees');
  employees.push({ fullName, email, department, position, phone, salary, hireDate });
  save('employees', employees);
  pushLog('employee.add', { fullName, email, department });
  showToast('Employee added');
  loadAll();
});

/* Record payment */
document.getElementById('recordPaymentBtn').addEventListener('click', ()=>{
  const sel = document.getElementById('payEmployee');
  if(!sel.value) return alert('Select employee');
  const idx = Number(sel.value);
  const employees = read('employees');
  const emp = employees[idx];
  const amount = Number(document.getElementById('payAmount').value) || 0;
  if(amount <= 0) return alert('Enter amount');
  const payments = read('payments');
  payments.push({ date: new Date().toISOString(), name: emp.fullName, email: emp.email, amount, by: 'HR' });
  save('payments', payments);
  pushLog('payment.record', { name: emp.fullName, amount });
  showToast('Payment recorded');
  renderPayrollSummary();
});

/* download payslip for last payment of selected employee */
document.getElementById('downloadPayslipBtn').addEventListener('click', ()=>{
  const sel = document.getElementById('payEmployee');
  if(!sel.value) return alert('Select employee');
  const idx = Number(sel.value);
  const emp = read('employees')[idx];
  const payments = read('payments').filter(p => p.email === emp.email);
  if(!payments.length) return alert('No payments for employee');
  const p = payments[payments.length - 1];
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(14); doc.text('Flawless Graphics — Payslip', 20, 30);
  doc.setFontSize(12); doc.text(`Name: ${p.name}`, 20, 50); doc.text(`Email: ${p.email}`, 20, 60); doc.text(`Amount: GHS ${p.amount}`, 20, 70); doc.text(`Date: ${new Date(p.date).toLocaleString()}`, 20, 80);
  doc.save(`payslip_${p.name.replace(/\s+/g,'_')}.pdf`);
});

/* Post announcement */
document.getElementById('postAnnBtn').addEventListener('click', ()=>{
  const title = document.getElementById('annTitle').value.trim();
  const body = document.getElementById('annBody').value.trim();
  if(!title || !body) return alert('Complete announcement');
  const anns = read('announcements');
  anns.unshift({ title, body, ts: Date.now(), by: 'HR' });
  save('announcements', anns);
  pushLog('announcement.post', { title });
  showToast('Announcement posted');
  document.getElementById('annTitle').value=''; document.getElementById('annBody').value='';
});

/* ----------------------------
  Live notification when teacher clocks in/out
---------------------------- */
function showLiveNotification(record){
  // simple notification + push to inbox for HR
  showToast(`${record.name || record.fullName || record.email} ${record.action.toUpperCase()}`);
  // push into messages/notifications
  const notes = read('notifications');
  notes.unshift({ ts: Date.now(), type:'attendance', record });
  save('notifications', notes);
  // Also add to activity log
  pushLog('attendance.event', { name: record.name, action: record.action });
}

/* ----------------------------
  Simple anomaly detector & AI-like insights
---------------------------- */
function detectAnomalies(){
  const attendance = read('attendance');
  const employees = read('employees');
  const anomalies = [];

  // detect employees with many late/out patterns
  const byEmail = {};
  attendance.forEach(a => {
    const idKey = a.email || a.fullName || (a.name || 'unknown');
    byEmail[idKey] = byEmail[idKey] || { in:0, out:0, lastDates:[] };
    if(a.action === 'in') byEmail[idKey].in++;
    if(a.action === 'out') byEmail[idKey].out++;
    byEmail[idKey].lastDates.push(a.date);
  });

  Object.entries(byEmail).forEach(([k,v])=>{
    if(v.in > 0 && v.lastDates.length >= 8) {
      // heuristic: if >50% of last entries are after 10:30 (late) -> flag
      const lateCount = v.lastDates.filter(d => {
        try {
          const t = new Date(d).toLocaleTimeString();
          const hh = Number(t.split(':')[0]);
          const mm = Number(t.split(':')[1]);
          if(hh > 10) return true;
          if(hh === 10 && mm > 30) return true;
          return false;
        } catch(e){ return false }
      }).length;
      if(lateCount / v.lastDates.length > 0.5) anomalies.push({ who: k, reason: 'Frequent Lateness', score: Math.round((lateCount/v.lastDates.length)*100) });
    }
    // sudden drop in attendance
    if(v.in > 0 && v.in < 2) anomalies.push({ who: k, reason: 'Low activity', score: 60 });
  });

  // simple performance summary (highest clockins)
  const perf = Object.entries(byEmail).map(([k,v]) => ({ who:k, clockins:v.in }));
  perf.sort((a,b)=>b.clockins - a.clockins);
  const top = perf.slice(0,3);

  return { anomalies, top };
}

function renderAIInsights(){
  const { anomalies, top } = detectAnomalies();
  const el = document.createElement('div');
  el.innerHTML = `<h4>Smart Insights</h4>
    <div class="small"><strong>Top performers (by clock-ins):</strong> ${top.map(t=>`${t.who} (${t.clockins})`).join(', ') || 'N/A'}</div>
    <div style="margin-top:8px"><strong>Anomalies:</strong></div>
    <div class="small">${anomalies.length ? anomalies.map(a=>`${a.who}: ${a.reason} (${a.score}%)`).join('; ') : 'No anomalies detected'}</div>
  `;
  // inject into log widget top
  const logWidget = document.getElementById('widgetLog');
  if(logWidget) logWidget.insertBefore(el, logWidget.firstChild.nextSibling);
}

/* ----------------------------
  Exports
---------------------------- */
document.getElementById('exportDataBtn').addEventListener('click', ()=>{
  const data = {
    employees: read('employees'),
    attendance: read('attendance'),
    payments: read('payments'),
    announcements: read('announcements'),
    messages: read('messages'),
    activity_log: read('activity_log')
  };
  const blob = new Blob([JSON.stringify(data,null,2)], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${ACTIVE_ORG}_export.json`; a.click();
});

/* Export PDF (simple snapshot) */
document.getElementById('exportPdfBtn').addEventListener('click', async ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','pt','a4');
  doc.setFontSize(14); doc.text(`${ACTIVE_ORG} — HR Dashboard Snapshot`, 40, 40);
  doc.setFontSize(10); doc.text(`Employees: ${read('employees').length}`, 40, 70);
  doc.text(`Departments: ${[...new Set(read('employees').map(e=>e.department||''))].length}`, 40, 86);
  doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 102);
  doc.save(`${ACTIVE_ORG}_dashboard_snapshot.pdf`);
});

/* Download log */
document.getElementById('downloadLogBtn').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(read('activity_log'),null,2)], { type:'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${ACTIVE_ORG}_activity_log.json`; a.click();
});

/* Clear log */
document.getElementById('clearLogBtn').addEventListener('click', ()=>{
  if(!confirm('Clear activity log?')) return;
  save('activity_log', []); renderLog(); showToast('Activity log cleared');
});

/* Clear live */
document.getElementById('clearLiveBtn').addEventListener('click', ()=>{
  if(!confirm('Clear attendance records?')) return;
  save('attendance', []); renderLive(); showToast('Attendance cleared'); pushLog('attendance.clear');
});

/* download payments and payroll export */
document.getElementById('downloadPayslipBtn').addEventListener('click', ()=>{/* handled above */});

/* clear all convenience */
document.getElementById('refreshBtn').addEventListener('click', ()=> loadAll());

/* ----------------------------
  Employee selector populate
---------------------------- */
function populateEmployeeSelector(){
  const sel = document.getElementById('payEmployee');
  sel.innerHTML = '<option value="">-- select --</option>';
  read('employees').forEach((e,i)=> {
    const opt = document.createElement('option'); opt.value = i; opt.textContent = `${e.fullName || e.email} — ${e.department || 'General'}`;
    sel.appendChild(opt);
  });
}

/* ----------------------------
  Activity listener for UI actions
---------------------------- */
function recordAction(action, meta){
  pushLog(action, meta);
}

/* ----------------------------
  Drag & drop widgets (reorder)
---------------------------- */
(function makeDraggable(){
  const grid = document.getElementById('dashboardGrid');
  let dragged = null;
  grid.addEventListener('dragstart', (e)=> {
    dragged = e.target;
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
  });
  grid.addEventListener('dragend', (e)=> {
    if(dragged) dragged.classList.remove('dragging');
    dragged = null;
  });
  grid.addEventListener('dragover', (e)=> {
    e.preventDefault();
    const after = getDragAfterElement(grid, e.clientY);
    if(!dragged) return;
    if(after == null) grid.appendChild(dragged);
    else grid.insertBefore(dragged, after);
  });
  function getDragAfterElement(container, y){
    const draggableElements = [...container.querySelectorAll('.widget:not(.dragging)')];
    return draggableElements.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height/2;
      if(offset < 0 && offset > closest.offset) return { offset, element: child };
      else return closest;
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }
  // enable drag attribute
  document.querySelectorAll('.widget').forEach(w => w.setAttribute('draggable', 'true'));
})();

/* ----------------------------
  Init known orgs & first load
---------------------------- */
(function init(){
  const known = getKnownOrgs();
  if(!known.includes(ACTIVE_ORG)) {
    known.push(ACTIVE_ORG); saveKnownOrgs(known);
  }
  populateOrgs();
  // seed empty arrays if missing
  ['employees','attendance','payments','announcements','messages','activity_log','notifications'].forEach(k=> {
    if(!localStorage.getItem(orgKey(k))) localStorage.setItem(orgKey(k), JSON.stringify([]));
  });
  loadAll();
  renderAIInsights();
})();

/* ----------------------------
  Utility: showLiveNotification toasts on page load (if any new)
---------------------------- */
function showLiveNotificationIfAny(){
  const notes = read('notifications');
  if(notes && notes.length){
    const latest = notes[0];
    showToast(`Notification: ${latest.record && (latest.record.name || latest.record.fullName || latest.record.email)} ${latest.record.action}`);
  }
}
showLiveNotificationIfAny();

/* ----------------------------
  Extra: download activity/pinned actions
---------------------------- */
document.getElementById('clearLogBtn').addEventListener('click', ()=> {
  save('activity_log', []);
  renderLog();
});

/* ----------------------------
  Additional helpers: export & download
---------------------------- */
document.getElementById('exportPdfBtn').addEventListener('click', ()=> {
  showToast('Exporting PDF...');
});

/* ----------------------------
  Buttons for pay / messages were initialized above. Now load,
  and ensure pushLog called for key actions.
---------------------------- */

/* Hook into storage event for teacher attendance writes from teacher-profile: show notification */
window.addEventListener('storage', (e) => {
  // if attendance changed we will already re-run loadAll via previous listener
  if(!e.key) return;
  if(e.key.endsWith('_attendance') || e.key.endsWith('_attendance')) {
    const arr = safeParse(e.newValue) || [];
    const last = arr[arr.length - 1];
    if(last) showLiveNotification(last);
  }
});

/* Small helpers for buttons we didn't wire earlier */
document.getElementById('clearLogBtn').addEventListener('click', ()=> {
  if(confirm('Clear activity log?')) { save('activity_log', []); renderLog(); showToast('Log cleared') }
});

document.getElementById('downloadLogBtn').addEventListener('click', ()=> {
  const blob = new Blob([JSON.stringify(read('activity_log'), null, 2)], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${ACTIVE_ORG}_activity_log.json`; a.click();
});

/* initial render call (one more time) */
loadAll();
</script>
</body>
</html>
