<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HR Dashboard — Professional Edition (Upgraded)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root{
    --primary:#0057b8; --accent:#10b981; --danger:#ef4444;
    --bg:#f6f9fc; --card:#fff; --text:#1f2937; --muted:#6b7280; --radius:12px;
    --sidebar:#0c1427; --sidebar-hover:#162544; --glass:rgba(10,12,20,0.04);
  }
  .dark{ --bg:#0d1117; --card:#0f1724; --text:#e6eef8; --muted:#9aa9bf; --sidebar:#071026; --sidebar-hover:#153049; }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--text);height:100vh;display:flex;overflow:hidden}
  /* sidebar */
  .sidebar{width:260px;background:var(--sidebar);color:white;display:flex;flex-direction:column;padding:18px;gap:12px;transition:width .22s}
  .sidebar.collapsed{width:64px}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:44px;height:44;border-radius:10px;background:linear-gradient(90deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:700;color:#021}
  .org-name{font-weight:700}
  .profile-row{display:flex;gap:10px;align-items:center}
  .profile-thumb{width:44px;height:44;border-radius:10px;object-fit:cover;border:2px solid rgba(255,255,255,0.06)}
  .nav {display:flex;flex-direction:column;gap:6px;margin-top:8px}
  .nav button{background:transparent;border:0;color:#cbd5e1;text-align:left;padding:10px;border-radius:8px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:10px}
  .nav button.active{background:var(--sidebar-hover);color:white}
  .collapse-btn{margin-top:auto;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);cursor:pointer;color:#cbd5e1}

  /* main content */
  main{flex:1;overflow:auto;padding:18px}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
  .controls{display:flex;gap:8px;align-items:center}
  .select, input{padding:8px;border-radius:10px;border:1px solid var(--glass);background:var(--card);color:inherit}
  .btn{padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700;background:var(--primary);color:white}
  .btn.ghost{background:transparent;border:1px solid var(--glass);color:var(--text)}
  .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:14px}
  .kpi{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.04)}
  .kpi h4{margin:0;color:var(--muted);font-weight:600}
  .kpi .val{font-size:20px;font-weight:800;margin-top:6px}

  .panel{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 10px 26px rgba(2,6,23,0.04);margin-bottom:12px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid var(--glass);text-align:left}
  .actions button{margin-right:6px}

  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center}
  .modal-backdrop.show{display:flex}
  .modal{width:720px;max-width:95%;background:var(--card);padding:16px;border-radius:12px}
  .form-grid{display:grid;grid-template-columns:1fr 320px;gap:12px}
  @media(max-width:900px){ .form-grid{grid-template-columns:1fr} .sidebar{display:none} }

  /* toast */
  .toast{position:fixed;right:18px;bottom:18px;background:#0b1220;color:white;padding:12px 14px;border-radius:10px;opacity:0;transform:translateY(16px);transition:.3s}
  .toast.show{opacity:1;transform:none}

  .small{font-size:13px;color:var(--muted)}
  .badge{background:var(--primary);color:white;padding:6px 8px;border-radius:999px;font-weight:700}

  /* profile flyout */
  .flyout{position:fixed;right:18px;top:80px;width:420px;background:var(--card);padding:12px;border-radius:12px;box-shadow:0 18px 48px rgba(2,6,23,0.2);display:none;z-index:50}
  .flyout.show{display:block}
  .toggle-theme {padding:8px;border-radius:8px;border:1px solid var(--glass);cursor:pointer;background:transparent}

  /* settings panel color picks */
  .color-swatch{width:28px;height:28;border-radius:6px;display:inline-block;margin-right:8px;cursor:pointer;border:1px solid rgba(0,0,0,0.06)}
  .collapsed-tip{font-size:12px;color:#e6eef8;opacity:.85;margin-left:6px}
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="brand">
    <div class="logo" id="brandLogo">HR</div>
    <div>
      <div class="org-name" id="sideOrg">Loading...</div>
      <div class="small" id="sideRole">Role</div>
    </div>
  </div>

  <div class="profile-row">
    <img id="sidePhoto" class="profile-thumb" src="" alt="photo">
    <div>
      <div id="sideName">—</div>
      <div class="small" id="sideEmail">—</div>
    </div>
  </div>

  <nav class="nav" id="nav">
    <button data-section="dashboard" class="active"><i class="fa fa-home"></i> Dashboard</button>
    <button data-section="employees"><i class="fa fa-users"></i> Employees</button>
    <button data-section="attendance"><i class="fa fa-calendar-check"></i> Attendance</button>
    <button data-section="payroll"><i class="fa fa-sack-dollar"></i> Payroll</button>
    <button data-section="analytics"><i class="fa fa-chart-line"></i> Analytics</button>
    <button data-section="announcements"><i class="fa fa-bullhorn"></i> Announcements</button>
    <button data-section="messages"><i class="fa fa-envelope"></i> Messages</button>
    <button data-section="settings"><i class="fa fa-cog"></i> Settings</button>
  </nav>

  <button class="collapse-btn" id="collapseBtn"><i class="fa fa-angle-left"></i> Collapse</button>
</aside>

<!-- MAIN -->
<main>
  <div class="topbar">
    <div>
      <h2 id="pageTitle">Dashboard</h2>
      <div class="small">Professional HR panel — Local demo</div>
    </div>

    <div class="controls">
      <select id="orgSwitcher" class="select"></select>
      <select id="roleSwitcher" class="select small">
        <option value="hr">HR Admin</option>
        <option value="accountant">Accountant</option>
        <option value="manager">Manager</option>
        <option value="teacher">Teacher (read)</option>
      </select>
      <button class="btn ghost" id="themeToggle"><i class="fa fa-moon"></i></button>
      <button class="btn" id="addEmployeeBtn"><i class="fa fa-plus"></i> Add Employee</button>
      <button class="btn" id="exportAllBtn"><i class="fa fa-download"></i> Export</button>
    </div>
  </div>

  <!-- KPI GRID -->
  <div class="kpi-grid">
    <div class="kpi">
      <h4>Total Employees</h4>
      <div class="val" id="totalEmployees">0</div>
    </div>
    <div class="kpi">
      <h4>Present Today</h4>
      <div class="val" id="presentToday">0</div>
    </div>
    <div class="kpi">
      <h4>Absent Today</h4>
      <div class="val" id="absentToday">0</div>
    </div>
    <div class="kpi">
      <h4>Monthly Payroll</h4>
      <div class="val" id="payrollTotal">₵0</div>
    </div>
  </div>

  <!-- CONTENT SECTIONS -->
  <section class="panel" id="dashboardSection">
    <h3>Recent Activity</h3>
    <div id="activityFeed" class="small" style="margin-top:8px"></div>
  </section>

  <section class="panel" id="employeesSection" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="display:flex;gap:8px;align-items:center">
        <input id="searchEmployee" class="select" placeholder="Search name, email, role" style="min-width:260px"/>
        <select id="filterRole" class="select"><option value="">All roles</option></select>
        <select id="filterDept" class="select"><option value="">All departments</option></select>
      </div>
      <div class="small">Double-click row to edit</div>
    </div>

    <div style="margin-top:12px" class="panel">
      <table>
        <thead><tr><th>Name</th><th>Role</th><th>Department</th><th>Email</th><th>Salary</th><th>Attendance</th><th>Actions</th></tr></thead>
        <tbody id="employeeTable"></tbody>
      </table>
    </div>
  </section>

  <section class="panel" id="attendanceSectionPanel" style="display:none">
    <h3>Attendance Manager</h3>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <select id="attClassSelect" class="select"></select>
      <input type="date" id="attDate" class="select"/>
      <button class="btn" id="openMarkBtn">Open Mark</button>
      <button class="btn ghost" id="syncTeachersBtn">Sync Teacher Clock-ins</button>
    </div>
    <div id="attendanceArea"></div>
  </section>

  <section class="panel" id="payrollSection" style="display:none">
    <h3>Payroll Calculator</h3>
    <div style="display:flex;gap:12px">
      <div style="flex:1">
        <select id="payEmployeeSelect" class="select"></select>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="bonus" class="select" placeholder="Bonuses (₵)"/>
          <input id="deductions" class="select" placeholder="Deductions (₵)"/>
        </div>
        <div style="margin-top:8px">
          <button class="btn" id="calcPayrollBtn">Calculate Net Pay</button>
          <button class="btn ghost" id="exportPayrollBtn">Export Payroll CSV</button>
        </div>
      </div>
      <div style="width:320px;background:rgba(0,0,0,0.02);padding:12px;border-radius:8px">
        <h4>Net Pay</h4>
        <div id="payResult" class="small">Select employee & compute</div>
      </div>
    </div>
  </section>

  <section class="panel" id="analyticsSection" style="display:none">
    <h3>Attendance Analytics</h3>
    <canvas id="attChart" height="120"></canvas>
  </section>

  <section class="panel" id="announcementsSection" style="display:none">
    <h3>Announcements</h3>
    <div style="display:flex;gap:8px">
      <input id="announcementInput" class="select" placeholder="Write announcement...">
      <button class="btn" id="postAnnouncement">Post</button>
    </div>
    <div id="announcementList" style="margin-top:12px"></div>
  </section>

  <section class="panel" id="messagesSectionPanel" style="display:none">
    <h3>Messages</h3>
    <div style="display:flex;gap:8px">
      <input id="msgTo" class="select" placeholder="To (email or group)">
      <input id="msgSubject" class="select" placeholder="Subject">
    </div>
    <textarea id="msgBody" rows="4" style="width:100%;margin-top:8px;padding:8px;border-radius:8px;border:1px solid var(--glass)"></textarea>
    <div style="margin-top:8px">
      <button class="btn" id="sendMsgBtn">Send</button>
    </div>
    <div id="msgList" style="margin-top:12px"></div>
  </section>

  <section class="panel" id="settingsSectionPanel" style="display:none">
    <h3>Settings & Theme</h3>
    <div style="display:flex;gap:12px">
      <div style="flex:1">
        <div class="small">Accent color</div>
        <div style="margin-top:8px">
          <span class="color-swatch" data-color="#0057b8" style="background:#0057b8"></span>
          <span class="color-swatch" data-color="#d97706" style="background:#d97706"></span>
          <span class="color-swatch" data-color="#10b981" style="background:#10b981"></span>
          <span class="color-swatch" data-color="#7c3aed" style="background:#7c3aed"></span>
        </div>
        <div style="margin-top:14px">
          <label class="small">Auto logout (min)</label>
          <input id="idleMinutes" class="select" type="number" min="1" value="10" style="width:100px">
        </div>
        <div style="margin-top:12px">
          <button class="btn" id="saveSettingsBtn">Save Settings</button>
        </div>
      </div>
      <div style="width:260px">
        <h4>AI Assistant</h4>
        <div id="aiPanel" style="background:rgba(0,0,0,0.03);padding:10px;border-radius:8px">
          <input id="aiQuery" class="select" placeholder="Ask HR assistant (e.g., 'who's absent today?')">
          <div style="margin-top:8px">
            <button class="btn ghost" id="askAiBtn">Ask</button>
          </div>
          <div id="aiAnswer" style="margin-top:8px" class="small"></div>
        </div>
      </div>
    </div>
  </section>

</main>

<!-- MODAL: Add/Edit Employee -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="modalTitle">Add Employee</h3>
    <div class="form-grid">
      <div>
        <label class="small">Full name</label>
        <input id="emp_name" class="select" />
        <label class="small">Role</label>
        <input id="emp_role" class="select" />
        <label class="small">Department</label>
        <input id="emp_dept" class="select" />
        <label class="small">Email</label>
        <input id="emp_email" class="select" />
        <label class="small">Salary (monthly ₵)</label>
        <input id="emp_salary" type="number" class="select" />
        <div style="margin-top:8px">
          <button class="btn" id="saveEmpBtn">Save</button>
          <button class="btn ghost" id="cancelEmpBtn">Cancel</button>
        </div>
      </div>
      <div>
        <label class="small">Photo</label>
        <img id="emp_preview" class="profile-thumb" src="" alt="preview" style="width:160px;height:160px">
        <input id="emp_photo" type="file" accept="image/*" style="margin-top:8px">
        <div class="small" style="margin-top:8px">Tip: Profile photo stored in localStorage (base64)</div>
      </div>
    </div>
  </div>
</div>

<!-- Profile flyout -->
<div class="flyout" id="profileFlyout"></div>

<div class="toast" id="toast"></div>

<script>
/* ----------------------------
  Utilities & Namespaced Keys
-----------------------------*/
function safeParse(s){ try{return JSON.parse(s)}catch(e){return null} }
function read(k){ return safeParse(localStorage.getItem(k)) || [] }
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)) }
function now(){ return Date.now() }
function showToast(msg,ms=2500){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=> t.classList.remove('show'), ms) }

/* --- Organizations --- */
const ORG_LIST_KEY = 'orgs_list_v2';
const DEFAULT_ORGS = ['FLAWLESS','FLAWLESS_JHS','FLAWLESS_SHS'];
let orgs = read(ORG_LIST_KEY);
if(!orgs || !orgs.length){ save(ORG_LIST_KEY, DEFAULT_ORGS); orgs = DEFAULT_ORGS }
const orgSwitcher = document.getElementById('orgSwitcher');
const ACTIVE_ORG = localStorage.getItem('active_org') || orgs[0];
function populateOrgSwitcher(){
  orgSwitcher.innerHTML=''; orgs.forEach(o=>{ const opt=document.createElement('option'); opt.value=o; opt.textContent=o; if(o===ACTIVE_ORG) opt.selected=true; orgSwitcher.appendChild(opt) })
}
populateOrgSwitcher();
orgSwitcher.addEventListener('change',()=>{ localStorage.setItem('active_org', orgSwitcher.value); location.reload() })

/* --- keys per org --- */
function key(k){ const A = localStorage.getItem('active_org') || ACTIVE_ORG; return `${A}_${k}` }
const EMP_KEY = key('employees'); const ATT_KEY = key('attendance'); const PAY_KEY = key('payments');
const ANN_KEY = key('announcements'); const ACT_KEY = key('activity'); const DEPT_KEY = key('departments');
const TEACH_ATT_KEY = key('teacher_attendance'); // teacher page can push here
if(!localStorage.getItem(EMP_KEY)) save(EMP_KEY, []);
if(!localStorage.getItem(ATT_KEY)) save(ATT_KEY, []);
if(!localStorage.getItem(PAY_KEY)) save(PAY_KEY, []);
if(!localStorage.getItem(ANN_KEY)) save(ANN_KEY, []);
if(!localStorage.getItem(ACT_KEY)) save(ACT_KEY, []);
if(!localStorage.getItem(DEPT_KEY)) save(DEPT_KEY, ['HR','Finance','Admin','Teaching']);

/* --- Current user (role simulation) --- */
let currentUser = safeParse(localStorage.getItem('hr_current_user')) || { name:'Admin', email:'hr@org.local', role:'hr' };
document.getElementById('roleSwitcher').value = currentUser.role;
document.getElementById('sideName').textContent = currentUser.name;
document.getElementById('sideEmail').textContent = currentUser.email;
document.getElementById('sideRole').textContent = currentUser.role.toUpperCase();
document.getElementById('sideOrg').textContent = localStorage.getItem('active_org') || ACTIVE_ORG;

/* role switcher sets currentUser.role (simulated) */
document.getElementById('roleSwitcher').addEventListener('change', (e)=>{
  currentUser.role = e.target.value;
  localStorage.setItem('hr_current_user', JSON.stringify(currentUser));
  document.getElementById('sideRole').textContent = currentUser.role.toUpperCase();
  showToast('Role switched to ' + currentUser.role);
});

/* ------------------------
  UI helpers & rendering
-------------------------*/
const sections = {
  dashboard: document.getElementById('dashboardSection'),
  employees: document.getElementById('employeesSection'),
  attendance: document.getElementById('attendanceSectionPanel'),
  payroll: document.getElementById('payrollSection'),
  analytics: document.getElementById('analyticsSection'),
  announcements: document.getElementById('announcementsSection'),
  messages: document.getElementById('messagesSectionPanel'),
  settings: document.getElementById('settingsSectionPanel')
};
function showSection(name){
  document.querySelectorAll('main section.panel').forEach(s=> s.style.display='none');
  sections[name].style.display = 'block';
  document.querySelectorAll('#nav button').forEach(b=> b.classList.remove('active'));
  document.querySelector('#nav button[data-section="'+name+'"]').classList.add('active');
  document.getElementById('pageTitle').textContent = document.querySelector('#nav button[data-section="'+name+'"]').textContent.trim();
}
document.querySelectorAll('#nav button').forEach(b=> b.addEventListener('click', ()=> showSection(b.dataset.section)));
showSection('dashboard');

/* collapse sidebar */
const sidebar = document.getElementById('sidebar'), collapseBtn = document.getElementById('collapseBtn');
let collapsed = false;
collapseBtn.addEventListener('click', ()=>{ collapsed=!collapsed; sidebar.classList.toggle('collapsed', collapsed); collapseBtn.innerHTML = collapsed? '<i class="fa fa-angle-right"></i> Expand':'<i class="fa fa-angle-left"></i> Collapse'; });

/* modal controls */
const modalBackdrop = document.getElementById('modalBackdrop');
document.getElementById('addEmployeeBtn').addEventListener('click', ()=> openEmpModal());
document.getElementById('cancelEmpBtn').addEventListener('click', ()=> closeEmpModal());

function openEmpModal(emp){
  modalBackdrop.classList.add('show');
  document.getElementById('modalTitle').textContent = emp ? 'Edit Employee' : 'Add Employee';
  if(emp){
    document.getElementById('emp_name').value = emp.name || '';
    document.getElementById('emp_role').value = emp.role || '';
    document.getElementById('emp_dept').value = emp.dept || '';
    document.getElementById('emp_email').value = emp.email || '';
    document.getElementById('emp_salary').value = emp.salary || 0;
    document.getElementById('emp_preview').src = emp.photo||'';
    document.getElementById('saveEmpBtn').dataset.editId = emp.id;
  } else {
    document.getElementById('emp_name').value=''; document.getElementById('emp_role').value=''; document.getElementById('emp_dept').value='';
    document.getElementById('emp_email').value=''; document.getElementById('emp_salary').value='0'; document.getElementById('emp_preview').src='';
    delete document.getElementById('saveEmpBtn').dataset.editId;
  }
}
function closeEmpModal(){ modalBackdrop.classList.remove('show'); }

/* photo preview */
document.getElementById('emp_photo').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader(); r.onload = ()=> document.getElementById('emp_preview').src = r.result; r.readAsDataURL(f);
});

/* save employee */
document.getElementById('saveEmpBtn').addEventListener('click', ()=>{
  const name = document.getElementById('emp_name').value.trim();
  if(!name) return alert('Name required');
  const role = document.getElementById('emp_role').value.trim() || 'Staff';
  const dept = document.getElementById('emp_dept').value.trim() || 'General';
  const email = document.getElementById('emp_email').value.trim();
  const salary = Number(document.getElementById('emp_salary').value) || 0;
  const photo = document.getElementById('emp_preview').src || '';
  const employees = read(EMP_KEY);
  const editId = document.getElementById('saveEmpBtn').dataset.editId;
  if(editId){
    const idx = employees.findIndex(e=> e.id === editId);
    if(idx>=0){ employees[idx] = {...employees[idx], name, role, dept, email, salary, photo}; save(EMP_KEY, employees); pushActivity(`Updated ${name}`); showToast('Employee updated'); }
  } else {
    const id = 'e_'+Date.now();
    employees.push({ id, name, role, dept, email, salary, photo });
    save(EMP_KEY, employees);
    pushActivity(`Added ${name}`);
    showToast('Employee added');
  }
  closeEmpModal(); renderAll();
});

/* seed demo if empty */
(function seed(){
  const emps = read(EMP_KEY);
  if(emps.length===0){
    const demo = [
      { id:'e_1', name:'Adjei James', role:'Manager', dept:'Admin', email:'james@example.com', salary:3500, photo:'' },
      { id:'e_2', name:'Emmanuel Ofori', role:'Analyst', dept:'Finance', email:'emmanuel@example.com', salary:2500, photo:'' },
      { id:'e_3', name:'Ama Serwaa', role:'Teacher', dept:'Teaching', email:'ama@example.com', salary:2200, photo:'' }
    ]; save(EMP_KEY, demo); pushActivity('Seeded demo employees'); renderAll();
  }
})();

/* activity */
function pushActivity(text){ const arr = read(ACT_KEY); arr.push({ text, time:new Date().toISOString() }); save(ACT_KEY, arr); renderActivity(); }

/* render activity and announcements */
function renderActivity(){ const arr = read(ACT_KEY).slice().reverse(); const el = document.getElementById('activityFeed'); el.innerHTML = arr.slice(0,12).map(a=> `<div class="small">${new Date(a.time).toLocaleString()} • ${a.text}</div>`).join(''); }
function renderAnnouncements(){ const list = read(ANN_KEY).slice().reverse(); const el = document.getElementById('announcementList'); el.innerHTML = list.map(a=> `<div style="padding:8px;border-bottom:1px solid var(--glass)"><strong>${a.title}</strong> <div class="small">${new Date(a.time).toLocaleString()}</div><div>${a.body}</div></div>`).join(''); }

/* employee table/render */
const employeeTable = document.getElementById('employeeTable');
function renderEmployees(filterText=''){
  const arr = read(EMP_KEY);
  const roleFilter = document.getElementById('filterRole').value;
  const deptFilter = document.getElementById('filterDept').value;
  const search = filterText.toLowerCase();
  employeeTable.innerHTML = '';
  arr.filter(e=>{
    if(roleFilter && e.role !== roleFilter) return false;
    if(deptFilter && e.dept !== deptFilter) return false;
    if(search){
      const t = (e.name + ' ' + e.email + ' ' + e.role + ' ' + e.dept).toLowerCase();
      return t.includes(search);
    }
    return true;
  }).forEach((e,i)=>{
    // attendance today quick lookup
    const today = new Date().toISOString().split('T')[0];
    const todays = read(ATT_KEY).filter(a=> a.employeeId === e.id && a.date.startsWith(today));
    const last = todays[todays.length-1];
    const att = last? (last.action==='in'?'IN':'OUT') : '—';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${e.name}</td><td>${e.role}</td><td>${e.dept||''}</td><td>${e.email||''}</td><td>₵ ${Number(e.salary||0).toLocaleString()}</td><td>${att}</td>
      <td class="actions"><button class="btn ghost" data-id="${e.id}" onclick="openEdit('${e.id}', event)">Edit</button><button class="btn" onclick="openProfile('${e.id}')">Profile</button></td>`;
    tr.addEventListener('dblclick', ()=> openEdit(e.id));
    employeeTable.appendChild(tr);
  });
  updateFilters(); populatePayrollSelect();
}

/* populate role & dept filters */
function updateFilters(){
  const roles = new Set(read(EMP_KEY).map(e=> e.role || 'Staff'));
  const deps = read(DEPT_KEY);
  const roleSel = document.getElementById('filterRole'); roleSel.innerHTML = '<option value="">All roles</option>';
  roles.forEach(r=> roleSel.appendChild(Object.assign(document.createElement('option'), { value:r, textContent:r })));
  const deptSel = document.getElementById('filterDept'); deptSel.innerHTML = '<option value="">All departments</option>';
  deps.forEach(d=> deptSel.appendChild(Object.assign(document.createElement('option'), { value:d, textContent:d })));
}
document.getElementById('filterRole').addEventListener('change', ()=> renderEmployees(document.getElementById('searchEmployee').value));
document.getElementById('filterDept').addEventListener('change', ()=> renderEmployees(document.getElementById('searchEmployee').value));
document.getElementById('searchEmployee').addEventListener('input', (e)=> renderEmployees(e.target.value));

/* edit employee open */
function openEdit(id, ev){
  const emp = read(EMP_KEY).find(x=>x.id===id);
  if(!emp) return;
  openEmpModal(emp);
}

/* profile flyout */
const flyout = document.getElementById('profileFlyout');
function openProfile(id){
  const emp = read(EMP_KEY).find(x=> x.id === id);
  if(!emp) return;
  const html = `<div style="display:flex;gap:12px;align-items:center">
    <img src="${emp.photo||''}" style="width:84px;height:84px;border-radius:12px;object-fit:cover">
    <div><strong>${emp.name}</strong><div class="small">${emp.role} • ${emp.dept||''}</div><div class="small">${emp.email||''}</div></div>
  </div>
  <hr>
  <div class="small"><strong>Attendance (recent)</strong></div>
  <div class="small" id="pf_att">${renderProfileAttendanceHtml(emp.id)}</div>
  <hr>
  <div class="small"><strong>Payroll</strong></div>
  <div class="small">Salary: ₵ ${Number(emp.salary||0).toLocaleString()}</div>
  <div style="margin-top:8px"><button class="btn" onclick="preparePayroll('${emp.id}')">Compute Payroll</button> <button class="btn ghost" onclick="closeFlyout()">Close</button></div>`;
  flyout.innerHTML = html; flyout.classList.add('show');
}
function closeFlyout(){ flyout.classList.remove('show') }
function renderProfileAttendanceHtml(empId){
  const arr = read(ATT_KEY).filter(a=> a.employeeId === empId).slice().reverse().slice(0,8);
  if(!arr.length) return 'No records';
  return arr.map(a=> `${new Date(a.date).toLocaleString()} • ${a.action.toUpperCase()}`).join('<br>');
}

/* -----------------------------------
  Attendance: marking & teacher sync
------------------------------------*/
document.getElementById('openMarkBtn').addEventListener('click', renderAttendanceMarkArea);
function renderAttendanceMarkArea(){
  const classes = read(DEPT_KEY);
  const classSel = document.getElementById('attClassSelect');
  classSel.innerHTML = '<option value="">-- select dept --</option>';
  classes.forEach(c=> classSel.appendChild(Object.assign(document.createElement('option'), { value:c, textContent:c })));
  // render area
  const area = document.getElementById('attendanceArea'); area.innerHTML='';
  const dept = classSel.value || classes[0];
  const employees = read(EMP_KEY).filter(e=> (e.dept||'') === (dept||''));
  if(!employees.length) { area.innerHTML = '<div class="small">No employees in this department</div>'; return; }
  const table = document.createElement('table');
  table.innerHTML = `<thead><tr><th>#</th><th>Name</th><th>Action</th></tr></thead>`;
  const tbody = document.createElement('tbody');
  employees.forEach((e,i)=> {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${e.name}</td><td><button class="btn" onclick="markAttendance('${e.id}','in')">IN</button>
      <button class="btn ghost" onclick="markAttendance('${e.id}','out')">OUT</button></td>`;
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  area.appendChild(table);
}
function markAttendance(employeeId, action){
  const arr = read(ATT_KEY);
  arr.push({ employeeId, action, date: new Date().toISOString() });
  save(ATT_KEY, arr);
  pushActivity(`Attendance ${action.toUpperCase()} — ${employeeId}`);
  showToast('Attendance recorded');
  renderAll();
}

/* teacher clock-in sync helper: will import records from teacher pages */
document.getElementById('syncTeachersBtn').addEventListener('click', ()=> {
  const tarr = read(TEACH_ATT_KEY);
  if(!tarr.length) return showToast('No teacher attendance to sync');
  // tarr: array of { email, log:[{in, out}] } - map email to employeeId
  const employees = read(EMP_KEY);
  let count = 0;
  tarr.forEach(trec=>{
    const emp = employees.find(e=> (e.email||'').toLowerCase() === (trec.email||'').toLowerCase());
    if(emp){
      trec.log.forEach(l=>{
        if(l.in) {
          read(ATT_KEY).push({ employeeId: emp.id, action:'in', date: l.in });
          count++;
        }
        if(l.out){
          read(ATT_KEY).push({ employeeId: emp.id, action:'out', date: l.out });
          count++;
        }
      });
    }
  });
  // naive save: reconstruct ATT_KEY from read() mutated earlier via read(ATT_KEY) usage? safe approach: push to arr var
  const attArr = read(ATT_KEY);
  save(ATT_KEY, attArr);
  pushActivity(`Imported ${count} teacher clock-in/out records`);
  showToast(`Synced ${count} records`);
  renderAll();
});

/* ---------------------------
  Payroll calculator & export
----------------------------*/
function populatePayrollSelect(){
  const sel = document.getElementById('payEmployeeSelect'); sel.innerHTML = '<option value="">-- select employee --</option>';
  read(EMP_KEY).forEach(e=> sel.appendChild(Object.assign(document.createElement('option'), { value:e.id, textContent: e.name })));
}
document.getElementById('calcPayrollBtn').addEventListener('click', ()=> {
  const id = document.getElementById('payEmployeeSelect').value; if(!id) return alert('Select employee');
  const bonus = Number(document.getElementById('bonus').value) || 0;
  const deductions = Number(document.getElementById('deductions').value) || 0;
  const emp = read(EMP_KEY).find(x=>x.id===id);
  const gross = Number(emp.salary || 0) + bonus;
  const tax = Math.round(gross * 0.12); // simple 12% tax
  const net = gross - tax - deductions;
  document.getElementById('payResult').innerHTML = `<div>Gross: ₵${gross.toLocaleString()}</div><div>Tax (12%): ₵${tax.toLocaleString()}</div><div>Deductions: ₵${deductions.toLocaleString()}</div><div style="margin-top:6px;font-weight:800">Net: ₵${net.toLocaleString()}</div>`;
  // save payment record
  const pays = read(PAY_KEY); pays.push({ id:'p_'+Date.now(), employeeId:id, gross, tax, deductions, net, date:new Date().toISOString() }); save(PAY_KEY, pays);
  pushActivity(`Payroll computed for ${emp.name}`);
  showToast('Payroll computed');
});
document.getElementById('exportPayrollBtn').addEventListener('click', ()=> {
  const rows = read(PAY_KEY).map(p=> ({ id:p.id, employeeId:p.employeeId, net:p.net, date:p.date }));
  const csv = toCsv(rows);
  downloadText(csv, `${(localStorage.getItem('active_org')||'org')}_payroll.csv`, 'text/csv');
});

/* -------------------------
  Assign charts & analytics
--------------------------*/
let attChart = null;
function drawAttendanceChart(){
  const attendance = read(ATT_KEY);
  const days = [];
  const labels = [];
  for(let i=6;i>=0;i--){ const d=new Date(); d.setDate(d.getDate()-i); const key = d.toISOString().split('T')[0]; days.push(key); labels.push(d.toLocaleDateString(undefined,{month:'short',day:'numeric'})) }
  const present = days.map(day => { return new Set(attendance.filter(a=> a.date.startsWith(day) && a.action==='in').map(a=> a.employeeId)).size })
  const ctx = document.getElementById('attChart').getContext('2d');
  if(attChart) attChart.destroy();
  attChart = new Chart(ctx, { type:'bar', data:{ labels: labels, datasets:[{ label:'Present', data:present, backgroundColor:getComputedStyle(document.documentElement).getPropertyValue('--primary')||'#3b82f6' }] }, options:{plugins:{legend:{display:false}}} })
}

/* -------------------------
  Messaging & announcements
--------------------------*/
document.getElementById('postAnnouncement').addEventListener('click', ()=>{
  const text = document.getElementById('announcementInput').value.trim(); if(!text) return showToast('Enter announcement');
  const arr = read(ANN_KEY); arr.push({ title:text.split('\n')[0], body:text, time:new Date().toISOString() }); save(ANN_KEY, arr); pushActivity('Posted announcement'); renderAnnouncements(); document.getElementById('announcementInput').value=''; showToast('Posted');
});
document.getElementById('sendMsgBtn').addEventListener('click', ()=> {
  const to = document.getElementById('msgTo').value.trim(); const subj = document.getElementById('msgSubject').value.trim(); const body = document.getElementById('msgBody').value.trim();
  if(!subj || !body) return alert('complete message');
  const messages = read(key('messages')); messages.push({ id:'m_'+Date.now(), from: currentUser.email, to, subj, body, date:new Date().toISOString(), read:false }); save(key('messages'), messages);
  pushActivity(`Message sent: ${subj}`);
  showToast('Message queued');
  document.getElementById('msgTo').value=''; document.getElementById('msgSubject').value=''; document.getElementById('msgBody').value='';
  renderMessages();
});
function renderMessages(){ const arr = read(key('messages')).slice().reverse(); const el = document.getElementById('msgList'); el.innerHTML = arr.map(m=> `<div style="padding:8px;border-bottom:1px solid var(--glass)"><strong>${m.subj}</strong><div class="small">${m.date} • ${m.from} → ${m.to}</div><div>${m.body}</div></div>`).join('') }
renderMessages();

/* -------------------------
  Exports & helpers
--------------------------*/
function toCsv(rows){ if(!rows.length) return ''; const keys = Object.keys(rows[0]); const lines=[keys.join(',')]; rows.forEach(r=> lines.push(keys.map(k=>`"${String(r[k]||'').replace(/"/g,'""')}"`).join(','))); return lines.join('\n') }
function downloadText(text, filename, type='text/plain'){ const blob = new Blob([text], { type }); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download = filename; document.body.appendChild(a); a.click(); a.remove(); }
document.getElementById('exportAllBtn').addEventListener('click', ()=> {
  const data = { employees: read(EMP_KEY), attendance: read(ATT_KEY), payments: read(PAY_KEY), announcements: read(ANN_KEY) };
  downloadText(JSON.stringify(data,null,2), `${localStorage.getItem('active_org')||'org'}_export.json`, 'application/json');
  showToast('Exported JSON');
});

/* export all to PDF */
document.getElementById('roleSwitcher'); // just exists

/* -------------------------
  Settings & Theme
--------------------------*/
document.getElementById('themeToggle').addEventListener('click', ()=> {
  document.documentElement.classList.toggle('dark');
  showToast('Theme toggled');
});
document.querySelectorAll('.color-swatch').forEach(s=> s.addEventListener('click', (e)=>{
  const c = e.currentTarget.dataset.color; document.documentElement.style.setProperty('--primary', c); showToast('Accent updated');
}));
document.getElementById('saveSettingsBtn').addEventListener('click', ()=> {
  const mins = Number(document.getElementById('idleMinutes').value) || 10; localStorage.setItem('idle_minutes', String(mins)); showToast('Settings saved');
});

/* -------------------------
  AI Assistant (local)
--------------------------*/
document.getElementById('askAiBtn').addEventListener('click', ()=>{
  const q = document.getElementById('aiQuery').value.toLowerCase();
  if(!q) return;
  const employees = read(EMP_KEY);
  if(q.includes('absent')) {
    const today = new Date().toISOString().split('T')[0];
    const present = new Set(read(ATT_KEY).filter(a=> a.date.startsWith(today) && a.action==='in').map(a=> a.employeeId));
    const absent = employees.filter(e=> !present.has(e.id)).slice(0,6).map(e=> e.name).join(', ') || 'none';
    document.getElementById('aiAnswer').textContent = `Absent (sample): ${absent}`;
    return;
  }
  if(q.includes('who') && q.includes('manager')) {
    document.getElementById('aiAnswer').textContent = employees.filter(e=> e.role.toLowerCase().includes('manager')).map(e=> e.name).join(', ') || 'none';
    return;
  }
  document.getElementById('aiAnswer').textContent = "I can answer simple queries like 'who's absent today?' or 'list managers'.";
});

/* --------------------------------------
  Notifications & attendance alert (09:05)
----------------------------------------*/
function updateKPIs(){
  const employees = read(EMP_KEY);
  document.getElementById('totalEmployees').textContent = employees.length;
  const today = new Date().toISOString().split('T')[0];
  const todayAtt = read(ATT_KEY).filter(a=> a.date.startsWith(today) && a.action === 'in');
  const present = new Set(todayAtt.map(a=> a.employeeId));
  document.getElementById('presentToday').textContent = present.size;
  document.getElementById('absentToday').textContent = Math.max(0, employees.length - present.size);
  const payrollTotal = employees.reduce((s,e)=> s + Number(e.salary||0), 0);
  document.getElementById('payrollTotal').textContent = '₵' + payrollTotal.toLocaleString();
}

/* automatic attendance alert after 09:05 */
let attendanceAlertShown = false;
function checkMorningAttendance(){
  const d = new Date();
  const hhmm = d.getHours()*60 + d.getMinutes();
  const threshold = 9*60 + 5; // 09:05
  if(hhmm >= threshold && !attendanceAlertShown){
    const employees = read(EMP_KEY);
    const today = new Date().toISOString().split('T')[0];
    const present = new Set(read(ATT_KEY).filter(a=> a.date.startsWith(today) && a.action==='in').map(a=> a.employeeId));
    const missing = employees.filter(e=> !present.has(e));
    if(missing.length){
      showToast(`Alert: ${missing.length} staff haven't clocked in by 09:05`);
      pushActivity(`Alert: ${missing.length} staff missing at 09:05`);
    }
    attendanceAlertShown = true;
  }
}
/* run every minute */
setInterval(checkMorningAttendance, 60*1000);

/* push notification sample when teacher clocks in (listen storage) */
window.addEventListener('storage', (e)=>{
  const itemsToWatch = [EMP_KEY, ATT_KEY, TEACH_ATT_KEY];
  if(itemsToWatch.includes(e.key)) {
    showToast('Data changed (sync)');
    renderAll();
  }
});

/* teacher attendance UI sync — read TEACH_ATT_KEY to update teacher logs in HR array */
function updateTeacherAttendanceUI(){ /* already done via sync button */ }

/* -------------------------
  Utilities: render all & seed
--------------------------*/
function renderAll(){
  renderEmployees(document.getElementById('searchEmployee').value || '');
  renderAnnouncements();
  renderActivity();
  populatePayrollSelect();
  drawAttendanceChart();
  renderMessages();
  updateKPIs();
}
renderAll();

/* -------------------------
  open profile & payroll helpers
--------------------------*/
function preparePayroll(empId){
  document.getElementById('payEmployeeSelect').value = empId;
  document.getElementById('payEmployeeSelect').dispatchEvent(new Event('change'));
}

/* simple download & CSV helpers already above */
function toCsv(rows){ if(!rows.length) return ''; const keys=Object.keys(rows[0]); const lines=[keys.join(',')]; rows.forEach(r=> lines.push(keys.map(k=>`"${String(r[k]||'').replace(/"/g,'""')}"`).join(','))); return lines.join('\n') }
function downloadText(text, filename, type='text/plain'){ const blob=new Blob([text],{type}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); }

/* -------------------------
  Storage event sync across tabs
--------------------------*/
window.addEventListener('storage', (e)=> { renderAll(); });

/* -------------------------
  Helper: open emp profile externally
--------------------------*/
window.openProfile = openProfile;
window.openEdit = openEdit;

/* -------------------------
  Initial demo & ready
--------------------------*/
console.log('Upgraded HR Dashboard loaded — All features wired locally.');
</script>
</body>
</html>
