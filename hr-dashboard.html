<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HR Dashboard — Multi-Org</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{--nav:#083a66;--accent:#0b63a3;--bg:#f5f8fb}
    body{font-family:'Poppins',sans-serif;background:var(--bg);margin:0;color:#102330}
    header{background:var(--nav);color:#fff;padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
    header h1{font-size:18px;margin:0}
    .container{max-width:1200px;margin:18px auto;padding:18px;background:#fff;border-radius:10px;box-shadow:0 10px 30px rgba(6,18,32,0.06)}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:16px}
    .stat{padding:14px;border-radius:10px;color:#fff;background:linear-gradient(135deg,#0b63a3,#00a6b6);box-shadow:0 8px 28px rgba(6,18,32,0.06)}
    .muted{color:#64748b}
    .table-wrap{padding:12px;border-radius:10px;background:#fff;border:1px solid #eef6fb;max-height:520px;overflow:auto}
    thead th{position:sticky;top:0;background:var(--nav);color:#fff;z-index:2}
    .avatar{width:44px;height:44px;border-radius:8px;object-fit:cover}
    .modal-full{max-width:980px}
    .small{font-size:13px;color:#64748b}
    .btn-ghost{background:transparent;border:1px solid #e6eef9;color:var(--nav)}
    .footer{color:#94a3b8;text-align:center;margin-top:12px}
  </style>
</head>
<body>

<script>
  // Protect dashboard: require activeOrg & activeHR
  (function(){
    function safeParse(s){ try{ return JSON.parse(s);}catch(e){return null} }
    const org = localStorage.getItem('activeOrg');
    const hr = safeParse(localStorage.getItem('activeHR'));
    if(!org || !hr){ window.location.href = 'login.html'; }
    window.__ACTIVE_ORG = org;
    window.__ACTIVE_HR = hr;
  })();
</script>

<header>
  <div style="display:flex;gap:12px;align-items:center">
    <div style="width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,#0b63a3,#00a6b6);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700">FG</div>
    <div>
      <h1 id="orgTitle">HR Dashboard</h1>
      <div class="small" id="orgSub"></div>
    </div>
  </div>

  <div style="display:flex;gap:8px;align-items:center">
    <div id="userInfo" class="muted"></div>
    <button id="manageAccountsBtn" class="btn btn-outline-light btn-sm" style="display:none">Manage HR Accounts</button>
    <button id="logoutBtn" class="btn btn-light btn-sm">Logout</button>
  </div>
</header>

<div class="container">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <div>
      <h3>Organization — <span id="orgNameHeader"></span></h3>
      <div class="small" id="orgNote">Organization workspace</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="searchInput" class="form-control form-control-sm" style="min-width:220px" placeholder="Search name/department/phone/position">
      <button id="refreshBtn" class="btn btn-sm btn-ghost">Refresh</button>
    </div>
  </div>

  <div class="cards" id="statsRow">
    <div class="stat">
      <div class="small">Total Employees</div><h2 id="statEmployees">0</h2>
    </div>
    <div class="stat" style="background:linear-gradient(135deg,#4b6cb7,#182848)">
      <div class="small">Departments</div><h2 id="statDepartments">0</h2>
    </div>
    <div class="stat" style="background:linear-gradient(135deg,#6a11cb,#2575fc)">
      <div class="small">Attendance</div><h2 id="statAttendance">0%</h2>
    </div>
    <div class="stat" style="background:linear-gradient(135deg,#11998e,#38ef7d)">
      <div class="small">Total Payroll</div><h2 id="statPayroll">GHS 0</h2>
    </div>
  </div>

  <div class="table-wrap">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div><strong>Employees</strong> <span class="small muted"> (click Add to create)</span></div>
      <div>
        <button id="addEmpBtn" class="btn btn-sm btn-primary">+ Add Employee</button>
        <button id="openPaymentsBtn" class="btn btn-sm btn-ghost">Payments</button>
        <button id="openAttendanceBtn" class="btn btn-sm btn-ghost">Attendance</button>
        <button id="openReportsBtn" class="btn btn-sm btn-outline-primary">Reports</button>
      </div>
    </div>

    <div id="tableArea" style="max-height:420px;overflow:auto">
      <table class="table table-hover mb-0">
        <thead>
          <tr><th>#</th><th>Photo</th><th>Full name</th><th>Department</th><th>Position</th><th>Email</th><th>Phone</th><th>Salary</th><th>Hire</th><th>Actions</th></tr>
        </thead>
        <tbody id="employeeTbody"></tbody>
      </table>
    </div>
  </div>

  <div class="footer">Flawless Graphics • Multi-Org HR Dashboard</div>
</div>

<!-- Employee Modal -->
<div class="modal fade" id="employeeModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-full">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="empModalTitle">Add Employee</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="employeeForm">
          <input type="hidden" id="empIndex">
          <div class="row">
            <div class="col-md-8">
              <label>Full name</label>
              <input id="empFullName" class="form-control" required>
              <div class="row mt-2">
                <div class="col-md-6"><label>Department</label><input id="empDept" class="form-control"></div>
                <div class="col-md-6"><label>Position</label><input id="empPosition" class="form-control"></div>
              </div>
              <label class="mt-2">Email</label><input id="empEmail" class="form-control" type="email">
              <div class="row mt-2">
                <div class="col-md-4"><label>Phone</label><input id="empPhone" class="form-control"></div>
                <div class="col-md-4"><label>Salary</label><input id="empSalary" class="form-control" type="number"></div>
                <div class="col-md-4"><label>Hire Date</label><input id="empHireDate" class="form-control" type="date"></div>
              </div>
            </div>
            <div class="col-md-4">
              <label>Photo</label>
              <div class="mb-2"><img id="empPhotoPreview" src="https://img.icons8.com/ios/100/000000/user--v1.png" style="width:160px;height:160px;border-radius:8px;object-fit:cover"></div>
              <input id="empPhotoInput" type="file" accept="image/*" class="form-control">
              <div class="small muted mt-2">Optional — saved as data URL in localStorage.</div>
            </div>
          </div>

          <div class="mt-3 text-end">
            <button class="btn btn-primary" type="submit">Save</button>
            <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Close</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Payments Modal -->
<div class="modal fade" id="paymentsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Payments</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <label>Employee</label><select id="payEmp" class="form-select"></select>
            <label class="mt-2">Amount GHS</label><input id="payAmount" class="form-control" type="number">
            <label class="mt-2">Note</label><input id="payNote" class="form-control">
            <div class="mt-3"><button id="savePayment" class="btn btn-primary">Save Payment</button></div>
          </div>
          <div class="col-md-6">
            <h6>Recent Payments</h6>
            <div id="recentPayments" style="max-height:320px;overflow:auto"></div>
            <canvas id="payrollChart" style="max-height:220px;margin-top:12px"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- HR Accounts modal -->
<div class="modal fade" id="hrAccountsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-full">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Manage HR Accounts</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <form id="hrAccountForm">
          <input type="hidden" id="acctIndex">
          <div class="row">
            <div class="col-md-6">
              <label>Full name</label><input id="acct_name" class="form-control">
              <label class="mt-2">Email</label><input id="acct_email" class="form-control" type="email">
              <label class="mt-2">Password (plain for new, leave blank to keep)</label><input id="acct_password" class="form-control" type="password">
              <label class="mt-2">Role</label>
              <select id="acct_role" class="form-select"><option>Admin</option><option>HR Manager</option><option>Payroll Officer</option><option>Supervisor</option></select>
              <div class="mt-2"><button class="btn btn-primary" type="submit">Save</button> <button id="clearAcct" type="button" class="btn btn-outline-secondary">Clear</button></div>
            </div>
            <div class="col-md-6">
              <h6>Accounts</h6>
              <div style="max-height:360px;overflow:auto"><table class="table"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Action</th></tr></thead><tbody id="acctList"></tbody></table></div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Reports modal -->
<div class="modal fade" id="reportsModal" tabindex="-1">
  <div class="modal-dialog modal-full modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Reports</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="d-flex justify-content-between"><div><button id="exportCsv" class="btn btn-primary btn-sm">Export CSV</button><button id="exportPdf" class="btn btn-outline-primary btn-sm">Export PDF</button></div><div class="small muted">Export data for <strong id="reportOrg"></strong></div></div>
        <div style="max-height:520px;overflow:auto;margin-top:12px"><table class="table"><thead><tr><th>#</th><th>Photo</th><th>Name</th><th>Dept</th><th>Pos</th><th>Email</th><th>Phone</th><th>Salary</th><th>Hire</th></tr></thead><tbody id="reportTable"></tbody></table></div>
      </div>
    </div>
  </div>
</div>

<div id="toast" style="position:fixed;right:18px;bottom:18px;display:none;z-index:3000"></div>

<script>
/* hr-dashboard.html: multi-org dashboard
   - expects localStorage.activeOrg and localStorage.activeHR
   - uses per-org keys: <org>_employees, <org>_hrAccounts, <org>_payments, <org>_attendance, <org>_performanceData
*/

function safeParse(s){ try{ return JSON.parse(s); }catch(e){return null} }
const activeOrg = localStorage.getItem('activeOrg');
const activeHR = safeParse(localStorage.getItem('activeHR'));
if(!activeOrg || !activeHR){ window.location.href = 'login.html'; }

const EMP_KEY = `${activeOrg}_employees`;
const HR_KEY = `${activeOrg}_hrAccounts`;
const PAY_KEY = `${activeOrg}_payments`;
const ATT_KEY = `${activeOrg}_attendance`;
const PERF_KEY = `${activeOrg}_performanceData`;

document.getElementById('orgTitle').textContent = activeOrg + ' — HR Dashboard';
document.getElementById('orgNameHeader').textContent = activeOrg;
document.getElementById('orgSub').textContent = `${activeHR.name || activeHR.email} • ${activeHR.role || 'User'}`;
document.getElementById('userInfo').textContent = (activeHR.name || activeHR.email) + ' • ' + (activeHR.role || '');

function showToast(msg, type='success', ms=2200){ const t=document.getElementById('toast'); t.className = 'alert alert-'+(type==='success'?'success':'info'); t.textContent = msg; t.style.display='block'; setTimeout(()=>t.style.display='none', ms); }

async function sha256Hex(str){ try{ const enc=new TextEncoder(); const buf=enc.encode(str); const h=await crypto.subtle.digest('SHA-256', buf); return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join(''); }catch(e){ return str; } }

// storage helpers
function readEmployees(){ return safeParse(localStorage.getItem(EMP_KEY)) || []; }
function saveEmployees(arr){ localStorage.setItem(EMP_KEY, JSON.stringify(arr)); }
function readAccounts(){ return safeParse(localStorage.getItem(HR_KEY)) || []; }
function saveAccounts(arr){ localStorage.setItem(HR_KEY, JSON.stringify(arr)); }
function readPayments(){ return safeParse(localStorage.getItem(PAY_KEY)) || []; }
function savePayments(arr){ localStorage.setItem(PAY_KEY, JSON.stringify(arr)); }

// show Manage Accounts button only to Admin
if(activeHR.role === 'Admin') document.getElementById('manageAccountsBtn').style.display='inline-block';
document.getElementById('logoutBtn').addEventListener('click', ()=>{ localStorage.removeItem('activeOrg'); localStorage.removeItem('activeHR'); window.location.href='login.html'; });

// HR Accounts management
const acctForm = document.getElementById('hrAccountForm'); const acctList = document.getElementById('acctList');
function refreshAccts(){ acctList.innerHTML=''; const arr = readAccounts(); arr.forEach((a,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${a.name||''}</td><td>${a.email||''}</td><td>${a.role||''}</td><td style="text-align:right"><button class="btn btn-sm btn-outline-primary me-1" onclick="editAcct(${i})">Edit</button><button class="btn btn-sm btn-outline-danger" onclick="deleteAcct(${i})">Delete</button></td>`; acctList.appendChild(tr);} ); }
window.deleteAcct = function(i){ if(!confirm('Delete account?')) return; const arr = readAccounts(); arr.splice(i,1); saveAccounts(arr); refreshAccts(); showToast('Deleted','info'); }
window.editAcct = function(i){ const arr = readAccounts(); const a = arr[i]; document.getElementById('acctIndex').value = i; document.getElementById('acct_name').value = a.name; document.getElementById('acct_email').value = a.email; document.getElementById('acct_password').value=''; document.getElementById('acct_role').value = a.role || 'HR Manager'; }

document.getElementById('manageAccountsBtn').addEventListener('click', ()=>{ refreshAccts(); new bootstrap.Modal(document.getElementById('hrAccountsModal')).show(); });
document.getElementById('clearAcct').addEventListener('click', ()=>{ document.getElementById('acctIndex').value=''; document.getElementById('acct_name').value=''; document.getElementById('acct_email').value=''; document.getElementById('acct_password').value=''; document.getElementById('acct_role').value='HR Manager'; });

acctForm.addEventListener('submit', async (e)=>{ e.preventDefault(); const idx = document.getElementById('acctIndex').value; const name = (document.getElementById('acct_name').value||'').trim(); const email = (document.getElementById('acct_email').value||'').trim().toLowerCase(); const pw = (document.getElementById('acct_password').value||'').trim(); const role = document.getElementById('acct_role').value; if(!name||!email){ alert('Name & email required'); return; } let arr = readAccounts(); if(idx !== ''){ const i = Number(idx); arr[i].name = name; arr[i].email = email; arr[i].role = role; if(pw) arr[i].passwordHash = await sha256Hex(pw); saveAccounts(arr); refreshAccts(); showToast('Updated'); } else { if(!pw){ alert('Password required for new account'); return; } if(arr.some(a=>a.email===email)){ alert('Email exists'); return; } const hash = await sha256Hex(pw); arr.push({ name, email, role, passwordHash: hash }); saveAccounts(arr); refreshAccts(); showToast('Created'); } document.getElementById('clearAcct').click(); });

// Employees CRUD
const employeeTbody = document.getElementById('employeeTbody');
function renderEmployees(list=null){ const arr = list || readEmployees(); employeeTbody.innerHTML=''; arr.forEach((e,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${e.photo? `<img src="${e.photo}" class="avatar">` : ''}</td><td>${e.fullName||''}</td><td>${e.department||''}</td><td>${e.position||''}</td><td>${e.email||''}</td><td>${e.phone||''}</td><td>${e.salary?Number(e.salary).toLocaleString():0}</td><td>${e.hireDate||''}</td><td><button class="btn btn-sm btn-outline-primary" onclick="editEmployee(${i})">Edit</button> <button class="btn btn-sm btn-outline-danger" onclick="deleteEmployee(${i})">Delete</button></td>`; employeeTbody.appendChild(tr); }); refreshReportTable(); updateStats(); }
window.deleteEmployee = function(i){ if(!confirm('Delete?')) return; const arr = readEmployees(); arr.splice(i,1); saveEmployees(arr); renderEmployees(); showToast('Deleted','info'); }
window.editEmployee = function(i){ const arr = readEmployees(); const e = arr[i]; document.getElementById('empIndex').value = i; document.getElementById('empFullName').value = e.fullName||''; document.getElementById('empDept').value = e.department||''; document.getElementById('empPosition').value = e.position||''; document.getElementById('empEmail').value = e.email||''; document.getElementById('empPhone').value = e.phone||''; document.getElementById('empSalary').value = e.salary||''; document.getElementById('empHireDate').value = e.hireDate||''; document.getElementById('empPhotoPreview').src = e.photo||'https://img.icons8.com/ios/100/000000/user--v1.png'; document.getElementById('empPhotoInput').value=''; document.getElementById('empModalTitle').textContent = 'Edit Employee'; new bootstrap.Modal(document.getElementById('employeeModal')).show(); }

document.getElementById('addEmpBtn').addEventListener('click', ()=>{ document.getElementById('empIndex').value=''; document.getElementById('employeeForm').reset(); document.getElementById('empPhotoPreview').src='https://img.icons8.com/ios/100/000000/user--v1.png'; document.getElementById('empModalTitle').textContent='Add Employee'; new bootstrap.Modal(document.getElementById('employeeModal')).show(); });

document.getElementById('empPhotoInput').addEventListener('change',(ev)=>{ const f=ev.target.files[0]; if(!f) return; const r=new FileReader(); r.onload= ()=> document.getElementById('empPhotoPreview').src = r.result; r.readAsDataURL(f); });

document.getElementById('employeeForm').addEventListener('submit',(e)=>{ e.preventDefault(); const idx=document.getElementById('empIndex').value; const obj={ fullName:(document.getElementById('empFullName').value||'').trim(), department:(document.getElementById('empDept').value||'').trim(), position:(document.getElementById('empPosition').value||'').trim(), email:(document.getElementById('empEmail').value||'').trim(), phone:(document.getElementById('empPhone').value||'').trim(), salary:Number(document.getElementById('empSalary').value)||0, hireDate:document.getElementById('empHireDate').value || '', photo: document.getElementById('empPhotoPreview').src || '' }; const arr = readEmployees(); if(idx === ''){ arr.push(obj); saveEmployees(arr); showToast('Employee added'); } else { arr[Number(idx)] = Object.assign({}, arr[Number(idx)], obj); saveEmployees(arr); showToast('Employee updated'); } renderEmployees(); new bootstrap.Modal(document.getElementById('employeeModal')).hide(); });

// Payments
function populatePaySelect(){ const sel=document.getElementById('payEmp'); sel.innerHTML='<option value="">-- choose --</option>'; readEmployees().forEach((e,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent = e.fullName || e.email || `Employee ${i+1}`; sel.appendChild(o); }); renderRecentPayments(); }
function renderRecentPayments(){ const box=document.getElementById('recentPayments'); box.innerHTML=''; const payments = readPayments(); if(!payments.length) box.innerHTML = '<div class="small muted">No payments yet</div>'; else payments.slice().reverse().slice(0,10).forEach(p=>{ const d=document.createElement('div'); d.className='p-2 border-bottom'; d.innerHTML = `<div><strong>${p.name}</strong> — GHS ${Number(p.amount).toLocaleString()}</div><div class="small muted">${new Date(p.date).toLocaleString()}</div>`; box.appendChild(d); }); }
document.getElementById('openPaymentsBtn').addEventListener('click', ()=>{ populatePaySelect(); drawPayrollChart(); new bootstrap.Modal(document.getElementById('paymentsModal')).show(); });
document.getElementById('savePayment').addEventListener('click', ()=>{ const idx = document.getElementById('payEmp').value; const amt = Number(document.getElementById('payAmount').value)||0; const note = document.getElementById('payNote').value||''; if(idx === '' || amt<=0){ alert('Select employee & valid amount'); return; } const emp = readEmployees()[Number(idx)]; if(!emp){ alert('Employee not found'); return; } const payments = readPayments(); payments.push({ name: emp.fullName, employeeIndex: Number(idx), amount: amt, note, date: new Date().toISOString() }); savePayments(payments); showToast('Payment recorded'); populatePaySelect(); drawPayrollChart(); });

// Payroll chart
let payrollChart=null;
function drawPayrollChart(){ const ctx = document.getElementById('payrollChart').getContext('2d'); const sums={}; readEmployees().forEach(e=>{ const d=e.department||'Unassigned'; sums[d] = (sums[d]||0) + (Number(e.salary)||0); }); const labels=Object.keys(sums), data=Object.values(sums); if(payrollChart) payrollChart.destroy(); payrollChart = new Chart(ctx, { type:'pie', data:{ labels, datasets:[{ data, backgroundColor:['#0b63a3','#00a6b6','#ff9a76','#9b59b6','#ff7a7a'] }] }, options:{responsive:true} }); }

// Attendance chart
let attendanceChart=null;
function drawAttendance(){ const ctx = document.getElementById('attendanceChart').getContext('2d'); const labels=[],data=[]; for(let i=6;i>=0;i--){ const d=new Date(); d.setDate(d.getDate()-i); labels.push(d.toLocaleDateString()); data.push(Math.floor(Math.random()*16)+80); } if(attendanceChart) attendanceChart.destroy(); attendanceChart = new Chart(ctx, { type:'line', data:{ labels, datasets:[{ label:'Attendance %', data, borderColor:'#0b63a3', backgroundColor:'rgba(11,99,163,0.08)', fill:true }] }, options:{responsive:true, scales:{ y:{min:0,max:100}} } }); }

// Reports export
document.getElementById('openReportsBtn').addEventListener('click', ()=>{ populateReportTable(); document.getElementById('reportOrg').textContent = activeOrg; new bootstrap.Modal(document.getElementById('reportsModal')).show(); });
function populateReportTable(){ const rows = readEmployees(); const tbody = document.getElementById('reportTable'); tbody.innerHTML=''; rows.forEach((r,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${r.photo? `<img src="${r.photo}" style="width:36px;height:36px;border-radius:6px">`: ''}</td><td>${r.fullName||''}</td><td>${r.department||''}</td><td>${r.position||''}</td><td>${r.email||''}</td><td>${r.phone||''}</td><td>${r.salary?Number(r.salary).toLocaleString():0}</td><td>${r.hireDate||''}</td>`; tbody.appendChild(tr); }); }
document.getElementById('exportCsv').addEventListener('click', ()=>{ const rows = readEmployees(); const csv = toCsv(rows.map(r=>({ fullName:r.fullName, department:r.department, position:r.position, email:r.email, phone:r.phone, salary:r.salary, hireDate:r.hireDate }))); downloadText(csv, `${activeOrg}_employees.csv`, 'text/csv'); showToast('CSV downloaded'); });
document.getElementById('exportPdf').addEventListener('click', ()=>{ const { jsPDF } = window.jspdf; const doc=new jsPDF('l','pt','a4'); doc.setFontSize(14); doc.text(`${activeOrg} - Employees`,40,40); const rows=Array.from(document.querySelectorAll('#reportTable tr')); let y=60; rows.forEach(r=>{ const line = Array.from(r.cells).map(c=>c.innerText).join(' | '); doc.text(line,40,y); y+=12; if(y>540){ doc.addPage(); y=40; } }); doc.save(`${activeOrg}_employees.pdf`); showToast('PDF downloaded'); });

function toCsv(rows){ if(!rows.length) return ''; const keys = Object.keys(rows[0]); const lines=[keys.join(',')]; for(const r of rows) lines.push(keys.map(k=>`"${String(r[k]||'').replace(/"/g,'""')}"`).join(',')); return lines.join('\n'); }
function downloadText(text, filename, mime='text/plain'){ const blob=new Blob([text],{ type:mime }); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download = filename; document.body.appendChild(a); a.click(); a.remove(); }

// Search & refresh
document.getElementById('searchInput').addEventListener('input',(e)=>{ const q=(e.target.value||'').toLowerCase(); if(!q) return renderEmployees(); const filtered = readEmployees().filter(emp=> (emp.fullName||'').toLowerCase().includes(q) || (emp.department||'').toLowerCase().includes(q) || (emp.position||'').toLowerCase().includes(q) || (emp.phone||'').toLowerCase().includes(q)); renderEmployees(filtered); });
document.getElementById('refreshBtn').addEventListener('click', ()=>{ renderEmployees(); drawAttendance(); drawPayrollChart(); showToast('Refreshed'); });

// update stats
function updateStats(){ const arr = readEmployees(); document.getElementById('statEmployees').textContent = arr.length; const depts = Array.from(new Set(arr.map(a=>a.department||'Unassigned'))); document.getElementById('statDepartments').textContent = depts.length; const att = safeParse(localStorage.getItem(ATT_KEY)) || []; const attendanceRate = att.length && arr.length ? Math.round(Math.min(100,(att.length/(arr.length*30))*100)) : Math.floor(Math.random()*16)+80; document.getElementById('statAttendance').textContent = attendanceRate + '%'; const total = arr.reduce((s,a)=> s + (Number(a.salary)||0), 0); document.getElementById('statPayroll').textContent = 'GHS ' + total.toLocaleString(); }

// report table refresh
function refreshReportTable(){ populateReportTable(); }

// initial render
renderEmployees(); populatePaySelect(); drawPayrollChart(); drawAttendance(); updateStats();

// storage sync (cross-tab)
window.addEventListener('storage', ()=>{ renderEmployees(); populatePaySelect(); drawPayrollChart(); drawAttendance(); updateStats(); });

// simple polling fallback
let lastEmpSnapshot = localStorage.getItem(EMP_KEY) || '';
setInterval(()=>{ const curr = localStorage.getItem(EMP_KEY)||''; if(curr !== lastEmpSnapshot){ lastEmpSnapshot = curr; renderEmployees(); } }, 2500);

// expose functions for inline handlers
window.editEmployee = editEmployee;
window.deleteEmployee = deleteEmployee;
window.editAcct = editAcct;
window.deleteAcct = deleteAcct;
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
