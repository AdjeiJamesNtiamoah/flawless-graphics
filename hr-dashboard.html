<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HR Dashboard — Organization</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{--nav:#083a66;--accent:#0b63a3;--bg:#f5f8fb}
    body{font-family:'Poppins',sans-serif;background:var(--bg);margin:0;color:#102330}
    header{background:var(--nav);color:#fff;padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
    header h1{font-size:18px;margin:0}
    .layout{display:flex;gap:18px;padding:18px}
    .sidebar{width:220px;background:#0c3a64;color:#fff;padding:18px;border-radius:10px}
    .sidebar h5{margin-top:0}
    .sidebar a{display:block;color:#dff2ff;padding:8px;border-radius:6px;text-decoration:none;margin-bottom:6px}
    .content{flex:1}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:12px}
    .stat-card{padding:12px;border-radius:10px;color:#fff;background:linear-gradient(135deg,#0b63a3,#00a6b6)}
    .table-wrap{background:#fff;padding:12px;border-radius:10px;box-shadow:0 8px 30px rgba(6,18,32,0.06)}
    thead th{position:sticky;top:0;background:var(--nav);color:#fff;z-index:2}
    .avatar{width:48px;height:48px;border-radius:8px;object-fit:cover}
    .modal-full{max-width:1000px}
    .small-muted{color:#627484;font-size:13px}
    @media (max-width:900px){ .sidebar{display:none} }
  </style>
</head>
<body>

<script>
  // Protect: require activeOrg & activeHR
  (function(){
    function safeParse(s){ try{ return JSON.parse(s);}catch(e){return null} }
    const org = localStorage.getItem('activeOrg');
    const hr = safeParse(localStorage.getItem('activeHR'));
    if(!org || !hr){ window.location.href = 'login.html'; }
    window.__ACTIVE_ORG = org;
    window.__ACTIVE_HR = hr;
  })();
</script>

<header>
  <div style="display:flex;gap:12px;align-items:center">
    <div style="width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,#0b63a3,#00a6b6);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700">FG</div>
    <div>
      <h1 id="orgTitle">HR Dashboard</h1>
      <div class="small-muted" id="orgSubtitle"></div>
    </div>
  </div>

  <div style="display:flex;gap:8px;align-items:center">
    <div id="userInfo" class="small-muted"></div>
    <button id="manageAccountsBtn" class="btn btn-outline-light btn-sm" style="display:none">Manage HR Accounts</button>
    <button id="logoutBtn" class="btn btn-light btn-sm">Logout</button>
  </div>
</header>

<div class="layout">
  <aside class="sidebar">
    <h5>Organization</h5>
    <div id="orgNameDisplay" style="font-weight:700"></div>
    <div class="small-muted" style="margin-bottom:10px" id="orgDesc">Workspace</div>

    <nav>
      <a href="#" data-open="employees">Employees</a>
      <a href="#" data-open="payments">Payments</a>
      <a href="#" data-open="attendance">Attendance</a>
      <a href="#" data-open="reports">Reports</a>
      <a href="#" data-open="hrAccounts">HR Accounts</a>
    </nav>

    <div style="margin-top:12px">
      <button id="addEmployeeBtn" class="btn btn-success btn-sm w-100">+ Add Employee</button>
      <button id="exportDataBtn" class="btn btn-outline-light btn-sm w-100 mt-2">Export Org Data</button>
    </div>
  </aside>

  <main class="content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div>
        <h3 id="orgHeader">Organization</h3>
        <div class="small-muted" id="orgInfo"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="globalSearch" class="form-control form-control-sm" placeholder="Search name/phone/department/position" style="min-width:260px">
        <button id="refreshBtn" class="btn btn-sm btn-ghost">Refresh</button>
      </div>
    </div>

    <section class="stats">
      <div class="stat-card">
        <div class="small-muted">Total Employees</div><h2 id="statEmployees">0</h2>
      </div>
      <div class="stat-card" style="background:linear-gradient(135deg,#4b6cb7,#182848)">
        <div class="small-muted">Departments</div><h2 id="statDepartments">0</h2>
      </div>
      <div class="stat-card" style="background:linear-gradient(135deg,#6a11cb,#2575fc)">
        <div class="small-muted">Attendance Rate</div><h2 id="statAttendance">0%</h2>
      </div>
      <div class="stat-card" style="background:linear-gradient(135deg,#11998e,#38ef7d)">
        <div class="small-muted">Total Payroll</div><h2 id="statPayroll">GHS 0</h2>
      </div>
    </section>

    <div class="table-wrap">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div><strong>Employees</strong> <span class="small-muted">(manage employee records)</span></div>
        <div>
          <button id="btnOpenEmployees" class="btn btn-sm btn-primary">Open Employees</button>
          <button id="btnOpenPayments" class="btn btn-sm btn-outline-primary">Open Payments</button>
          <button id="btnOpenAttendance" class="btn btn-sm btn-outline-primary">Open Attendance</button>
        </div>
      </div>

      <div id="tableArea" style="max-height:460px;overflow:auto">
        <table class="table table-hover mb-0">
          <thead><tr><th>#</th><th>Photo</th><th>Full name</th><th>Dept</th><th>Position</th><th>Email</th><th>Phone</th><th>Salary</th><th>Hire Date</th><th>Actions</th></tr></thead>
          <tbody id="employeeTbody"></tbody>
        </table>
      </div>
    </div>
  </main>
</div>

<!-- Employee modal -->
<div class="modal fade" id="employeeModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-full">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="empModalTitle">Add Employee</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="employeeForm">
          <input type="hidden" id="empIndex">
          <div class="row">
            <div class="col-md-8">
              <label>Full name</label><input id="empFullName" class="form-control" required>
              <div class="row mt-2">
                <div class="col-md-6"><label>Department</label><input id="empDept" class="form-control"></div>
                <div class="col-md-6"><label>Position</label><input id="empPosition" class="form-control"></div>
              </div>
              <label class="mt-2">Email</label><input id="empEmail" class="form-control" type="email">
              <div class="row mt-2">
                <div class="col-md-4"><label>Phone</label><input id="empPhone" class="form-control"></div>
                <div class="col-md-4"><label>Salary</label><input id="empSalary" class="form-control" type="number"></div>
                <div class="col-md-4"><label>Hire Date</label><input id="empHireDate" class="form-control" type="date"></div>
              </div>
            </div>

            <div class="col-md-4">
              <label>Photo</label>
              <div class="mb-2"><img id="empPhotoPreview" src="https://img.icons8.com/ios/100/000000/user--v1.png" style="width:140px;height:140px;border-radius:8px;object-fit:cover"></div>
              <input id="empPhotoInput" type="file" accept="image/*" class="form-control">
            </div>
          </div>

          <div class="mt-3 text-end">
            <button class="btn btn-primary" type="submit">Save</button>
            <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Close</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Payments modal -->
<div class="modal fade" id="paymentsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Payments</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <label>Employee</label><select id="payEmp" class="form-select"></select>
            <label class="mt-2">Amount (GHS)</label><input id="payAmount" class="form-control" type="number">
            <label class="mt-2">Note</label><input id="payNote" class="form-control" placeholder="Salary / Bonus">
            <div class="mt-3"><button id="paySubmit" class="btn btn-primary">Submit Payment</button></div>
          </div>
          <div class="col-md-6">
            <h6>Recent Payments</h6><div id="recentPayments" style="max-height:300px;overflow:auto"></div>
            <canvas id="payrollChart" style="max-height:220px;margin-top:12px"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- HR Accounts modal -->
<div class="modal fade" id="hrAccountsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-full">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Manage HR Accounts</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <form id="acctForm">
          <input type="hidden" id="acctIndex">
          <div class="row">
            <div class="col-md-6">
              <label>Full name</label><input id="acctName" class="form-control">
              <label class="mt-2">Email</label><input id="acctEmail" class="form-control" type="email">
              <label class="mt-2">Password (plain for new, leave blank to keep)</label><input id="acctPassword" class="form-control" type="password">
              <label class="mt-2">Role</label><select id="acctRole" class="form-select"><option>Admin</option><option>HR Manager</option><option>Payroll Officer</option><option>Supervisor</option></select>
              <div class="mt-2"><button class="btn btn-primary" type="submit">Save</button> <button id="acctClear" type="button" class="btn btn-outline-secondary">Clear</button></div>
            </div>

            <div class="col-md-6">
              <h6>Accounts</h6>
              <div style="max-height:380px;overflow:auto"><table class="table"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Action</th></tr></thead><tbody id="acctList"></tbody></table></div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Reports modal -->
<div class="modal fade" id="reportsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-full">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Reports</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div><button id="exportCSV" class="btn btn-primary btn-sm">Export CSV</button> <button id="exportPDF" class="btn btn-outline-primary btn-sm">Export PDF</button></div>
          <div class="small-muted">Export data for <strong id="reportOrg"></strong></div>
        </div>
        <div style="max-height:520px;overflow:auto"><table class="table"><thead><tr><th>#</th><th>Photo</th><th>Name</th><th>Dept</th><th>Position</th><th>Email</th><th>Phone</th><th>Salary</th><th>Hire</th></tr></thead><tbody id="reportTable"></tbody></table></div>
      </div>
    </div>
  </div>
</div>

<div id="toast" style="position:fixed;right:18px;bottom:18px;display:none;z-index:3000"></div>

<script>
/* hr-dashboard.html - per-organization dashboard
   - expects localStorage.activeOrg and localStorage.activeHR
   - ensures all keys for the org are initialized
   - employee CRUD, HR management (Admin-only), payments, reports, charts
*/

function safeParse(s){ try{ return JSON.parse(s);}catch(e){return null} }
const activeOrg = localStorage.getItem('activeOrg');
const activeHR = safeParse(localStorage.getItem('activeHR'));
if(!activeOrg || !activeHR){ window.location.href = 'login.html'; }

// keys
const EMP_KEY = `${activeOrg}_employees`;
const HR_KEY = `${activeOrg}_hrAccounts`;
const PAY_KEY = `${activeOrg}_payments`;
const ATT_KEY = `${activeOrg}_attendance`;
const PERF_KEY = `${activeOrg}_performanceData`;

// ensure keys exist
if(!localStorage.getItem(EMP_KEY)) localStorage.setItem(EMP_KEY, JSON.stringify([]));
if(!localStorage.getItem(HR_KEY)) localStorage.setItem(HR_KEY, JSON.stringify([]));
if(!localStorage.getItem(PAY_KEY)) localStorage.setItem(PAY_KEY, JSON.stringify([]));
if(!localStorage.getItem(ATT_KEY)) localStorage.setItem(ATT_KEY, JSON.stringify([]));
if(!localStorage.getItem(PERF_KEY)) localStorage.setItem(PERF_KEY, JSON.stringify({}));

// UI labels
document.getElementById('orgTitle').textContent = activeOrg + ' — HR Dashboard';
document.getElementById('orgSubtitle').textContent = activeHR.name + ' • ' + activeHR.role;
document.getElementById('orgNameDisplay').textContent = activeOrg;
document.getElementById('orgHeader').textContent = activeOrg;
document.getElementById('orgInfo').textContent = `${activeHR.name} • ${activeHR.role}`;
document.getElementById('reportOrg').textContent = activeOrg;

// helper: sha256
async function sha256Hex(str){
  try{
    const enc = new TextEncoder();
    const buf = enc.encode(str);
    const h = await crypto.subtle.digest('SHA-256', buf);
    return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }catch(e){
    return str;
  }
}

// storage helpers
function readEmployees(){ return safeParse(localStorage.getItem(EMP_KEY)) || []; }
function saveEmployees(arr){ localStorage.setItem(EMP_KEY, JSON.stringify(arr)); }
function readAccounts(){ return safeParse(localStorage.getItem(HR_KEY)) || []; }
function saveAccounts(arr){ localStorage.setItem(HR_KEY, JSON.stringify(arr)); }
function readPayments(){ return safeParse(localStorage.getItem(PAY_KEY)) || []; }
function savePayments(arr){ localStorage.setItem(PAY_KEY, JSON.stringify(arr)); }

// session & UI for Admin-only functions
if(activeHR.role === 'Admin') document.getElementById('manageAccountsBtn').style.display='inline-block';
document.getElementById('logoutBtn').addEventListener('click', ()=> { localStorage.removeItem('activeOrg'); localStorage.removeItem('activeHR'); window.location.href = 'login.html'; });

// toast
function toast(msg, kind='success', ms=2400){ const t = document.getElementById('toast'); t.className = 'alert alert-'+(kind==='success'?'success':'info'); t.textContent = msg; t.style.display='block'; setTimeout(()=> t.style.display='none', ms); }

// render employees
const tbody = document.getElementById('employeeTbody');
function renderEmployees(list=null){
  const arr = list || readEmployees();
  tbody.innerHTML = '';
  arr.forEach((e,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td>
      <td>${e.photo? `<img src="${e.photo}" class="avatar">` : ''}</td>
      <td>${e.fullName||''}</td>
      <td>${e.department||''}</td>
      <td>${e.position||''}</td>
      <td>${e.email||''}</td>
      <td>${e.phone||''}</td>
      <td>${e.salary?Number(e.salary).toLocaleString():0}</td>
      <td>${e.hireDate||''}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary" onclick="editEmployee(${i})">Edit</button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteEmployee(${i})">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
  populateReportTable();
  updateStats();
  populatePaySelect();
}

// add/edit employee
document.getElementById('addEmployeeBtn').addEventListener('click', ()=> {
  document.getElementById('empIndex').value = '';
  document.getElementById('employeeForm').reset();
  document.getElementById('empPhotoPreview').src = 'https://img.icons8.com/ios/100/000000/user--v1.png';
  document.getElementById('empModalTitle').textContent = 'Add Employee';
  new bootstrap.Modal(document.getElementById('employeeModal')).show();
});

document.getElementById('empPhotoInput').addEventListener('change', (ev)=> {
  const f = ev.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = ()=> document.getElementById('empPhotoPreview').src = r.result; r.readAsDataURL(f);
});

document.getElementById('employeeForm').addEventListener('submit', (e)=> {
  e.preventDefault();
  const idx = document.getElementById('empIndex').value;
  const obj = {
    fullName: (document.getElementById('empFullName').value||'').trim(),
    department: (document.getElementById('empDept').value||'').trim(),
    position: (document.getElementById('empPosition').value||'').trim(),
    email: (document.getElementById('empEmail').value||'').trim(),
    phone: (document.getElementById('empPhone').value||'').trim(),
    salary: Number(document.getElementById('empSalary').value) || 0,
    hireDate: document.getElementById('empHireDate').value || '',
    photo: document.getElementById('empPhotoPreview').src || ''
  };
  const arr = readEmployees();
  if(idx === ''){
    arr.push(obj); saveEmployees(arr); toast('Employee added');
  } else {
    arr[Number(idx)] = Object.assign({}, arr[Number(idx)], obj); saveEmployees(arr); toast('Employee updated');
  }
  renderEmployees();
  bootstrap.Modal.getInstance(document.getElementById('employeeModal')).hide();
});

window.editEmployee = function(i){
  const arr = readEmployees(); const e = arr[i];
  document.getElementById('empIndex').value = i;
  document.getElementById('empFullName').value = e.fullName || '';
  document.getElementById('empDept').value = e.department || '';
  document.getElementById('empPosition').value = e.position || '';
  document.getElementById('empEmail').value = e.email || '';
  document.getElementById('empPhone').value = e.phone || '';
  document.getElementById('empSalary').value = e.salary || '';
  document.getElementById('empHireDate').value = e.hireDate || '';
  document.getElementById('empPhotoPreview').src = e.photo || 'https://img.icons8.com/ios/100/000000/user--v1.png';
  new bootstrap.Modal(document.getElementById('employeeModal')).show();
};

window.deleteEmployee = function(i){
  if(!confirm('Delete employee?')) return;
  const arr = readEmployees(); arr.splice(i,1); saveEmployees(arr); renderEmployees(); toast('Employee deleted','info');
};

// payments
function populatePaySelect(){
  const sel = document.getElementById('payEmp'); sel.innerHTML = '<option value="">-- choose --</option>';
  readEmployees().forEach((e,i)=>{ const o = document.createElement('option'); o.value = i; o.textContent = e.fullName || e.email || `Employee ${i+1}`; sel.appendChild(o); });
  renderRecentPayments();
}
document.getElementById('btnOpenPayments').addEventListener('click', ()=> { populatePaySelect(); drawPayrollChart(); new bootstrap.Modal(document.getElementById('paymentsModal')).show(); });

document.getElementById('paySubmit').addEventListener('click', ()=> {
  const idx = document.getElementById('payEmp').value;
  const amount = Number(document.getElementById('payAmount').value) || 0;
  const note = document.getElementById('payNote').value || '';
  if(idx === '' || amount <= 0){ alert('Select employee and valid amount'); return; }
  const emp = readEmployees()[Number(idx)];
  const payments = readPayments();
  payments.push({ name: emp.fullName, employeeIndex: Number(idx), amount, note, date: new Date().toISOString() });
  savePayments(payments); toast('Payment recorded'); renderRecentPayments(); drawPayrollChart();
});

function renderRecentPayments(){
  const box = document.getElementById('recentPayments'); box.innerHTML = '';
  const payments = readPayments();
  if(!payments.length) box.innerHTML = '<div class="small-muted">No payments yet</div>';
  else payments.slice().reverse().slice(0,10).forEach(p=>{
    const d = document.createElement('div'); d.className = 'p-2 border-bottom';
    d.innerHTML = `<div><strong>${p.name}</strong> — GHS ${Number(p.amount).toLocaleString()}</div><div class="small-muted">${new Date(p.date).toLocaleString()}</div>`;
    box.appendChild(d);
  });
}

// payroll chart
let payrollChart = null;
function drawPayrollChart(){
  const ctx = document.getElementById('payrollChart').getContext('2d');
  const sums = {};
  readEmployees().forEach(e=>{ const d = e.department || 'Unassigned'; sums[d] = (sums[d]||0) + (Number(e.salary)||0); });
  const labels = Object.keys(sums), data = Object.values(sums);
  if(payrollChart) payrollChart.destroy();
  payrollChart = new Chart(ctx, { type:'pie', data:{ labels, datasets:[{ data, backgroundColor:['#0b63a3','#00a6b6','#ff9a76','#9b59b6','#ff7a7a'] }] }, options:{responsive:true} });
}

// attendance chart
let attendanceChart=null;
function drawAttendance(){
  const ctx = document.getElementById('payrollChart') ? document.getElementById('payrollChart').getContext('2d') : null;
  // draw in payments modal already uses payrollChart; for attendance we will show a simple modal chart if needed
}

// reports
function populateReportTable(){
  const rows = readEmployees(); const tbody = document.getElementById('reportTable'); if(!tbody) return; tbody.innerHTML = '';
  rows.forEach((r,i)=> { const tr = document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${r.photo? `<img src="${r.photo}" style="width:36px;height:36px;border-radius:6px">` : ''}</td><td>${r.fullName||''}</td><td>${r.department||''}</td><td>${r.position||''}</td><td>${r.email||''}</td><td>${r.phone||''}</td><td>${r.salary?Number(r.salary).toLocaleString():0}</td><td>${r.hireDate||''}</td>`; tbody.appendChild(tr); });
}
document.getElementById('btnOpenAttendance').addEventListener('click', ()=> { drawAttendance(); alert('Attendance visual is simulated here.'); });

// export CSV/PDF
document.getElementById('exportCSV').addEventListener('click', ()=> {
  const rows = readEmployees(); const csv = toCsv(rows.map(r=>({ fullName:r.fullName, department:r.department, position:r.position, email:r.email, phone:r.phone, salary:r.salary, hireDate:r.hireDate })));
  downloadText(csv, `${activeOrg}_employees.csv`, 'text/csv');
  toast('CSV exported');
});
document.getElementById('exportPDF').addEventListener('click', ()=> {
  const { jsPDF } = window.jspdf; const doc = new jsPDF('l','pt','a4'); doc.setFontSize(14); doc.text(`${activeOrg} - Employees`, 40, 40); const rows = Array.from(document.querySelectorAll('#reportTable tr')); let y=60; rows.forEach(r=>{ const text = Array.from(r.cells).map(c=>c.innerText).join(' | '); doc.text(text,40,y); y+=12; if(y>540){ doc.addPage(); y=40; } }); doc.save(`${activeOrg}_employees.pdf`); toast('PDF exported');
});

// HR Accounts management (admin)
const acctForm = document.getElementById('acctForm');
const acctList = document.getElementById('acctList');
function refreshAccounts(){
  acctList.innerHTML = '';
  const arr = readAccounts();
  arr.forEach((a,i)=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${a.name||''}</td><td>${a.email||''}</td><td>${a.role||''}</td><td style="text-align:right"><button class="btn btn-sm btn-outline-primary me-1" onclick="editAcct(${i})">Edit</button><button class="btn btn-sm btn-outline-danger" onclick="deleteAcct(${i})">Delete</button></td>`; acctList.appendChild(tr); });
}
window.deleteAcct = function(i){ if(!confirm('Delete HR account?')) return; const arr = readAccounts(); arr.splice(i,1); saveAccounts(arr); refreshAccounts(); toast('Account deleted','info'); }
window.editAcct = function(i){ const arr = readAccounts(); const a = arr[i]; document.getElementById('acctIndex').value = i; document.getElementById('acctName').value = a.name; document.getElementById('acctEmail').value = a.email; document.getElementById('acctPassword').value=''; document.getElementById('acctRole').value = a.role || 'HR Manager'; }

document.getElementById('manageAccountsBtn').addEventListener('click', ()=> { if(activeHR.role !== 'Admin'){ alert('Admin only'); return; } refreshAccounts(); new bootstrap.Modal(document.getElementById('hrAccountsModal')).show(); });

document.getElementById('acctClear').addEventListener('click', ()=> { document.getElementById('acctIndex').value=''; document.getElementById('acctName').value=''; document.getElementById('acctEmail').value=''; document.getElementById('acctPassword').value=''; document.getElementById('acctRole').value='HR Manager'; });

acctForm.addEventListener('submit', async (e)=> { e.preventDefault(); const idx = document.getElementById('acctIndex').value; const name = (document.getElementById('acctName').value||'').trim(); const email = (document.getElementById('acctEmail').value||'').trim().toLowerCase(); const pw = (document.getElementById('acctPassword').value||'').trim(); const role = document.getElementById('acctRole').value; if(!name || !email){ alert('Name & email required'); return; } const arr = readAccounts(); if(idx !== ''){ const i = Number(idx); arr[i].name = name; arr[i].email = email; arr[i].role = role; if(pw) arr[i].passwordHash = await sha256Hex(pw); saveAccounts(arr); refreshAccounts(); toast('Account updated'); } else { if(!pw){ alert('Password required for new account'); return; } if(arr.some(a=>a.email === email)){ alert('Email exists'); return; } const hash = await sha256Hex(pw); arr.push({ name, email, role, passwordHash: hash }); saveAccounts(arr); refreshAccounts(); toast('Account created'); } document.getElementById('acctClear').click(); });

// reports table populate
function populateReportTable(){ const rows = readEmployees(); const tbody = document.getElementById('reportTable'); tbody.innerHTML = ''; rows.forEach((r,i)=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${r.photo? `<img src="${r.photo}" style="width:36px;height:36px;border-radius:6px">` : ''}</td><td>${r.fullName||''}</td><td>${r.department||''}</td><td>${r.position||''}</td><td>${r.email||''}</td><td>${r.phone||''}</td><td>${r.salary?Number(r.salary).toLocaleString():0}</td><td>${r.hireDate||''}</td>`; tbody.appendChild(tr); }); }

// export utilities
function toCsv(rows){ if(!rows.length) return ''; const keys = Object.keys(rows[0]); const lines = [keys.join(',')]; for(const r of rows) lines.push(keys.map(k=>`"${String(r[k]||'').replace(/"/g,'""')}"`).join(',')); return lines.join('\n'); }
function downloadText(text, filename, mime='text/plain'){ const blob = new Blob([text], { type: mime }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; document.body.appendChild(a); a.click(); a.remove(); }

// search & refresh
document.getElementById('globalSearch').addEventListener('input', (e)=> {
  const q = (e.target.value || '').toLowerCase();
  if(!q) return renderEmployees();
  const filtered = readEmployees().filter(emp=> (emp.fullName||'').toLowerCase().includes(q) || (emp.department||'').toLowerCase().includes(q) || (emp.position||'').toLowerCase().includes(q) || (emp.phone||'').toLowerCase().includes(q));
  renderEmployees(filtered);
});
document.getElementById('refreshBtn').addEventListener('click', ()=> { renderEmployees(); drawPayrollChart(); toast('Refreshed'); });

// export org data
document.getElementById('exportDataBtn').addEventListener('click', ()=> {
  const data = { employees: readEmployees(), hrAccounts: readAccounts(), payments: readPayments(), performance: safeParse(localStorage.getItem(PERF_KEY)) || {} };
  downloadText(JSON.stringify(data, null, 2), `${activeOrg}_export.json`, 'application/json');
  toast('Export downloaded');
});

// initial render
renderEmployees();
drawPayrollChart();
populatePaySelect();
populateReportTable();

// storage sync (cross-tab)
window.addEventListener('storage', ()=> { renderEmployees(); drawPayrollChart(); populatePaySelect(); });

// polling fallback
let lastSnap = localStorage.getItem(EMP_KEY) || '';
setInterval(()=>{ const cur = localStorage.getItem(EMP_KEY) || ''; if(cur !== lastSnap){ lastSnap = cur; renderEmployees(); } }, 2500);

// expose some functions globally
window.editAcct = editAcct;
window.deleteAcct = deleteAcct;
window.editEmployee = editEmployee;
window.deleteEmployee = deleteEmployee;
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
