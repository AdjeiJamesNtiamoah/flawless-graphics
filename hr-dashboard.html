<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Flawless Graphics â€” HR Dashboard</title>

<!-- Fonts + libs -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --nav:#073b66; --accent:#0b63a3; --muted:#64748b; --bg:#f5f8fb;
  --card-from:#0b63a3; --card-to:#00a6b6;
}
*{box-sizing:border-box}
body{font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);margin:0;color:#102330}
header{background:var(--nav);color:#fff;padding:18px 22px;display:flex;align-items:center;gap:12px}
.logo{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--card-from),var(--card-to));display:flex;align-items:center;justify-content:center;font-weight:700}
header h1{font-size:18px;margin:0}
.container{max-width:1200px;margin:24px auto;padding:18px;background:#fff;border-radius:10px;box-shadow:0 10px 30px rgba(10,20,40,0.06)}

.top-bar{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.search input{padding:8px 12px;border-radius:8px;border:1px solid #e3eef9;min-width:260px}

.btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
.btn.ghost{background:transparent;border:1px solid #e3eef9;color:var(--accent)}
.small{font-size:13px;color:var(--muted)}

.stats{display:flex;gap:12px;margin-top:18px;flex-wrap:wrap}
.stat{flex:1 1 180px;background:linear-gradient(135deg,var(--card-from),var(--card-to));color:#fff;padding:16px;border-radius:10px;text-align:center;box-shadow:0 8px 22px rgba(8,20,40,0.08);transition:transform .15s}
.stat:hover{transform:translateY(-6px)}
.stat h2{margin:0;font-size:22px}
.stat p{margin:6px 0 0;font-size:13px;opacity:.95}

.main-grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:18px}

/* Table */
.table-wrap{overflow:auto;background:#fff;border-radius:8px;padding:12px;border:1px solid #eef6fb}
table{width:100%;border-collapse:collapse}
thead th{position:sticky;top:0;background:var(--nav);color:#fff;padding:10px;text-align:left;z-index:5}
th,td{padding:10px;border-bottom:1px solid #eef4fb;vertical-align:middle}
.avatar{width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 6px 12px rgba(6,20,40,0.08)}
.badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:600;font-size:13px}
.badge.it{background:linear-gradient(90deg,#e7f6ff,#e8fbfb);color:#0b63a3}
.badge.finance{background:linear-gradient(90deg,#eaf9ee,#eefdf0);color:#1b8a2a}
.badge.hr{background:linear-gradient(90deg,#f7eefc,#fbf0ff);color:#7b43c3}
.badge.safety{background:linear-gradient(90deg,#fff7e6,#fff7ea);color:#a86f00}
.badge.admin{background:#eef6fb;color:#0b63a3}

/* Cards */
.cards{display:none;gap:12px;margin-top:14px;flex-wrap:wrap}
.card{background:#fff;padding:12px;border-radius:10px;border:1px solid #eef6fb;width:260px;box-shadow:0 10px 24px rgba(8,16,30,0.04)}
.card img{width:72px;height:72px;border-radius:12px;object-fit:cover}

/* modal */
.modal{display:none;position:fixed;inset:0;background:rgba(6,12,24,0.55);z-index:1200;align-items:center;justify-content:center;padding:18px}
.box{background:#fff;border-radius:10px;padding:18px;max-width:1100px;width:100%;position:relative;box-shadow:0 20px 60px rgba(4,20,40,0.2)}
.close{position:absolute;right:14px;top:12px;border:none;background:transparent;font-size:20px;cursor:pointer;color:#6b7c93}
.form-grid{display:grid;grid-template-columns:1fr 240px;gap:12px}
.form-row{display:flex;flex-direction:column;gap:6px;margin-bottom:6px}
input[type="file"]{padding:6px}

/* small responsive */
@media (max-width:900px){.form-grid{grid-template-columns:1fr}.stats{flex-direction:column}.cards{justify-content:center}.search input{min-width:100%}}

#toast {position:fixed;right:18px;bottom:18px;background:#111;color:#fff;padding:12px 14px;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,0.2);opacity:0;transform:translateX(120%);transition:0.45s}
#toast.show{opacity:1;transform:translateX(0)}
</style>
</head>
<body>
  <script>
(function(){
  function nowSecs(){ return Math.floor(Date.now()/1000); }
  try{
    const sess = JSON.parse(localStorage.getItem('hr_session') || 'null');
    if(!sess || !sess.expires || nowSecs() > sess.expires){
      // not logged in or expired
      localStorage.removeItem('hr_session');
      window.location.href = 'login.html';
    }
    // Make current session available to page scripts
    window.__HR_SESSION = sess;
  }catch(e){
    localStorage.removeItem('hr_session');
    window.location.href = 'login.html';
  }
})();
</script>

<header>
  <div class="logo">FG</div>
  <div>
    <h1>FLAWLESS GRAPHICS â€” HR Dashboard</h1>
    <div class="small">Employee management â€¢ Payroll â€¢ Attendance â€¢ Reports</div>
  </div>
</header>

<div class="container">
  <div class="top-bar">
    <div>
      <strong style="font-size:16px">HR Dashboard</strong>
      <div class="small">Welcome, HR Manager</div>
    </div>

    <div class="controls">
      <div class="search"><input id="globalSearch" placeholder="Search employees, dept, phone, position..." /></div>
      <button class="btn" id="openEmployeeReport">Employee Report</button>
      <button class="btn ghost" id="openPaymentPortal">Payment Portal</button>
      <button class="btn ghost" id="openAttendance">Attendance</button>
      <button class="btn" id="refreshAll">Refresh</button>
    </div>
  </div>

  <div class="stats" aria-hidden="false">
    <div class="stat"><h2 id="totalEmployees">0</h2><p>Total Employees</p></div>
    <div class="stat"><h2 id="totalDepartments">0</h2><p>Departments</p></div>
    <div class="stat"><h2 id="attendanceRate">0%</h2><p>Attendance Rate</p></div>
    <div class="stat"><h2 id="totalPayroll">GHS 0</h2><p>Total Payroll</p></div>
    <div class="stat" id="topDeptCard" style="cursor:pointer"><h2 id="topDepartment">N/A</h2><p>Top Performing Department</p></div>
  </div>

  <div class="main-grid">
    <div class="table-wrap" id="tableWrap" style="margin-top:12px">
      <table id="employeeTable">
        <thead>
          <tr>
            <th>#</th><th>Photo</th><th>Full Name</th><th>Department</th><th>Position</th><th>Email</th><th>Phone</th><th>Salary</th><th>Hire Date</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="cards" id="cardsContainer" style="display:none"></div>
  </div>
</div>

<!-- Employee Report Modal -->
<div class="modal" id="reportModal" aria-hidden="true">
  <div class="box">
    <button class="close" data-close>&times;</button>
    <header style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <div>
        <h3>Employee Report</h3>
        <div class="small">View and export employees</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="refreshReport">Refresh Data</button>
        <button class="btn" id="downloadPdf">Download as PDF</button>
      </div>
    </header>
<button class="btn ghost" onclick="logout()">Logout</button>
    <div style="margin-top:12px;max-height:520px;overflow:auto">
      <table id="reportTable" style="width:100%;border-collapse:collapse">
        <thead><tr><th>#</th><th>Photo</th><th>Full Name</th><th>Department</th><th>Position</th><th>Email</th><th>Phone</th><th>Salary</th><th>Hire Date</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Payment Portal Modal -->
<div class="modal" id="paymentModal" aria-hidden="true">
  <div class="box">
    <button class="close" data-close>&times;</button>
    <h3>Payment Portal</h3>
    <div style="display:flex;gap:12px;align-items:flex-start">
      <div style="flex:1">
        <label>Employee</label><br>
        <select id="paymentEmployee" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6f0fa"></select>

        <label style="margin-top:8px">Amount (GHS)</label><br>
        <input type="number" id="paymentAmount" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6f0fa" />

        <label style="margin-top:8px">Payment Reason</label><br>
        <input id="paymentNote" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6f0fa" placeholder="Salary / Bonus / Reimb." />

        <div style="margin-top:12px"><button class="btn" id="submitPayment">Submit Payment</button></div>
      </div>

      <div style="width:320px;padding-left:12px;border-left:1px solid #eef6fb">
        <h4>Recent Payments</h4>
        <div id="recentPayments" style="max-height:300px;overflow:auto"></div>
      </div>
    </div>
  </div>
</div>

<!-- Attendance modal -->
<div class="modal" id="attendanceModal" aria-hidden="true">
  <div class="box">
    <button class="close" data-close>&times;</button>
    <h3>Attendance Summary</h3>
    <canvas id="attendanceChart" style="max-height:360px;margin-top:12px"></canvas>
  </div>
</div>

<!-- Payroll analytics modal -->
<div class="modal" id="payrollModal" aria-hidden="true">
  <div class="box">
    <button class="close" data-close>&times;</button>
    <h3>Payroll Analytics</h3>
    <div style="display:flex;gap:12px;align-items:flex-start">
      <div style="flex:1"><canvas id="payrollDeptChart"></canvas></div>
      <div style="flex:1"><canvas id="payrollTrendChart"></canvas></div>
    </div>
  </div>
</div>

<!-- Department modal -->
<div class="modal" id="departmentModal" aria-hidden="true">
  <div class="box">
    <button class="close" data-close>&times;</button>
    <h3>Department Breakdown</h3>
    <div style="display:flex;gap:10px;align-items:center;margin-top:8px">
      <select id="deptSelect" style="padding:8px;border-radius:6px;border:1px solid #eef6fb"></select>
      <button class="btn" id="loadDept">Load</button>
      <button class="btn ghost" id="downloadDept">Download PDF</button>
    </div>
    <div style="margin-top:12px;max-height:340px;overflow:auto">
      <table id="deptTable" style="width:100%;border-collapse:collapse">
        <thead><tr><th>#</th><th>Name</th><th>Avg Score</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <h4 id="deptAverage" style="margin-top:10px">Average Score: 0%</h4>
  </div>
</div>

<div id="toast"></div>

<script>
  // Load existing HR accounts
let hrAccounts = JSON.parse(localStorage.getItem("hrAccounts")) || [];

// Save HR Account
function saveHRAccount() {
    const name = document.getElementById("hrName").value.trim();
    const email = document.getElementById("hrEmail").value.trim();
    const password = document.getElementById("hrPassword").value.trim();
    const role = document.getElementById("hrRole").value;

    if (!name || !email || !password) {
        alert("Please fill all fields.");
        return;
    }

    // Check if email already exists
    const exists = hrAccounts.find(acc => acc.email === email);

    if (exists) {
        alert("This HR account already exists.");
        return;
    }

    hrAccounts.push({ name, email, password, role });

    localStorage.setItem("hrAccounts", JSON.stringify(hrAccounts));

    alert("HR Account saved successfully!");

    loadHRAccounts();
    clearHRForm();
}

// Load list of existing HR accounts
function loadHRAccounts() {
    const table = document.getElementById("hrAccountsList");
    table.innerHTML = "";

    hrAccounts.forEach((acc, i) => {
        table.innerHTML += `
            <tr>
                <td>${acc.name}</td>
                <td>${acc.email}</td>
                <td>${acc.role}</td>
                <td><button onclick="deleteHRAccount(${i})">Delete</button></td>
            </tr>
        `;
    });
}

// Delete HR account
function deleteHRAccount(index) {
    if (confirm("Are you sure you want to delete this HR account?")) {
        hrAccounts.splice(index, 1);
        localStorage.setItem("hrAccounts", JSON.stringify(hrAccounts));
        loadHRAccounts();
    }
}

function clearHRForm() {
    document.getElementById("hrName").value = "";
    document.getElementById("hrEmail").value = "";
    document.getElementById("hrPassword").value = "";
    document.getElementById("hrRole").value = "Admin";
}

/* ---------- Helpers ---------- */
const safeParse = s => { try{ return JSON.parse(s); }catch(e){return null;} };
const employeesKey = 'employees';
const paymentsKey = 'payments';
const performanceKey = 'performanceData';
const attendanceKey = 'attendance';

function readEmployees(){ return safeParse(localStorage.getItem(employeesKey)) || []; }
function saveEmployees(arr){ localStorage.setItem(employeesKey, JSON.stringify(arr)); }

function formatGHS(n){ return 'GHS ' + (Number(n)||0).toLocaleString(); }
function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

function badgeHtml(dept){
  if(!dept) return `<span class="badge admin">Unassigned</span>`;
  const d = String(dept).toLowerCase();
  if(d.includes('it')) return `<span class="badge it">IT</span>`;
  if(d.includes('finance')) return `<span class="badge finance">Finance</span>`;
  if(d.includes('hr')) return `<span class="badge hr">HR</span>`;
  if(d.includes('safety')) return `<span class="badge safety">Safety</span>`;
  return `<span class="badge admin">${escapeHtml(dept)}</span>`;
}

/* ---------- UI references ---------- */
const tbody = document.querySelector('#employeeTable tbody');
const cardsContainer = document.getElementById('cardsContainer');
const totalEmployeesEl = document.getElementById('totalEmployees');
const totalDepartmentsEl = document.getElementById('totalDepartments');
const attendanceRateEl = document.getElementById('attendanceRate');
const totalPayrollEl = document.getElementById('totalPayroll');
const topDepartmentEl = document.getElementById('topDepartment');
const topDeptCard = document.getElementById('topDeptCard');

const reportModal = document.getElementById('reportModal');
const reportTableBody = document.querySelector('#reportTable tbody');

const paymentModal = document.getElementById('paymentModal');
const paymentEmployeeSelect = document.getElementById('paymentEmployee');
const recentPaymentsEl = document.getElementById('recentPayments');

const attendanceModal = document.getElementById('attendanceModal');
const payrollModal = document.getElementById('payrollModal');
const departmentModal = document.getElementById('departmentModal');

/* ---------- Charts ---------- */
let attendanceChart=null, payrollDeptChart=null, payrollTrendChart=null;

/* ---------- Render employees (table + cards) ---------- */
function renderEmployees(filterList=null){
  const employees = filterList || readEmployees();
  tbody.innerHTML = '';
  cardsContainer.innerHTML = '';
  employees.forEach((e,i)=>{
    const photo = e.photo ? `<img src="${e.photo}" class="avatar" alt="photo">` : `<div style="width:40px;height:40px;border-radius:50%;background:#eef6fb;display:inline-block"></div>`;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${photo}</td>
      <td>${escapeHtml(e.fullName||'N/A')}</td>
      <td>${badgeHtml(e.department)}</td>
      <td>${escapeHtml(e.position||'')}</td>
      <td><a href="mailto:${escapeHtml(e.email||'')}" class="small">${escapeHtml(e.email||'')}</a></td>
      <td class="small">${escapeHtml(e.phone||'')}</td>
      <td class="small">${e.salary ? Number(e.salary).toLocaleString() : '0'}</td>
      <td class="small">${escapeHtml(e.hireDate||'')}</td>
      <td class="actions">
        <button class="btn ghost" onclick="openEdit(${i})">Edit</button>
        <button class="btn" onclick="deleteEmployee(${i})">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);

    // cards
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `
      <img src="${e.photo||'https://img.icons8.com/ios/100/000000/user--v1.png'}" alt="photo">
      <h4>${escapeHtml(e.fullName||'N/A')}</h4>
      <div style="margin:6px 0">${badgeHtml(e.department)}</div>
      <div class="small"><b>${escapeHtml(e.position||'')}</b></div>
      <div class="small">${escapeHtml(e.email||'')}</div>
      <div class="small">ðŸ“ž ${escapeHtml(e.phone||'')}</div>
      <div class="small">Salary: ${formatGHS(e.salary||0)}</div>
      <div class="small">Hired: ${escapeHtml(e.hireDate||'')}</div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn ghost" onclick="openEdit(${i})">Edit</button>
        <button class="btn" onclick="deleteEmployee(${i})">Delete</button>
      </div>`;
    cardsContainer.appendChild(card);
  });

  // update report modal body too
  reportTableBody.innerHTML = '';
  employees.forEach((e,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td>
      <td>${e.photo? `<img src="${e.photo}" class="avatar">` : ''}</td>
      <td>${escapeHtml(e.fullName||'')}</td>
      <td>${escapeHtml(e.department||'')}</td>
      <td>${escapeHtml(e.position||'')}</td>
      <td>${escapeHtml(e.email||'')}</td>
      <td>${escapeHtml(e.phone||'')}</td>
      <td>${e.salary?Number(e.salary).toLocaleString():0}</td>
      <td>${escapeHtml(e.hireDate||'')}</td>`;
    reportTableBody.appendChild(tr);
  });

  populatePaymentSelect();
  updateStats();
}

/* ---------- Stats ---------- */
function updateStats(){
  const employees = readEmployees();
  totalEmployeesEl.textContent = employees.length;

  const departments = Array.from(new Set(employees.map(e=>e.department||'Unassigned')));
  totalDepartmentsEl.textContent = departments.length;

  // attendance: try to read records
  const att = safeParse(localStorage.getItem(attendanceKey)) || [];
  let attendanceRate = 0;
  if(Array.isArray(att) && employees.length>0){
    attendanceRate = Math.round(Math.min(100, (att.length / (employees.length * 30)) * 100));
  } else {
    attendanceRate = Math.floor(Math.random()*16)+80; // fallback
  }
  attendanceRateEl.textContent = attendanceRate + '%';

  const totalPayroll = employees.reduce((s,e)=> s + (Number(e.salary)||0), 0);
  totalPayrollEl.textContent = 'GHS ' + totalPayroll.toLocaleString();

  // top department: if performanceData exists use avg scores; else use count
  const perf = safeParse(localStorage.getItem(performanceKey)) || {};
  const deptScores = {};
  for(const e of employees){
    const scores = perf[e.fullName] ? Object.values(perf[e.fullName]).map(Number).filter(n=>!isNaN(n)) : [];
    const avg = scores.length ? scores.reduce((a,b)=>a+b,0)/scores.length : 0;
    if(!deptScores[e.department]) deptScores[e.department] = [];
    deptScores[e.department].push(avg);
  }
  let topDept = 'N/A', best = -1;
  for(const d in deptScores){
    const arr = deptScores[d]; const avg = arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
    if(avg > best){ best = avg; topDept = d; }
  }
  if(topDept === 'N/A' || best === 0){
    // fallback by count
    const counts = {};
    for(const e of employees){ counts[e.department] = (counts[e.department]||0) + 1; }
    let bestCount=0, bestDept='';
    for(const d in counts) if(counts[d] > bestCount){ bestCount = counts[d]; bestDept = d; }
    topDept = bestDept || 'N/A';
    topDepartmentEl.textContent = topDept === 'N/A' ? 'N/A' : `${topDept} (${bestCount} people)`;
  } else topDepartmentEl.textContent = `${topDept} (${best.toFixed(1)}%)`;
}

/* ---------- Payment Portal ---------- */
function populatePaymentSelect(){
  const employees = readEmployees();
  paymentEmployeeSelect.innerHTML = '';
  const placeholder = document.createElement('option'); placeholder.value=''; placeholder.textContent='-- Select Employee --'; paymentEmployeeSelect.appendChild(placeholder);
  employees.forEach((e,i)=>{
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = e.fullName || (e.email || `Employee ${i+1}`);
    paymentEmployeeSelect.appendChild(opt);
  });

  // recent payments
  const payments = safeParse(localStorage.getItem(paymentsKey)) || [];
  recentPaymentsEl.innerHTML = '';
  if(!payments.length) recentPaymentsEl.innerHTML = '<div class="small">No recent payments</div>';
  else payments.slice().reverse().slice(0,10).forEach(p=>{
    const div = document.createElement('div');
    div.style.padding = '6px 6px'; div.style.borderBottom = '1px solid #eef6fb';
    div.innerHTML = `<div class="small">${p.name||'Unknown'} â€” ${formatGHS(p.amount)} <span class="small" style="color:#64748b">(${p.note||''})</span></div><div class="small" style="color:#94a3b8">${new Date(p.date).toLocaleString()}</div>`;
    recentPaymentsEl.appendChild(div);
  });
}

document.getElementById('submitPayment').addEventListener('click', ()=>{
  const idx = paymentEmployeeSelect.value;
  const amount = Number(document.getElementById('paymentAmount').value) || 0;
  const note = document.getElementById('paymentNote').value || '';
  if(idx === '' || amount <= 0){ alert('Choose an employee and a valid amount'); return; }
  const employees = readEmployees();
  const emp = employees[Number(idx)];
  if(!emp){ alert('Employee not found'); return; }
  const payments = safeParse(localStorage.getItem(paymentsKey)) || [];
  const rec = { name: emp.fullName, employeeIndex: Number(idx), amount, note, date: new Date().toISOString() };
  payments.push(rec);
  localStorage.setItem(paymentsKey, JSON.stringify(payments));
  showToast('Payment recorded', 2500);
  populatePaymentSelect();
  updateStats();
});

/* ---------- Attendance chart ---------- */
function drawAttendance(){
  const ctx = document.getElementById('attendanceChart').getContext('2d');
  const att = safeParse(localStorage.getItem(attendanceKey)) || [];
  // Simple simulated last 7 days percent:
  const labels = [];
  const data = [];
  for(let i=6;i>=0;i--){
    const d = new Date(); d.setDate(d.getDate()-i);
    labels.push(d.toLocaleDateString());
    // compute attendance of that day if attendance array stores checkins with date; otherwise random
    const dayCount = (att.filter(a => a.date && new Date(a.date).toDateString() === d.toDateString()).length) || (Math.floor(Math.random()*20)+80);
    data.push(Math.min(100, dayCount));
  }
  if(attendanceChart) attendanceChart.destroy();
  attendanceChart = new Chart(ctx, { type:'line', data:{ labels, datasets:[{label:'Attendance %', data, borderColor:'#0b63a3', backgroundColor:'rgba(11,99,163,0.08)', fill:true, tension:0.3 }] }, options:{responsive:true, scales:{y:{min:0,max:100}}} });
}

/* ---------- Payroll analytics ---------- */
function drawPayrollDept(){
  const ctx = document.getElementById('payrollDeptChart').getContext('2d');
  const employees = readEmployees();
  const map = {};
  employees.forEach(e => { const d = e.department || 'Unassigned'; map[d] = (map[d]||0) + (Number(e.salary)||0); });
  const labels = Object.keys(map);
  const data = Object.values(map);
  if(payrollDeptChart) payrollDeptChart.destroy();
  payrollDeptChart = new Chart(ctx, { type:'pie', data:{labels, datasets:[{data, backgroundColor: labels.map((_,i)=>['#0b63a3','#00a6b6','#ffb74d','#ff7a7a','#9b59b6'][i%5])}]}, options:{responsive:true} });
}

function drawPayrollTrend(){
  const ctx = document.getElementById('payrollTrendChart').getContext('2d');
  // derive monthly payroll totals from payments stored (paymentsKey) or from static salary sums
  const payments = safeParse(localStorage.getItem(paymentsKey)) || [];
  const months = [];
  const values = [];
  for(let m=0;m<12;m++){
    months.push(new Date(2024, m, 1).toLocaleString(undefined, {month:'short'}));
    const total = payments.filter(p => new Date(p.date).getMonth() === m).reduce((s,p)=>s+(Number(p.amount)||0),0);
    values.push(total);
  }
  if(payrollTrendChart) payrollTrendChart.destroy();
  payrollTrendChart = new Chart(ctx, { type:'bar', data:{labels:months, datasets:[{label:'Payments', data:values, backgroundColor:'#0b63a3'}]}, options:{responsive:true} });
}

/* ---------- Department Breakdown ---------- */
function populateDeptSelect(){
  const employees = readEmployees();
  const depts = Array.from(new Set(employees.map(e=>e.department||'Unassigned'))).sort();
  const sel = document.getElementById('deptSelect');
  sel.innerHTML = '';
  depts.forEach(d => { const opt = document.createElement('option'); opt.value = d; opt.textContent = d; sel.appendChild(opt); });
}
document.getElementById('loadDept').addEventListener('click', ()=>{
  const dept = document.getElementById('deptSelect').value;
  const perf = safeParse(localStorage.getItem(performanceKey)) || {};
  const employees = readEmployees().filter(e => (e.department||'Unassigned') === dept);
  const tbodyDept = document.querySelector('#deptTable tbody'); tbodyDept.innerHTML = '';
  let total=0;
  employees.forEach((e,i)=>{
    const scores = perf[e.fullName] ? Object.values(perf[e.fullName]).map(Number).filter(n=>!isNaN(n)) : [];
    const avg = scores.length ? scores.reduce((a,b)=>a+b,0)/scores.length : 0;
    total += avg;
    const tr = document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(e.fullName)}</td><td>${avg?avg.toFixed(1)+'%':'0%'}</td>`; tbodyDept.appendChild(tr);
  });
  const avg = employees.length ? (total/employees.length).toFixed(1) : 0;
  document.getElementById('deptAverage').textContent = `Average Score: ${avg}%`;
});
document.getElementById('downloadDept').addEventListener('click', ()=>{
  const { jsPDF } = window.jspdf; const doc = new jsPDF();
  doc.text('Department Report',14,18);
  const rows = Array.from(document.querySelectorAll('#deptTable tbody tr'));
  let y=38;
  rows.forEach(r=>{ doc.text(Array.from(r.cells).map(c=>c.innerText).join('  |  '),14,y); y+=8; if(y>760){doc.addPage();y=20;} });
  doc.save('department_report.pdf');
});

/* ---------- Report modal controls ---------- */
document.getElementById('openEmployeeReport').addEventListener('click', ()=>{
  reportModal.style.display='flex'; reportModal.setAttribute('aria-hidden','false');
});
document.querySelectorAll('[data-close]').forEach(b=>b.addEventListener('click', (e)=>{ e.target.closest('.modal').style.display='none'; e.target.closest('.modal').setAttribute('aria-hidden','true'); }));

document.getElementById('downloadPdf').addEventListener('click', ()=>{
  const { jsPDF } = window.jspdf; const doc = new jsPDF('l','pt','a4'); doc.setFontSize(14); doc.text('Employee Report',14,20);
  const rows = Array.from(document.querySelectorAll('#reportTable tbody tr'));
  let y = 40;
  rows.forEach(r => { const line = Array.from(r.cells).map(c=>c.innerText).join('  |  '); doc.text(line,14,y); y+=10; if(y>520){doc.addPage(); y=20;} });
  doc.save('employees_report.pdf');
});
document.getElementById('refreshReport').addEventListener('click', ()=> { renderEmployees(); showToast('Data refreshed'); });

/* ---------- Payment modal controls ---------- */
document.getElementById('openPaymentPortal').addEventListener('click', ()=> { paymentModal.style.display='flex'; paymentModal.setAttribute('aria-hidden','false'); populatePaymentSelect(); });
function populatePaymentSelect(){ const employees = readEmployees(); paymentEmployeeSelect.innerHTML = '<option value="">-- Select Employee --</option>'; employees.forEach((e,i)=>{ const o = document.createElement('option'); o.value = i; o.textContent = e.fullName || e.email || `Employee ${i+1}`; paymentEmployeeSelect.appendChild(o); }); const payments = safeParse(localStorage.getItem(paymentsKey)) || []; recentPaymentsEl.innerHTML=''; if(!payments.length) recentPaymentsEl.innerHTML='<div class="small">No payments recorded</div>'; else payments.slice().reverse().slice(0,10).forEach(p=>{ const div=document.createElement('div'); div.style.padding='8px'; div.style.borderBottom='1px solid #eef6fb'; div.innerHTML = `<div class="small">${escapeHtml(p.name)} â€” ${formatGHS(p.amount)}</div><div class="small" style="color:#64748b">${new Date(p.date).toLocaleString()}</div>`; recentPaymentsEl.appendChild(div); }); }

document.getElementById('submitPayment').addEventListener('click', ()=>{
  const idx = paymentEmployeeSelect.value;
  const amount = Number(document.getElementById('paymentAmount').value) || 0;
  const note = document.getElementById('paymentNote').value || '';
  if(idx === '' || amount <= 0){ alert('Select employee and valid amount'); return; }
  const employees = readEmployees(); const emp = employees[Number(idx)];
  if(!emp){ alert('Employee not found'); return; }
  const payments = safeParse(localStorage.getItem(paymentsKey)) || [];
  payments.push({ name: emp.fullName, employeeIndex: Number(idx), amount, note, date: new Date().toISOString() });
  localStorage.setItem(paymentsKey, JSON.stringify(payments));
  showToast('Payment saved');
  populatePaymentSelect();
  updateStats();
});

/* ---------- Attendance & Payroll analytics open ---------- */
document.getElementById('openAttendance').addEventListener('click', ()=> { attendanceModal.style.display='flex'; attendanceModal.setAttribute('aria-hidden','false'); drawAttendance(); });
document.getElementById('refreshAll').addEventListener('click', ()=> { renderEmployees(); drawAttendance(); drawPayrollDept(); drawPayrollTrend(); showToast('Refreshed'); });
document.getElementById('topDeptCard').addEventListener('click', ()=> { departmentModal.style.display='flex'; departmentModal.setAttribute('aria-hidden','false'); populateDeptSelect(); });

document.getElementById('openPaymentPortal').addEventListener('click', () => { populatePaymentSelect(); });

document.getElementById('openAttendance')?.addEventListener('click', () => drawAttendance());
document.getElementById('openPaymentPortal')?.addEventListener('click', () => populatePaymentSelect());
document.getElementById('openEmployeeReport')?.addEventListener('click', () => renderEmployees());

/* ---------- Payroll modals ---------- */
document.getElementById('payrollModal')?.addEventListener('show', ()=>{ drawPayrollDept(); drawPayrollTrend(); });

document.getElementById('exportPdfButton')?.addEventListener('click', ()=>{}); // placeholder

/* ---------- Utilities & sync ---------- */
function showToast(msg, ms=1800){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), ms); }

// delete
function deleteEmployee(i){
  if(!confirm('Delete employee?')) return;
  const arr = readEmployees(); arr.splice(i,1); saveEmployees(arr); renderEmployees(); showToast('Deleted');
}

// open edit (re-use employee add modal)
function openEdit(i){
  const arr = readEmployees(); const e = arr[i];
  if(!e) return;
  // open the modal we used for adding employees earlier (we have employee.html as separate)
  // We'll create a simple edit form overlay here:
  openEditOverlay(i,e);
}

/* ---------- Simple edit overlay (re-using add form behavior) ---------- */
function openEditOverlay(index, emp){
  // Create overlay form programmatically (small modal) to edit
  const overlay = document.createElement('div'); overlay.style.position='fixed'; overlay.style.inset=0; overlay.style.background='rgba(0,0,0,0.6)'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center'; overlay.style.zIndex=1400;
  const box = document.createElement('div'); box.style.background='#fff'; box.style.borderRadius='8px'; box.style.padding='18px'; box.style.width='520px'; box.style.maxHeight='90vh'; box.style.overflow='auto';
  box.innerHTML = `<h3>Edit Employee</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <label>Full Name<input value="${escapeHtml(emp.fullName||'')}" id="edit_fullName"></label>
      <label>Department<input value="${escapeHtml(emp.department||'')}" id="edit_department"></label>
      <label>Position<input value="${escapeHtml(emp.position||'')}" id="edit_position"></label>
      <label>Email<input value="${escapeHtml(emp.email||'')}" id="edit_email"></label>
      <label>Phone<input value="${escapeHtml(emp.phone||'')}" id="edit_phone"></label>
      <label>Salary<input value="${escapeHtml(emp.salary||'')}" id="edit_salary" type="number"></label>
      <label>Hire Date<input value="${escapeHtml(emp.hireDate||'')}" id="edit_hireDate" type="date"></label>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn ghost" id="cancelEdit">Cancel</button>
      <button class="btn" id="saveEdit">Save</button>
    </div>`;
  overlay.appendChild(box); document.body.appendChild(overlay);
  document.getElementById('cancelEdit').addEventListener('click', ()=> overlay.remove());
  document.getElementById('saveEdit').addEventListener('click', ()=>{
    const updated = {
      fullName: document.getElementById('edit_fullName').value,
      department: document.getElementById('edit_department').value,
      position: document.getElementById('edit_position').value,
      email: document.getElementById('edit_email').value,
      phone: document.getElementById('edit_phone').value,
      salary: Number(document.getElementById('edit_salary').value) || 0,
      hireDate: document.getElementById('edit_hireDate').value || ''
    };
    const arr = readEmployees(); arr[index] = Object.assign({}, arr[index], updated); saveEmployees(arr);
    overlay.remove();
    renderEmployees();
    showToast('Employee updated');
  });
}

/* ---------- Populate and draw payroll charts ---------- */
function populateDeptSelect(){
  const employees = readEmployees(); const depts = Array.from(new Set(employees.map(e=> e.department || 'Unassigned'))).sort();
  const s = document.getElementById('deptSelect'); s.innerHTML=''; depts.forEach(d=>{ const o=document.createElement('option'); o.value=d; o.textContent=d; s.appendChild(o); });
}
function drawPayrollDeptChart(){
  const ctx = document.getElementById('payrollDeptChart'); if(!ctx) return;
  const c = ctx.getContext('2d');
  const employees = readEmployees();
  const sums = {};
  employees.forEach(e=>{ const d = e.department || 'Unassigned'; sums[d] = (sums[d]||0) + (Number(e.salary)||0); });
  const labels = Object.keys(sums); const data = Object.values(sums);
  if(payrollDeptChart) payrollDeptChart.destroy();
  payrollDeptChart = new Chart(c, { type:'pie', data:{labels, datasets:[{data, backgroundColor: labels.map((_,i)=>['#0b63a3','#00a6b6','#ffb74d','#ff7a7a','#9b59b6'][i%5])}]}, options:{responsive:true} });
}
function drawPayrollTrendChart(){
  const ctx = document.getElementById('payrollTrendChart'); if(!ctx) return;
  const c = ctx.getContext('2d');
  const payments = safeParse(localStorage.getItem(paymentsKey)) || [];
  const labels = []; const data = [];
  for(let m=0;m<12;m++){
    labels.push(new Date(2024,m,1).toLocaleString(undefined,{month:'short'}));
    const sum = payments.filter(p=> new Date(p.date).getMonth()===m).reduce((s,p)=>s+(Number(p.amount)||0),0);
    data.push(sum);
  }
  if(payrollTrendChart) payrollTrendChart.destroy();
  payrollTrendChart = new Chart(c, { type:'bar', data:{labels, datasets:[{label:'Payments', data, backgroundColor:'#0b63a3'}]}, options:{responsive:true} });
}

/* ---------- Initial load ---------- */
renderEmployees();
drawAttendance();
drawPayrollDeptChart();
drawPayrollTrendChart();
populateDeptSelect();

/* ---------- Live sync ---------- */
window.addEventListener('storage', (e)=>{ if(['employees','payments','performanceData','attendance'].includes(e.key)){ renderEmployees(); drawAttendance(); drawPayrollDeptChart(); drawPayrollTrendChart(); populateDeptSelect(); } });
// polling fallback (same-tab updates)
let lastEmployeesSnapshot = localStorage.getItem(employeesKey) || '';
setInterval(()=>{ const curr = localStorage.getItem(employeesKey)||''; if(curr !== lastEmployeesSnapshot){ lastEmployeesSnapshot = curr; renderEmployees(); drawAttendance(); drawPayrollDeptChart(); drawPayrollTrendChart(); populateDeptSelect(); } }, 3000);

/* ---------- small utility: open new employee add page if you have employee.html hosted separately ---------- */
/* If you use the employee.html to add employees, it writes to localStorage.employees â€” this dashboard will pick them up automatically. */

</script>
  <script>
// PROTECT HR DASHBOARD
if (!localStorage.getItem("hr_logged_in")) {
    window.location.href = "login.html";
}
</script>
<script>
function logout() {
    localStorage.removeItem("hr_logged_in");
    window.location.href = "login.html";
}
  
// HR Accounts management (requires window.__HR_SESSION set by auth check)
(async function(){
  if(!window.__HR_SESSION) return;
  // show manage button only for Admins
  if(window.__HR_SESSION.role !== 'Admin') return;

  // create a small Manage Accounts button in header
  const hdr = document.querySelector('header');
  if(hdr){
    const btn = document.createElement('button');
    btn.className='btn ghost';
    btn.style.marginLeft='12px';
    btn.textContent = 'Manage HR Accounts';
    btn.onclick = ()=> document.getElementById('hrAccountsModal').style.display='flex';
    hdr.appendChild(btn);
  }

  // utility hash
  async function sha256Hex(str){
    const enc = new TextEncoder(), buf = enc.encode(str);
    const h = await crypto.subtle.digest('SHA-256', buf);
    return Array.from(new Uint8Array(h)).map(b => b.toString(16).padStart(2,'0')).join('');
  }

  // elements
  const modal = document.getElementById('hrAccountsModal');
  const closeBtns = modal.querySelectorAll('[data-close-hr]');
  closeBtns.forEach(b=> b.addEventListener('click', ()=> modal.style.display='none'));

  const nameEl = document.getElementById('acct_name');
  const emailEl = document.getElementById('acct_email');
  const passEl = document.getElementById('acct_password');
  const roleEl = document.getElementById('acct_role');
  const saveBtn = document.getElementById('acctSaveBtn');
  const clearBtn = document.getElementById('acctClearBtn');
  const listBody = document.getElementById('acctList');

  let editingIndex = -1;

  function readAccounts(){ try{ return JSON.parse(localStorage.getItem('hr_accounts'))||[] }catch(e){ return [] } }
  function saveAccounts(a){ localStorage.setItem('hr_accounts', JSON.stringify(a)); }

  function refreshList(){
    const arr = readAccounts();
    listBody.innerHTML = '';
    arr.forEach((a,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${a.name||''}</td><td>${a.email||''}</td><td>${a.role||''}</td><td style="text-align:right">
        <button class="btn ghost" data-edit="${i}">Edit</button>
        <button class="btn" data-del="${i}">Delete</button></td>`;
      listBody.appendChild(tr);
    });
    // wire buttons
    listBody.querySelectorAll('[data-edit]').forEach(b=> b.addEventListener('click', e=>{
      const idx = Number(e.currentTarget.getAttribute('data-edit'));
      const a = readAccounts()[idx];
      editingIndex = idx;
      nameEl.value = a.name || '';
      emailEl.value = a.email || '';
      passEl.value = ''; // do not prefill hash
      roleEl.value = a.role || 'HR Manager';
    }));
    listBody.querySelectorAll('[data-del]').forEach(b=> b.addEventListener('click', e=>{
      const idx = Number(e.currentTarget.getAttribute('data-del'));
      if(!confirm('Delete this HR account?')) return;
      const arr = readAccounts(); arr.splice(idx,1); saveAccounts(arr); refreshList();
      alert('Account deleted.');
    }));
  }

  clearBtn.addEventListener('click', ()=>{ editingIndex = -1; nameEl.value=''; emailEl.value=''; passEl.value=''; roleEl.value='HR Manager'; });

  saveBtn.addEventListener('click', async ()=>{
    const name = nameEl.value.trim(); const email = emailEl.value.trim().toLowerCase();
    const pw = passEl.value; const role = roleEl.value;
    if(!name || !email){ alert('Name and email required'); return; }
    let arr = readAccounts();
    if(editingIndex >= 0){
      // update
      arr[editingIndex].name = name;
      arr[editingIndex].email = email;
      arr[editingIndex].role = role;
      if(pw) arr[editingIndex].passwordHash = await sha256Hex(pw);
      saveAccounts(arr);
      alert('Account updated.');
    } else {
      if(!pw){ alert('Password required for new accounts'); return; }
      // ensure unique email
      if(arr.some(a=>a.email === email)){ alert('Email already used'); return; }
      const hash = await sha256Hex(pw);
      arr.push({ name, email, role, passwordHash: hash });
      saveAccounts(arr);
      alert('Account created.');
    }
    editingIndex = -1; nameEl.value=''; emailEl.value=''; passEl.value=''; roleEl.value='HR Manager';
    refreshList();
  });

  refreshList();
})();

</script>
  <button class="btn ghost" onclick="logoutHR()">Logout</button>
<script>
function logoutHR(){
  localStorage.removeItem('hr_session');
  window.location.href = 'login.html';
}
  let hrAccounts = JSON.parse(localStorage.getItem("hrAccounts")) || [];

document.getElementById("hrAccountForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const name = document.getElementById("hrName").value.trim();
    const email = document.getElementById("hrEmail").value.trim();
    const password = document.getElementById("hrPassword").value.trim();
    const role = document.getElementById("hrRole").value;

    if (!name || !email || !password) {
        alert("Please fill all fields.");
        return;
    }

    // Check if email already exists
    const exists = hrAccounts.some(acc => acc.email === email);
    if (exists) {
        alert("This email already exists!");
        return;
    }

    hrAccounts.push({ name, email, password, role });
    localStorage.setItem("hrAccounts", JSON.stringify(hrAccounts));

    alert("HR Account saved successfully!");

    loadHRAccounts();
    e.target.reset();
});

// Load accounts
function loadHRAccounts() {
    const table = document.getElementById("hrAccountsList");
    table.innerHTML = "";

    hrAccounts.forEach((acc, index) => {
        table.innerHTML += `
            <tr>
                <td>${acc.name}</td>
                <td>${acc.email}</td>
                <td>${acc.role}</td>
                <td><button onclick="deleteHRAccount(${index})">Delete</button></td>
            </tr>
        `;
    });
}

// Delete account
function deleteHRAccount(i) {
    if (confirm("Delete this HR Account?")) {
        hrAccounts.splice(i, 1);
        localStorage.setItem("hrAccounts", JSON.stringify(hrAccounts));
        loadHRAccounts();
    }
}

</script>

<!-- Manage HR Accounts (Admin only) -->
<div id="hrAccountsModal" class="modal" style="display:none">
  <div class="box" style="max-width:760px">
    <button class="close" data-close-hr>&times;</button>
    <h3>Manage HR Accounts</h3>
    <div style="display:flex;gap:12px;margin-top:12px">
      <div style="flex:1">
        <div style="margin-bottom:8px">
          <label>Full name</label>
          <input id="acct_name" type="text" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6f2fa">
        </div>
        <div style="margin-bottom:8px">
          <label>Email</label>
          <input id="acct_email" type="email" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6f2fa">
        </div>
        <div style="margin-bottom:8px">
          <label>Password</label>
          <input id="acct_password" type="password" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6f2fa">
        </div>
        <div style="margin-bottom:8px">
          <label>Role</label>
          <select id="acct_role" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6f2fa">
            <option>Admin</option>
            <option>HR Manager</option>
            <option>Payroll Officer</option>
            <option>Supervisor</option>
          </select>
        </div>
        <div style="display:flex;gap:8px">
          <button id="acctSaveBtn" class="btn">Save</button>
          <button id="acctClearBtn" class="btn ghost">Clear</button>
        </div>
      </div>

      <div style="width:40%;max-height:360px;overflow:auto;border-left:1px solid #eef6fb;padding-left:12px">
        <h4>Existing Accounts</h4>
        <table style="width:100%;border-collapse:collapse">
          <thead><tr><th style="text-align:left">Name</th><th style="text-align:left">Email</th><th style="text-align:left">Role</th><th></th></tr></thead>
          <tbody id="acctList"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<button class="btn btn-primary" onclick="saveHRAccount()">Save</button>

</body>
</html>
