<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Flawless Graphics â€” HR Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root{--bg:#f4f7fb;--card:#fff;--accent:#003366;--accent2:#0077cc;--muted:#6b7a89}
  .dark{--bg:#071027;--card:#0f1b2b;--accent:#00d1ff;--accent2:#7a00ff;--muted:#9fb4c9;color:#e8f6ff}
  *{box-sizing:border-box;font-family:Poppins,system-ui,Arial}
  body{margin:0;background:var(--bg);color:var(--muted);transition:background .2s,color .2s}
  header{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;padding:16px;display:flex;align-items:center;justify-content:space-between}
  header h1{margin:0;font-size:18px}
  .wrap{max-width:1200px;margin:18px auto;padding:12px}
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px}
  .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  .card h3{margin:0 0 8px 0;color:var(--accent)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
  thead th{position:sticky;top:0;background:var(--accent);color:#fff}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--muted)}
  .flex{display:flex;gap:12px;align-items:center}
  #activityFeed{max-height:180px;overflow:auto}
  .right-col{width:350px}
  .layout{display:flex;gap:12px}
  .left{flex:1}
  .notif-bell{position:relative;cursor:pointer}
  .notif-count{position:absolute;top:-6px;right:-6px;background:#e53935;color:#fff;border-radius:999px;padding:3px 7px;font-size:12px}
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:2000}
  .modal .box{width:100%;max-width:640px;background:var(--card);padding:16px;border-radius:10px}
  .toast{position:fixed;right:20px;bottom:24px;background:#222;color:#fff;padding:10px 14px;border-radius:8px;opacity:0;transform:translateY(10px);transition:all .28s}
  .toast.show{opacity:1;transform:none}
  @media(max-width:900px){ .kpis{grid-template-columns:repeat(2,1fr)} .layout{flex-direction:column} .right-col{width:100%} }
</style>
</head>
<body>
<header>
  <h1>FLAWLESS GRAPHICS â€” HR Dashboard</h1>
  <div class="flex">
    <div class="notif-bell" id="notifBell" title="Notifications">
      ðŸ”” <span id="notifCount" class="notif-count" style="display:none">0</span>
    </div>
    <button class="btn" id="addEmpBtn">+ Add Employee</button>
    <button class="btn" id="exportBtn">Export Org</button>
    <button class="btn ghost" id="toggleTheme">Theme</button>
  </div>
</header>

<div class="wrap">
  <div class="kpis">
    <div class="card"><h3>Employees</h3><div id="k_employees" style="font-size:22px;font-weight:700">0</div></div>
    <div class="card"><h3>Departments</h3><div id="k_departments" style="font-size:22px;font-weight:700">0</div></div>
    <div class="card"><h3>Attendance Rate</h3><div id="k_attendance" style="font-size:22px;font-weight:700">0%</div></div>
    <div class="card"><h3>Total Payroll (GHS)</h3><div id="k_payroll" style="font-size:22px;font-weight:700">0</div></div>
  </div>

  <div class="layout">
    <div class="left">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3>Employee Directory</h3>
          <div class="controls">
            <input id="searchEmp" placeholder="Search name/department/position" style="padding:8px;border-radius:8px;border:1px solid #ddd">
            <select id="deptFilter" style="padding:8px;border-radius:8px;border:1px solid #ddd">
              <option value="">All Depts</option>
            </select>
            <button class="btn ghost" id="toggleView">Cards</button>
          </div>
        </div>

        <div id="tableWrap" style="margin-top:12px">
          <table id="empTable" style="background:white">
            <thead>
              <tr><th>#</th><th>Full Name</th><th>Dept</th><th>Pos</th><th>Email</th><th>Phone</th><th>Salary</th><th>Hired</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div style="margin-top:12px" class="card">
        <h3>Activity Feed</h3>
        <div id="activityFeed"></div>
      </div>
    </div>

    <div class="right-col">
      <div class="card">
        <h3>Payroll / Payslip</h3>
        <div>
          <select id="paySelect" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd">
            <option value="">-- Select employee --</option>
          </select>
          <input id="payAmount" type="number" placeholder="Amount (GHS)" style="width:100%;margin-top:8px;padding:8px;border-radius:8px;border:1px solid #ddd">
          <input id="payNote" placeholder="Note (optional)" style="width:100%;margin-top:8px;padding:8px;border-radius:8px;border:1px solid #ddd">
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" id="recordPay">Record Payment</button>
            <button class="btn ghost" id="downloadPay">Download Last Payslip</button>
          </div>
        </div>
      </div>

      <div style="margin-top:12px" class="card">
        <h3>Notifications</h3>
        <div id="notifList" style="max-height:200px;overflow:auto"></div>
        <div style="margin-top:8px;display:flex;gap:8px"><button class="btn ghost" id="clearNotifs">Clear</button></div>
      </div>

      <div style="margin-top:12px" class="card">
        <h3>Attendance Chart (30 days)</h3>
        <canvas id="attChart" height="140"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Employee Modal -->
<div class="modal" id="empModal"><div class="box card">
  <h3 id="empModalTitle">Add Employee</h3>
  <form id="empForm">
    <input id="e_fullName" placeholder="Full name" required style="width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ddd">
    <input id="e_email" type="email" placeholder="Email" style="width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ddd">
    <input id="e_phone" placeholder="Phone" style="width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ddd">
    <input id="e_department" placeholder="Department" style="width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ddd">
    <input id="e_position" placeholder="Position" style="width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ddd">
    <input id="e_salary" type="number" placeholder="Salary (monthly)" style="width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ddd">
    <input id="e_hireDate" type="date" style="width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ddd">
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn" type="submit">Save</button>
      <button class="btn ghost" type="button" id="cancelEmp">Cancel</button>
    </div>
    <input type="hidden" id="editIndex">
  </form>
</div></div>

<div id="toast" class="toast"></div>

<script>
/* ---------- Storage Keys ---------- */
const ORG = localStorage.getItem('active_org') || 'FLAWLESS_GRAPHICS';
const EMP_KEY = `${ORG}_employees`;
const PAY_KEY = `${ORG}_payments`;
const ATT_KEY = `${ORG}_teacher_attendance`;
const NOTIF_KEY = `${ORG}_notifications`;

/* ---------- Utilities ---------- */
function read(k){ try{ return JSON.parse(localStorage.getItem(k))||[] }catch(e){return []} }
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)) }
function toast(msg){ const el=document.getElementById('toast'); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),2600) }

/* ---------- Init ---------- */
let employees = read(EMP_KEY);
let payments = read(PAY_KEY);
let notifications = read(NOTIF_KEY);
let attData = read(ATT_KEY);
const empTbody = document.querySelector('#empTable tbody');
const paySelect = document.getElementById('paySelect');

function pushNotif(text){
  const n = { id:Date.now(), text, date: new Date().toISOString() };
  notifications.unshift(n);
  save(NOTIF_KEY, notifications);
  renderNotifs();
  updateNotifCount();
}

/* ---------- Render ---------- */
function renderEmployees(list = employees){
  empTbody.innerHTML = '';
  employees = list;
  employees.forEach((e,i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${e.fullName}</td><td>${e.department||''}</td><td>${e.position||''}</td>
      <td>${e.email||''}</td><td>${e.phone||''}</td><td>GHS ${Number(e.salary||0).toLocaleString()}</td><td>${e.hireDate||''}</td>
      <td>
        <button class="btn" onclick="editEmployee(${i})">Edit</button>
        <button class="btn ghost" onclick="deleteEmployee(${i})">Delete</button>
      </td>`;
    empTbody.appendChild(tr);
  });
  populateDeptFilter();
  populatePaySelect();
  updateKPIs();
}

function populateDeptFilter(){
  const sel = document.getElementById('deptFilter');
  const depts = [...new Set(employees.map(e=>e.department).filter(Boolean))];
  sel.innerHTML = '<option value="">All Depts</option>'+depts.map(d=>`<option value="${d}">${d}</option>`).join('');
}

function populatePaySelect(){
  paySelect.innerHTML = '<option value="">-- Select employee --</option>';
  employees.forEach((e,i)=> paySelect.innerHTML += `<option value="${i}">${e.fullName} â€” GHS ${Number(e.salary||0).toLocaleString()}</option>`);
}

/* ---------- KPIs ---------- */
function updateKPIs(){
  document.getElementById('k_employees').textContent = employees.length;
  document.getElementById('k_departments').textContent = [...new Set(employees.map(e=>e.department).filter(Boolean))].length;
  // attendance rate: percent of days with any "in" records over recent 30 days vs employees count (simplified)
  const last30 = attData.filter(a => (Date.now() - new Date(a.date).getTime()) < 30*24*3600*1000 && a.action === 'in');
  const presentUnique = new Set(last30.map(a=>a.employeeIndex));
  const rate = employees.length ? Math.round((presentUnique.size / employees.length)*100) : 0;
  document.getElementById('k_attendance').textContent = rate + '%';
  const totalPayroll = employees.reduce((s,e)=>s + Number(e.salary||0),0);
  document.getElementById('k_payroll').textContent = 'GHS ' + totalPayroll.toLocaleString();
}

/* ---------- Activity feed ---------- */
function renderActivity(){
  const feed = document.getElementById('activityFeed');
  const recent = [...(read(ATT_KEY) || [])].slice().reverse().slice(0,50);
  const pay = read(PAY_KEY).slice().reverse().slice(0,20);
  let items = [];
  recent.forEach(r => {
    const name = (employees[r.employeeIndex]||{}).fullName || `Employee #${r.employeeIndex}`;
    items.push(`${new Date(r.date).toLocaleString()} â€¢ ${name} â€¢ ${r.action.toUpperCase()}`);
  });
  pay.forEach(p => items.push(`${new Date(p.date).toLocaleString()} â€¢ Payment: ${p.name} â€¢ GHS ${p.amount}`));
  if(!items.length) feed.innerHTML = '<div style="color:var(--muted)">No activity yet</div>';
  else feed.innerHTML = items.map(i=>`<div style="padding:6px 0;border-bottom:1px dashed #eee">${i}</div>`).join('');
}

/* ---------- Notifications ---------- */
function renderNotifs(){
  const wrap = document.getElementById('notifList');
  wrap.innerHTML = notifications.length ? notifications.map(n=>`<div style="padding:8px 0;border-bottom:1px solid #eee">${n.text}<div style="font-size:12px;color:#888">${new Date(n.date).toLocaleString()}</div></div>`).join('') : '<div style="color:var(--muted)">No notifications</div>';
}
function updateNotifCount(){
  const el = document.getElementById('notifCount');
  if(notifications.length){ el.style.display='inline-block'; el.textContent = notifications.length } else el.style.display='none';
}

/* ---------- CRUD ---------- */
document.getElementById('addEmpBtn').addEventListener('click', ()=> {
  document.getElementById('empModalTitle').textContent = 'Add Employee';
  document.getElementById('editIndex').value = '';
  document.getElementById('empForm').reset();
  document.getElementById('empModal').style.display = 'flex';
});

document.getElementById('cancelEmp').addEventListener('click', ()=> document.getElementById('empModal').style.display='none');

document.getElementById('empForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const idx = document.getElementById('editIndex').value;
  const obj = {
    fullName:document.getElementById('e_fullName').value.trim(),
    email:document.getElementById('e_email').value.trim(),
    phone:document.getElementById('e_phone').value.trim(),
    department:document.getElementById('e_department').value.trim(),
    position:document.getElementById('e_position').value.trim(),
    salary: Number(document.getElementById('e_salary').value) || 0,
    hireDate: document.getElementById('e_hireDate').value || ''
  };
  if(idx===''){
    employees.push(obj);
    pushNotif(`New employee added: ${obj.fullName}`);
    toast('Employee added');
  } else {
    employees[Number(idx)] = obj;
    pushNotif(`Employee updated: ${obj.fullName}`);
    toast('Employee updated');
  }
  save(EMP_KEY, employees);
  renderEmployees();
  document.getElementById('empModal').style.display='none';
});

/* expose edit/delete for in-row buttons */
window.editEmployee = function(i){
  const e = employees[i];
  document.getElementById('empModalTitle').textContent = 'Edit Employee';
  document.getElementById('e_fullName').value = e.fullName || '';
  document.getElementById('e_email').value = e.email || '';
  document.getElementById('e_phone').value = e.phone||'';
  document.getElementById('e_department').value = e.department||'';
  document.getElementById('e_position').value = e.position||'';
  document.getElementById('e_salary').value = e.salary||'';
  document.getElementById('e_hireDate').value = e.hireDate||'';
  document.getElementById('editIndex').value = i;
  document.getElementById('empModal').style.display='flex';
};

window.deleteEmployee = function(i){
  if(!confirm('Delete employee?')) return;
  const removed = employees.splice(i,1)[0];
  save(EMP_KEY, employees);
  pushNotif(`Employee removed: ${removed.fullName}`);
  renderEmployees();
};

/* ---------- Search / Filter ---------- */
document.getElementById('searchEmp').addEventListener('input',(e)=>{
  const q = e.target.value.toLowerCase();
  renderEmployees(read(EMP_KEY).filter(emp => (emp.fullName||'').toLowerCase().includes(q) || (emp.department||'').toLowerCase().includes(q) || (emp.position||'').toLowerCase().includes(q)));
});
document.getElementById('deptFilter').addEventListener('change',(e)=>{
  const v = e.target.value;
  renderEmployees(v ? read(EMP_KEY).filter(emp => emp.department === v) : read(EMP_KEY));
});

/* ---------- Payroll ---------- */
document.getElementById('recordPay').addEventListener('click', ()=>{
  const idx = paySelect.value;
  if(idx==='') return alert('Select employee');
  const amount = Number(document.getElementById('payAmount').value) || 0;
  const note = document.getElementById('payNote').value.trim();
  if(amount<=0) return alert('Enter amount');
  const emp = employees[Number(idx)];
  const p = { id:Date.now(), name: emp.fullName, employeeIndex: Number(idx), amount, note, date: new Date().toISOString() };
  payments.unshift(p);
  save(PAY_KEY, payments);
  localStorage.setItem(`${ORG}_last_payslip`, JSON.stringify(p));
  pushNotif(`Payroll recorded: ${emp.fullName} â€” GHS ${amount}`);
  toast('Payment recorded');
  document.getElementById('payAmount').value='';
  document.getElementById('payNote').value='';
  renderActivity();
});

document.getElementById('downloadPay').addEventListener('click', ()=>{
  const last = JSON.parse(localStorage.getItem(`${ORG}_last_payslip`) || 'null');
  if(!last) return alert('No payslip available');
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(16); doc.text('Flawless Graphics â€” Payslip',20,20);
  doc.setFontSize(12); doc.text(`Name: ${last.name}`,20,40); doc.text(`Amount: GHS ${last.amount}`,20,55);
  doc.text(`Date: ${new Date(last.date).toLocaleString()}`,20,70); if(last.note) doc.text(`Note: ${last.note}`,20,85);
  doc.save(`payslip_${last.name.replace(/\s+/g,'_')}.pdf`);
});

/* ---------- Exports ---------- */
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const data = { employees: read(EMP_KEY), payments: read(PAY_KEY), attendance: read(ATT_KEY), notifications: read(NOTIF_KEY) };
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${ORG}_export_${Date.now()}.json`; a.click();
  toast('Export saved');
});

/* ---------- Notification UI ---------- */
document.getElementById('notifBell').addEventListener('click', ()=> {
  const modal = document.getElementById('empModal');
  // quick notifications drawer: use alert style for simplicity
  const list = read(NOTIF_KEY);
  alert((list.length ? list.map(n=>`${new Date(n.date).toLocaleString()} â€” ${n.text}`).join('\n\n') : 'No notifications'));
});

/* ---------- Attendance Chart ---------- */
let attChart = null;
function drawAttChart(){
  const counts = {};
  const now = Date.now();
  for(let i=29;i>=0;i--){
    const d = new Date(now - i*24*3600*1000);
    const key = d.toISOString().split('T')[0];
    counts[key]=0;
  }
  (read(ATT_KEY)||[]).forEach(a=>{
    if(a.action==='in'){
      const day = a.date.split('T')[0];
      if(counts.hasOwnProperty(day)) counts[day] += 1;
    }
  });
  const labels = Object.keys(counts);
  const data = labels.map(k=>counts[k]);
  const ctx = document.getElementById('attChart').getContext('2d');
  if(attChart) attChart.destroy();
  attChart = new Chart(ctx,{ type:'bar', data:{ labels, datasets:[{label:'Clock-ins', backgroundColor:'#0077cc', data}] }, options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}} }});
}

/* ---------- Respond to storage changes (cross-window sync) ---------- */
window.addEventListener('storage', (e)=>{
  if(e.key && e.key.startsWith(ORG)){
    employees = read(EMP_KEY);
    payments = read(PAY_KEY);
    notifications = read(NOTIF_KEY);
    attData = read(ATT_KEY);
    renderEmployees();
    renderNotifs();
    renderActivity();
    drawAttChart();
    updateNotifCount();
  }
});

/* ---------- Initial render ---------- */
employees = read(EMP_KEY);
payments = read(PAY_KEY);
notifications = read(NOTIF_KEY);
attData = read(ATT_KEY);
renderEmployees();
renderNotifs();
renderActivity();
drawAttChart();
updateNotifCount();

/* set theme from storage */
if(localStorage.getItem('fg_theme_dark')==='true') document.documentElement.classList.add('dark');
document.getElementById('toggleTheme').addEventListener('click', ()=>{
  const now = document.documentElement.classList.toggle('dark');
  localStorage.setItem('fg_theme_dark', now ? 'true' : 'false');
});

/* quick auto-update on page */
setInterval(()=>{ employees = read(EMP_KEY); renderEmployees(); renderActivity(); drawAttChart(); }, 30000);
</script>
</body>
</html>
