<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flawless Graphics â€” Students Portal</title>

  <!-- Fonts + Libraries -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{
      --nav:#003366; --accent:#0b63a3; --muted:#6b7c93; --bg:#f5f8fb;
      --card-from:#0b63a3; --card-to:#00a6b6;
    }
    *{box-sizing:border-box}
    body{font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto; margin:0; background:var(--bg); color:#102730}
    header{background:var(--nav); color:#fff; padding:18px 20px; display:flex; gap:12px; align-items:center}
    header .logo{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--card-from),var(--card-to));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    header h1{font-size:18px;margin:0}

    .container{max-width:1200px;margin:28px auto;padding:18px;background:#fff;border-radius:10px;box-shadow:0 6px 20px rgba(10,20,40,0.06)}
    .top-bar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .left-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .right-controls{display:flex;gap:10px;align-items:center}
    .search-bar input{padding:8px 12px;border-radius:8px;border:1px solid #d8e6f1;min-width:260px}
    .btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid #d8e6f1}
    .btn:active{transform:translateY(1px)}
    .controls {display:flex; gap:8px; align-items:center; flex-wrap:wrap}

    .stats-row{display:flex;gap:12px;margin-top:18px;flex-wrap:wrap}
    .stat{background:linear-gradient(135deg,var(--card-from),var(--card-to));color:#fff;padding:14px;border-radius:10px;min-width:160px;text-align:center;box-shadow:0 10px 22px rgba(10,20,40,0.06)}
    .stat h3{margin:0;font-size:22px}
    .stat p{margin:4px 0 0;font-size:13px;opacity:0.95}

    table{width:100%;border-collapse:collapse;margin-top:18px;background:#fff}
    thead th{position:sticky;top:0;background:var(--nav);color:#fff;padding:12px;text-align:left;z-index:4}
    th, td{padding:10px;border-bottom:1px solid #eef4fb;vertical-align:middle}
    td img.avatar{width:46px;height:46px;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 6px 16px rgba(12,24,48,0.08)}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#e8f1fb;color:var(--nav);font-weight:600;font-size:13px}
    .badge.it{background:linear-gradient(90deg,#d9eefc,#d6f5f8);color:#0b63a3}
    .badge.finance{background:linear-gradient(90deg,#e8f7ec,#e6fbe6);color:#1b8a2a}
    .badge.hr{background:linear-gradient(90deg,#f0e8fb,#f6ecfb);color:#7b43c3}
    .badge.safety{background:linear-gradient(90deg,#fff4e6,#fff6ea);color:#a86f00}
    .badge.admin{background:linear-gradient(90deg,#f0f2f4,#f8fafc);color:#546069}

    .cards-view{display:none;margin-top:18px;gap:18px;flex-wrap:wrap;display:flex}
    .employee-card{width:260px;padding:14px;border-radius:10px;background:#fff;border:1px solid #eef5fb;box-shadow:0 10px 26px rgba(7,22,40,0.04);transition:transform .18s}
    .employee-card:hover{transform:translateY(-6px)}
    .employee-card img{width:64px;height:64px;border-radius:50%;object-fit:cover;display:block;margin-bottom:8px}

    .actions img{width:20px;cursor:pointer;margin-right:8px;opacity:0.92}
    .actions img:hover{transform:scale(1.08)}

    /* modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(5,10,20,0.55);z-index:1200;align-items:center;justify-content:center;padding:18px}
    .modal .box{background:#fff;border-radius:10px;padding:18px;max-width:680px;width:100%;position:relative;box-shadow:0 20px 60px rgba(7,20,40,0.3)}
    .close{position:absolute;right:14px;top:12px;border:none;background:transparent;font-size:20px;cursor:pointer;color:#465d6f}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .form-grid.full{grid-template-columns:1fr}
    .form-row{display:flex;flex-direction:column;gap:6px;margin-bottom:8px}
    input[type="file"]{padding:6px}

    /* file preview */
    .avatar-preview{width:86px;height:86px;border-radius:12px;background:#f1f6fa;display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px dashed #dbeaf7}

    /* small */
    .small{font-size:13px;color:var(--muted)}

    /* toast */
    #toast-container{position:fixed;bottom:22px;right:22px;z-index:1600;display:flex;flex-direction:column;gap:8px}
    .toast{background:#111;color:#fff;padding:12px 16px;border-radius:10px;box-shadow:0 10px 30px rgba(10,20,30,0.2);transform:translateX(120%);opacity:0;transition:0.45s}
    .toast.show{transform:translateX(0);opacity:1}

    /* small screens */
    @media (max-width:900px){
      .form-grid{grid-template-columns:1fr}
      .stats-row{flex-direction:column}
      .search-bar input{min-width:120px;width:100%}
      header h1{font-size:16px}
      .employee-card{width:100%}
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">FG</div>
    <div>
      <h1>FLAWLESS GRAPHICS Â· Students Portal</h1>
      <div class="small">Manage Students profiles, attendance and payroll-ready data</div>
    </div>
  </header>

  <div class="container">
    <div class="top-bar">
      <div class="left-controls">
        <button class="btn" id="addStudentsBtn">+ Add Student</button>
        <button class="btn ghost" id="toggleViewBtn">Switch to Cards View</button>

        <div style="margin-left:8px">
          <select id="sortSelect" class="small" title="Sort">
            <option value="default">Sort: Default</option>
            <option value="name">Name A â†’ Z</option>
            <option value="Class">Class</option>
            <option value="reportingDate">Date Reported (old â†’ new)</option>
          </select>
        </div>
      </div>

      <div class="right-controls">
        <div class="search-bar">
          <input id="searchInput" placeholder="Search by name, phone, salary, class or position...">
        </div>

        <div style="display:flex; gap:8px; align-items:center; margin-left:6px">
          <button class="btn" id="exportCsvBtn">Export CSV</button>
          <button class="btn" id="exportXlsxBtn">Export XLSX</button>
          <button class="btn" id="exportPdfBtn">Export PDF</button>
        </div>
      </div>
    </div>

    <div class="stats-row" style="margin-top:18px">
      <div class="stat"><h3 id="statStudents">0</h3><p>Total Students</p></div>
      <div class="stat"><h3 id="statClass">0</h3><p>Class</p></div>
      <div class="stat"><h3 id="statAttendance">0%</h3><p>Attendance Rate</p></div>
      <div class="stat"><h3 id="statPayroll">$0</h3><p>Total Payroll</p></div>
      <div class="stat clickable" id="topDeptCard" style="cursor:pointer"><h3 id="statTopDept">N/A</h3><p>Top Performing Dept</p></div>
    </div>

    <!-- Table -->
    <table id="StudentsTable" style="margin-top:18px">
      <thead>
        <tr>
          <th>#</th>
          <th>Photo</th>
          <th>Full Name</th>
          <th>Class</th>
          <th>Guardian</th>
          <th>Relationship</th>
          <th>Phone</th>
          <th>Date of Birth</th>
          <th>Date Reported</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Cards view -->
    <div id="StudentsCards" class="cards-view"></div>
  </div>

  <!-- Modal: Add / Edit -->
  <div class="modal" id="StudentsModal" aria-hidden="true">
    <div class="box">
      <button class="close" id="closeModalBtn" aria-label="Close">&times;</button>
      <h3 id="modalTitle">Add Student</h3>

      <form id="StudentsForm" style="margin-top:12px">
        <input type="hidden" id="editIndex" value="">

        <div style="display:flex;gap:12px;align-items:flex-start">
          <div style="flex:1">
            <div class="form-row">
              <label>Full Name</label>
              <input type="text" id="fullName" required>
            </div>

            <div class="form-row">
              <label>Cass</label>
              <select id="Class" required>
                <option value="">-- Select Class --</option>
                <option value="Nursary">Nursary</option>
                <option value="KG">KG</option>
                <option value="Class One">Class One</option>
                <option value="Class Two">Class Two</option>
                <option value="Class Three">Class Three</option>
                <option value="Class Four">Class Four</option>
                <option value="Class Five">Class Five</option>
                <option value="Class Six">Class Six</option>
                <option value="Form One">Form One</option>
                <option value="Form Two">Form Two</option>
                <option value="Form Three">Form Three</option>
                <option value="SHS One">SHS One</option>
                <option value="SHS Two">SHS Two</option>
                <option value="SHS Three">SHS Three</option>
              </select>
            </div>

            <div class="form-row">
              <label>Position</label>
              <input type="text" id="position">
            </div>

            <div class="form-row">
              <label>Guardian</label>
              <input type="text" id="email">
            </div>

            <div class="form-row">
              <label>Phone</label>
              <input type="tel" id="phone">
            </div>

            <div class="form-row">
              <label>Relationship</label>
              <input type="text" id="salary">
            </div>

            <div class="form-row">
              <label>Date Of Birth</label>
              <input type="date" id="DOB">
            </div>

            <div class="form-row">
              <label>Date Reported</label>
              <input type="date" id="ReportedDate">
            </div>
          </div>

          <div style="width:140px;display:flex;flex-direction:column;gap:10px;align-items:center">
            <div class="avatar-preview" id="avatarPreview">
              <img id="avatarPreviewImg" src="" alt="" style="display:none;width:100%;height:100%;object-fit:cover">
              <div id="avatarPlaceholder" style="font-size:12px;color:#6b7c93">No Photo</div>
            </div>
            <input type="file" id="photoInput" accept="image/*">
            <div class="small">Profile photo (optional). Images are stored locally.</div>
            <div style="margin-top:auto">
              <button class="btn" type="submit">Save Student</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Class Modal (Top Class -> breakdown) -->
  <div class="modal" id="ClassModal" aria-hidden="true">
    <div class="box">
      <button class="close" data-close-Class>&times;</button>
      <h3>Class Performance / Breakdown</h3>

      <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
        <label style="display:block">
          <small>Select Class</small><br>
          <select id="ClassSelect"></select>
        </label>
        <button class="btn" id="loadClassBtn">Load</button>
        <button class="btn" id="downloadClassPdf">Download PDF</button>
      </div>

      <table id="deptTable" style="margin-top:10px">
        <thead><tr><th>#</th><th>Students</th><th>Avg Score</th></tr></thead>
        <tbody></tbody>
      </table>

      <h4 id="ClassAvg" style="margin-top:12px">Average Score: 0%</h4>
    </div>
  </div>

  <div id="toast-container"></div>

  <script>
  /************************************************************************
   * Students Portal: FULL-featured script
   * - Profile pics stored as data URLs in localStorage.Students[].photo
   * - Sorting / search / view toggle / export CSV/XLSX/PDF / badges / animations
   ************************************************************************/

  // Helper: safe parse
  const safeParse = s => { try { return JSON.parse(s); } catch(e){ return null; } };

  // initial Students (read from localStorage)
  let Students = safeParse(localStorage.getItem('Students')) || [];

  // DOM
  const tbody = document.querySelector('#StudentsTable tbody');
  const cards = document.getElementById('StudentsCards');
  const addBtn = document.getElementById('addStudentsBtn');
  const modal = document.getElementById('StudentsModal');
  const closeModal = document.getElementById('closeModalBtn');
  const form = document.getElementById('StudentsForm');
  const avatarInput = document.getElementById('photoInput');
  const avatarPreviewImg = document.getElementById('avatarPreviewImg');
  const avatarPlaceholder = document.getElementById('avatarPlaceholder');
  const statStudents = document.getElementById('statStudents');
  const statClass = document.getElementById('statClass');
  const statAttendance = document.getElementById('statAttendance');
  const statPayroll = document.getElementById('statPayroll');
  const statTopClass = document.getElementById('statTopClass');
  const topClassCard = document.getElementById('topClassCard');
  const toggleViewBtn = document.getElementById('toggleViewBtn');
  const searchInput = document.getElementById('searchInput');
  const sortSelect = document.getElementById('sortSelect');
  const exportCsvBtn = document.getElementById('exportCsvBtn');
  const exportXlsxBtn = document.getElementById('exportXlsxBtn');
  const exportPdfBtn = document.getElementById('exportPdfBtn');

  const ClassModal = document.getElementById('ClassModal');
  const ClassSelect = document.getElementById('ClassSelect');
  const loadClassBtn = document.getElementById('loadClassBtn');
  const downloadClassPdf = document.getElementById('downloadCClassPdf');

  // mapping Class badge class
  function deptBadge(dept){
    if(!dept) return `<span class="badge admin">Unassigned</span>`;
    const d = dept.toLowerCase();
    if(d.includes('it')) return `<span class="badge it">IT</span>`;
    if(d.includes('finance')) return `<span class="badge finance">Finance</span>`;
    if(d.includes('hr')) return `<span class="badge hr">HR</span>`;
    if(d.includes('safety')) return `<span class="badge safety">Safety</span>`;
    return `<span class="badge admin">${escapeHtml(dept)}</span>`;
  }

  // escape
  function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

  // render list (table + cards)
  function render(list = Students){
    // apply sorting based on sortSelect
    const sort = sortSelect.value;
    let arr = Array.from(list);
    if(sort==='name') arr.sort((a,b)=> (a.fullName||'').localeCompare(b.fullName||''));
    else if(sort==='Class') arr.sort((a,b)=> (a.Class||'').localeCompare(b.Class||''));
    else if(sort==='salary') arr.sort((a,b)=> (Number(a.salary||0) - Number(b.salary||0)));
    else if(sort==='ReportedDate') arr.sort((a,b)=> new Date(a.ReportedDate||0) - new Date(b.ReportedDate||0));

    // table
    tbody.innerHTML = '';
    arr.forEach((e,i)=>{
      const photoHtml = e.photo ? `<img src="${e.photo}" class="avatar" alt="photo">` : `<div style="width:46px;height:46px;border-radius:50%;background:#f0f6fb;display:inline-block"></div>`;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${photoHtml}</td>
        <td>${escapeHtml(e.fullName||'N/A')}</td>
        <td>${ClassBadge(e.Class)}</td>
        <td>${escapeHtml(e.Guardian||'')}</td>
        <td>${escapeHtml(e.Relationship||'')}</td>
        <td class="small">${escapeHtml(e.phone||'')}</td>
        <td class="small">${escapeHtml(e.DOBDate||'')}</td>
        <td class="small">${escapeHtml(e.hireDate||'')}</td>
        <td class="actions">
          <img src="https://img.icons8.com/ios-glyphs/30/edit--v1.png" title="Edit" onclick="editStudent(${i})">
          <img src="https://img.icons8.com/ios-glyphs/30/filled-trash.png" title="Delete" onclick="deleteStudent(${i})">
        </td>`;
      tbody.appendChild(tr);
    });

    // cards
    cards.innerHTML = '';
    arr.forEach((e,i)=>{
      const card = document.createElement('div');
      card.className='Students-card';
      card.innerHTML = `
        <img src="${e.photo||'https://img.icons8.com/ios/100/000000/user--v1.png'}" alt="photo">
        <h4>${escapeHtml(e.fullName||'N/A')}</h4>
        <div style="margin-top:6px">${ClassBadge(e.Class)}</div>
        <p class="small"><b>${escapeHtml(e.Guardian||'')}</b></p>
        <p class="small">${escapeHtml(e.Relationship||'')}</p>
        <p class="small">ðŸ“ž ${escapeHtml(e.phone||'')}</p>
        <p class="small">Date of Birth: ${escapeHtml(e.DOBDate||'')}</p>
        <p class="small">Reported: ${escapeHtml(e.ReportedDate||'')}</p>
        <div style="margin-top:8px">
          <img src="https://img.icons8.com/ios-glyphs/30/edit--v1.png" title="Edit" onclick="editStudent(${i})">
          <img src="https://img.icons8.com/ios-glyphs/30/filled-trash.png" title="Delete" onclick="deleteStudent(${i})">
        </div>`;
      cards.appendChild(card);
    });

    updateStats();
  }

  // update stats (Students, Class, attendance, payroll, top dept)
  function updateStats(){
    const total = Students.length;
    document.getElementById('statStudents').innerText = total;

    const departments = Array.from(new Set(Students.map(e=>e.Class||'Unassigned')));
    document.getElementById('statClass').innerText = Class.length;

    // attendance fallback / attempt to read attendance localStorage if exists
    let attendanceRate = 0;
    try {
      const att = safeParse(localStorage.getItem('attendance')) || [];
      if(Array.isArray(att) && total>0){
        const entries = att.length;
        attendanceRate = Math.min(100, Math.round((entries/(total*30))*100));
      } else attendanceRate = Math.floor(Math.random()*18)+80;
    } catch(e){ attendanceRate = Math.floor(Math.random()*18)+80; }
    document.getElementById('statAttendance').innerText = attendanceRate+'%';

    // top department by average performance if performance data exists, else by count
    const perfData = safeParse(localStorage.getItem('performanceData')) || {};
    const deptScores = {};
    for(const e of employees){
      const scores = perfData[e.fullName] ? Object.values(perfData[e.fullName]).map(Number).filter(n=>!isNaN(n)) : [];
      const avg = scores.length ? (scores.reduce((a,b)=>a+b,0)/scores.length) : 0;
      if(!ClassScores[e.Class]) ClassScores[e.Class] = [];
      ClassScores[e.Class].push(avg);
    }
    let top = 'N/A', topVal = 0;
    for(const d in ClassScores){
      const arr = ClassScores[d];
      const avg = arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
      if(avg>topVal){ topVal=avg; top=d; }
    }
    if(top==='N/A' || topVal===0){
      // fallback: top by count
      const counts = {};
      for(const e of Students) counts[e.Class] = (counts[e.Class]||0)+1;
      let bestDept='',bestCount=0;
      for(const d in counts) if(counts[d]>bestCount){bestCount=counts[d]; bestClass=d;}
      top = bestDept || 'N/A';
      document.getElementById('statTopDept').innerText = top === 'N/A' ? 'N/A' : `${top} (${bestCount} people)`;
    } else {
      document.getElementById('statTopDept').innerText = `${top} (${topVal.toFixed(1)}%)`;
    }

    // populate dept select for breakdown modal
    const select = ClassSelect;
    if(select){
      const prev = select.value;
      select.innerHTML='';
      Array.from(new Set(Students.map(e=>e.Students||'Unassigned'))).sort().forEach(d=>{
        const opt = document.createElement('option'); opt.value=d; opt.textContent=d; select.appendChild(opt);
      });
      if(prev) select.value = prev;
    }
  }

  // open modal add
  addBtn.addEventListener('click', ()=> {
    form.reset(); document.getElementById('editIndex').value='';
    avatarPreviewImg.src=''; avatarPreviewImg.style.display='none'; avatarPlaceholder.style.display='block';
    document.getElementById('modalTitle').innerText='Add Student';
    modal.style.display='flex'; modal.setAttribute('aria-hidden','false');
  });
  closeModal.addEventListener('click', ()=> { modal.style.display='none'; modal.setAttribute('aria-hidden','true'); });

  window.addEventListener('click', (e)=> { if(e.target === modal){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); } });

  // handle photo input preview and base64 read
  avatarInput.addEventListener('change', (ev)=>{
    const f = ev.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      avatarPreviewImg.src = reader.result;
      avatarPreviewImg.style.display='block';
      avatarPlaceholder.style.display='none';
      avatarPreviewImg.dataset.dataurl = reader.result; // store temporarily
    };
    reader.readAsDataURL(f);
  });

  // submit form (add or edit)
  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    const data = {
      fullName: document.getElementById('fullName').value.trim(),
      Class: document.getElementById('Students').value.trim(),
      Guardian: document.getElementById('Guardian').value.trim(),
      Relationship: document.getElementById('Guardian').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      DOBDate: document.getElementById('DOBDate').value,
      ReportedDate: document.getElementById('ReportedDate').value || ''
    };
    // photo from preview
    if(avatarPreviewImg && avatarPreviewImg.src) data.photo = avatarPreviewImg.src;

    const editIndex = document.getElementById('editIndex').value;
    if(editIndex===''){
      Students.push(data);
      showToast('Student added', 'success');
    } else {
      Student[Number(editIndex)] = data;
      showToast('Student updated', 'success');
    }
    localStorage.setItem('Students', JSON.stringify(Students));
    modal.style.display='none'; modal.setAttribute('aria-hidden','true');
    render();
  });

  // edit function (global)
  window.editStudents = function(index){
    const e = Students[index];
    if(!e) return;
    document.getElementById('fullName').value = e.fullName||'';
    document.getElementById('Class').value = e.Class||'';
    document.getElementById('Guardian').value = e.Guardian||'';
    document.getElementById('Relationship').value = e.Relationship||'';
    document.getElementById('phone').value = e.phone||'';
    document.getElementById('DOBDate').value = e.DOBDate||'';
    document.getElementById('ReportedDate').value = e.ReportedDate||'';
    document.getElementById('editIndex').value = index;

    if(e.photo){ avatarPreviewImg.src = e.photo; avatarPreviewImg.style.display='block'; avatarPlaceholder.style.display='none'; }
    else { avatarPreviewImg.src=''; avatarPreviewImg.style.display='none'; avatarPlaceholder.style.display='block'; }

    document.getElementById('modalTitle').innerText='Edit Student';
    modal.style.display='flex'; modal.setAttribute('aria-hidden','false');
  };

  // delete
  window.deleteStudent = function(index){
    if(!confirm('Delete Student?')) return;
    Student.splice(index,1);
    localStorage.setItem('Students', JSON.stringify(Students));
    showToast('Student deleted', 'delete');
    render();
  };

  // search
  searchInput.addEventListener('input', ()=>{
    const q = searchInput.value.trim().toLowerCase();
    const filtered = Students.filter(e=>{
      return (e.fullName||'').toLowerCase().includes(q) ||
             (e.Class||'').toLowerCase().includes(q) ||
             (e.Guardian||'').toLowerCase().includes(q) ||
             (e.phone||'').toString().toLowerCase().includes(q) ||
            
    });
    render(filtered);
  });

  // toggle view
  let isCard = false;
  toggleViewBtn.addEventListener('click', ()=>{
    isCard = !isCard;
    document.getElementById('StudentsTable').style.display = isCard ? 'none' : 'table';
    cards.style.display = isCard ? 'flex' : 'none';
    toggleViewBtn.textContent = isCard ? 'Switch to Table View' : 'Switch to Cards View';
  });

  // sorting
  sortSelect.addEventListener('change', ()=> render());

  // export CSV
  exportCsvBtn.addEventListener('click', ()=>{
    const rows = Students.map(e=>({
      fullName: e.fullName||'',
      Class: e.Class||'',
      Guardian: e.Guardian||'',
      Relationship: e.Relationship||'',
      phone: e.phone||'',
      DOBDate: e.DOBDate||'',
      ReportedDate: e.ReportedDate||''
    }));
    const csv = toCsv(rows);
    downloadText(csv, 'Student.csv', 'text/csv;charset=utf-8;');
  });

  // export XLSX (SheetJS)
  exportXlsxBtn.addEventListener('click', ()=>{
    const rows = Students.map(e=>([e.fullName||'', e.Class||'', e.Guardian||'', e.Relationship||'', e.phone||'', e.DOBDate||'', e.ReportedDate||'']));
    const ws = XLSX.utils.aoa_to_sheet([['Full Name','Class','Guardian','Relationship','Phone','Date of Birth','Hire Date'], ...rows]);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Students');
    XLSX.writeFile(wb, 'Students.xlsx');
  });

  // export PDF using jsPDF (simple text table)
  exportPdfBtn.addEventListener('click', ()=>{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l','pt','a4');
    doc.setFontSize(14); doc.text('Students Report', 40, 40);
    const header = ['#','Full Name','Class','Guardian','Relationship','Phone','DOBDate','Reported Date'];
    let y = 70;
    doc.setFontSize(10);
    doc.text(header.join('  |  '), 40, y); y+=14;
    employees.forEach((e,i)=>{
      const line = [i+1, e.fullName||'', e.Class||'', e.Guardian||'', e.Relationship||'', e.phone||'', e.DOBDate||'', e.ReportedDate||''].join('  |  ');
      doc.text(line, 40, y); y+=12;
      if(y>540){doc.addPage(); y=40;}
    });
    doc.save('Students.pdf');
  });

  // csv helper
  function toCsv(rows){
    if(!rows || !rows.length) return '';
    const keys = Object.keys(rows[0]);
    const lines = [keys.join(',')];
    for(const r of rows){
      lines.push(keys.map(k=>`"${String(r[k]||'').replace(/"/g,'""')}"`).join(','));
    }
    return lines.join('\n');
  }
  function downloadText(text, filename, mime){
    const blob = new Blob([text], {type: mime||'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename; document.body.appendChild(a); a.click(); a.remove();
  }

  // Class modal open
  topClassCard.addEventListener('click', ()=> {
    ClassModal.style.display='flex';
    ClassModal.setAttribute('aria-hidden','false');
  });
  document.querySelectorAll('[data-close-Class]').forEach(b=>b.addEventListener('click', ()=>{ ClassModal.style.display='none'; ClassModal.setAttribute('aria-hidden','true'); }));

  function loadClassPerformance(){
    const Class = ClassSelect.value;
    const perf = safeParse(localStorage.getItem('performanceData')) || {};
    const StudentsInClass = Students.filter(e=> (e.Class||'Unassigned') === Class);
    const tbody = document.querySelector('#deptTable tbody'); tbody.innerHTML='';
    let total = 0;
    StudentsInClass.forEach((e,i)=>{
      const scores = perf[e.fullName] ? Object.values(perf[e.fullName]).map(Number).filter(n=>!isNaN(n)) : [];
      const avg = scores.length ? (scores.reduce((a,b)=>a+b,0)/scores.length) : 0;
      total += avg;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(e.fullName)}</td><td>${avg?avg.toFixed(1)+'%':'0%'}</td>`;
      tr.classList.add('row-highlight');
      tbody.appendChild(tr);
      setTimeout(()=>tr.classList.remove('row-highlight'),900);
    });
    const avgClass = StudentsInClass.length ? (total / StudentsInClass.length).toFixed(1) : 0;
    document.getElementById('ClassAvg').innerText = `Average Score: ${avgDept}%`;
  }

  loadClassBtn.addEventListener('click', loadClassPerformance);
  downloadClassPdf.addEventListener('click', ()=>{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text('Class Report',14,20);
    const rows = Array.from(document.querySelectorAll('#ClassTable tbody tr'));
    let y=40;
    rows.forEach(r=>{
      const line = Array.from(r.cells).map(c=>c.innerText).join('  |  ');
      doc.text(line, 14, y); y += 12;
      if(y>780){doc.addPage(); y=20;}
    });
    doc.save('Class_report.pdf');
  });

  // simple toast
  function showToast(msg, type='success'){
    const t = document.createElement('div'); t.className='toast show';
    t.innerText = msg; document.getElementById('toast-container').appendChild(t);
    setTimeout(()=> t.classList.add('show'),50);
    setTimeout(()=> { t.classList.remove('show'); setTimeout(()=>t.remove(),400); }, 3000);
  }

  // initial render and live sync
  render();
  // monitor localStorage changes (other tabs)
  window.addEventListener('storage', (e)=>{
    if(['Students','performanceData','payments'].includes(e.key)){
      Students = safeParse(localStorage.getItem('Students')) || [];
      render();
    }
  });

  // small CSS animation class for Class table rows
  const style = document.createElement('style');
  style.innerHTML = `.row-highlight{animation:fadeGreen .9s ease}@keyframes fadeGreen{0%{background:#e6ffeb}100%{background:white}}`;
  document.head.appendChild(style);
  </script>
</body>
</html>

