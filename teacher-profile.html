<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Teacher Dashboard â€” Full (Aâ†’G)</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root{
  --bg:#071027; --card:#0f1b2b; --muted:#9fb4c9; --accent1:#00d1ff; --accent2:#7a00ff;
  --glass: rgba(255,255,255,0.03); --radius:12px; --success:#10b981; --danger:#ef4444;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#021127 0%,#071027 100%);color:#e8f6ff}
.app{display:flex;min-height:100vh}
.sidebar{width:260px;padding:22px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-right:1px solid rgba(255,255,255,0.02);display:flex;flex-direction:column;gap:14px}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(90deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#021}
.brand{display:flex;gap:12px;align-items:center}
.small{font-size:12px;color:var(--muted)}
.nav{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.tab{background:transparent;border:0;color:var(--muted);text-align:left;padding:10px;border-radius:8px;cursor:pointer;font-weight:600}
.tab.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#021}
.profile-row{display:flex;gap:12px;align-items:center}
.profile-thumb{width:56px;height:56px;border-radius:10px;object-fit:cover;border:2px solid rgba(255,255,255,0.06)}
.main{flex:1;padding:22px;overflow:auto}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
.big{font-size:20px;font-weight:700}
.tiny{font-size:12px;color:var(--muted)}
.btn{padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
.btn.prim{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#021}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
input,select,textarea{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;width:100%}
.table-scroll{max-height:320px;overflow:auto}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
.badge{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);font-weight:700}
.toast{position:fixed;right:20px;bottom:24px;background:#021124;color:#fff;padding:12px 16px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,0.6);opacity:0;transform:translateY(12px);transition:all .35s}
.toast.show{opacity:1;transform:none}
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.grid-2{display:grid;grid-template-columns:1fr 420px;gap:12px}
@media(max-width:1100px){ .kpis{grid-template-columns:repeat(2,1fr)} .sidebar{display:none} .grid-2{grid-template-columns:1fr}}
.notification-bell{cursor:pointer;position:relative}
.notification-bell .count{position:absolute;top:-6px;right:-8px;background:#ef4444;color:white;border-radius:50%;padding:3px 7px;font-size:12px}
.small-muted{color:var(--muted);font-size:13px}
.section-title{display:flex;justify-content:space-between;align-items:center}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">FG</div>
      <div>
        <div id="orgName" style="font-weight:800">FLAWLESS</div>
        <div class="small" id="teacherRole">Teacher</div>
      </div>
    </div>

    <div class="profile-row">
      <img id="profilePhoto" class="profile-thumb" src="" alt="photo">
      <div>
        <div id="teacherNameSmall" style="font-weight:700">â€”</div>
        <div class="tiny" id="teacherEmailSmall">â€”</div>
      </div>
    </div>

    <nav class="nav" id="nav">
      <button class="tab active" data-section="overview">Overview</button>
      <button class="tab" data-section="classes">Classes</button>
      <button class="tab" data-section="students">Students</button>
      <button class="tab" data-section="attendance">Attendance</button>
      <button class="tab" data-section="assignments">Assignments</button>
      <button class="tab" data-section="messages">Messages</button>
      <button class="tab" data-section="lessons">Lesson Notes</button>
      <button class="tab" data-section="timetable">Timetable</button>
      <button class="tab" data-section="settings">Settings</button>
    </nav>

    <div style="margin-top:auto;display:flex;gap:8px;align-items:center">
      <div class="notification-bell" id="notifBell" title="Notifications">ðŸ”” <span class="count" id="notifCount" style="display:none">0</span></div>
      <button class="btn ghost" id="logoutBtn">Logout</button>
    </div>
  </aside>

  <main class="main">
    <div class="header">
      <div>
        <h1 id="pageTitle" style="margin:0">Overview</h1>
        <div class="tiny">Teacher dashboard â€¢ Flawless Graphics</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="tiny">Theme</div>
        <button class="btn ghost" id="themeBtn">Toggle</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpis" id="kpis">
      <div class="card">
        <h4>Classes</h4>
        <div class="big" id="k_classes">0</div>
        <div class="tiny">Active classes</div>
      </div>
      <div class="card">
        <h4>Students</h4>
        <div class="big" id="k_students">0</div>
        <div class="tiny">Total students</div>
      </div>
      <div class="card">
        <h4>Attendance</h4>
        <div class="big" id="k_att">0%</div>
        <div class="tiny">Last 30 days</div>
      </div>
      <div class="card">
        <h4>Messages</h4>
        <div class="big" id="k_msgs">0</div>
        <div class="tiny">Unread</div>
      </div>
    </div>

    <!-- Overview -->
    <section id="overviewSection" class="card">
      <div class="section-title">
        <h3 style="margin:0">Recent Activity</h3>
        <div class="tiny" id="lastUpdated">â€”</div>
      </div>
      <div id="activityFeed" style="margin-top:12px"></div>
    </section>

    <!-- CLASSES -->
    <section id="classesSection" class="card" style="display:none; margin-top:14px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Classes</h3>
        <div style="display:flex;gap:8px">
          <button class="btn prim" id="newClassBtn">+ New Class</button>
          <button class="btn" id="exportClassesBtn">Export</button>
        </div>
      </div>

      <div style="margin-top:12px;display:grid;grid-template-columns:1fr 360px;gap:12px">
        <div>
          <div style="margin-bottom:10px">
            <input id="className" placeholder="Class name">
            <input id="classSubject" placeholder="Subject" style="margin-top:8px">
            <button class="btn prim" id="saveClassBtn" style="margin-top:8px">Save Class</button>
          </div>
          <div class="table-scroll">
            <table id="classesTable">
              <thead><tr><th>#</th><th>Name</th><th>Subject</th><th>Students</th><th>Actions</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div>
          <h4>Selected Class Preview</h4>
          <div id="classPreview" style="margin-top:8px"></div>
        </div>
      </div>
    </section>

    <!-- STUDENTS -->
    <section id="studentsSection" class="card" style="display:none; margin-top:14px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Students</h3>
        <div style="display:flex;gap:8px">
          <select id="selectClassForStudents"></select>
          <button class="btn prim" id="newStudentBtn">+ Add Student</button>
        </div>
      </div>
      <div class="table-scroll" style="margin-top:12px">
        <table id="studentsTable">
          <thead><tr><th>#</th><th>Name</th><th>Roll</th><th>Phone</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ATTENDANCE -->
    <section id="attendanceSection" class="card" style="display:none; margin-top:14px">
      <div style="display:flex;gap:8px;align-items:center">
        <select id="attClassSelect"></select>
        <input type="date" id="attDate" value="">
        <button class="btn prim" id="openMarkBtn">Open Marking</button>
      </div>
      <div id="attendanceMarkArea" style="margin-top:12px"></div>
      <div id="attendanceHistory" style="margin-top:12px"></div>

      <hr style="margin:16px 0">

      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn prim" id="clockInBtn">Clock In (Teacher)</button>
        <button class="btn" id="clockOutBtn">Clock Out (Teacher)</button>
        <div class="tiny" id="attStatus">Status: â€”</div>
      </div>

      <div id="recentAtt" class="tiny" style="margin-top:10px;max-height:120px;overflow:auto;"></div>
    </section>

    <!-- ASSIGNMENTS -->
    <section id="assignmentsSection" class="card" style="display:none; margin-top:14px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Assignments</h3>
        <div style="display:flex;gap:8px">
          <select id="assignClassSelect"></select>
          <button class="btn prim" id="newAssignBtn">New Assignment</button>
        </div>
      </div>
      <div id="assignmentList" style="margin-top:12px"></div>
    </section>

    <!-- MESSAGES -->
    <section id="messagesSection" class="card" style="display:none; margin-top:14px">
      <h3>Messages</h3>
      <div style="display:flex;gap:8px">
        <input id="msgSubject" placeholder="Subject" style="flex:1">
        <input id="msgTo" placeholder="To (email or group)" style="width:220px">
      </div>
      <textarea id="msgBody" rows="4" style="margin-top:8px"></textarea>
      <div style="margin-top:8px">
        <button class="btn prim" id="sendMsgBtn">Send</button>
        <button class="btn" id="exportMsgsBtn">Export</button>
      </div>
      <div id="msgList" style="margin-top:14px"></div>
    </section>

    <!-- LESSON NOTES -->
    <section id="lessonsSection" class="card" style="display:none; margin-top:14px">
      <h3>Lesson Notes</h3>
      <div style="display:flex;gap:8px">
        <select id="noteClassSelect"></select>
        <input id="noteTitle" placeholder="Title" style="flex:1">
      </div>
      <textarea id="noteBody" rows="6" style="margin-top:8px"></textarea>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn prim" id="saveNoteBtn">Save Note</button>
        <button class="btn" id="exportNotesBtn">Export Notes</button>
      </div>
      <div id="notesList" style="margin-top:12px"></div>
    </section>

    <!-- TIMETABLE -->
    <section id="timetableSection" class="card" style="display:none; margin-top:14px">
      <h3>Timetable</h3>
      <div style="display:flex;gap:8px;align-items:center">
        <select id="ttClassSelect"></select>
        <select id="ttDay">
          <option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option>
        </select>
        <input id="ttFrom" type="time">
        <input id="ttTo" type="time">
        <button class="btn prim" id="saveTTBtn">Add</button>
      </div>
      <div id="timetableList" style="margin-top:12px"></div>
    </section>

    <!-- SETTINGS -->
    <section id="settingsSection" class="card" style="display:none; margin-top:14px">
      <h3>Settings</h3>
      <div style="display:flex;gap:12px;align-items:flex-start">
        <div style="flex:1">
          <label class="tiny">Upload Profile Photo</label>
          <input type="file" id="photoUpload">
          <div style="margin-top:12px">
            <label class="tiny">Auto logout (minutes)</label>
            <input type="number" id="idleMinutes" min="1" value="10" style="width:120px">
          </div>
        </div>
        <div style="width:360px">
          <h4>Profile Preview</h4>
          <img id="profilePreview" style="width:160px;height:160px;border-radius:10px;object-fit:cover;border:1px solid rgba(255,255,255,0.04)" src="">
        </div>
      </div>
    </section>

  </main>
</div>

<div id="toast" class="toast"></div>

<script>
/* -------------------------
  Utilities & keys
------------------------- */
function safeParse(s){ try{return JSON.parse(s)}catch(e){return null} }
function read(k){ return safeParse(localStorage.getItem(k)) || [] }
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)) }
function toast(msg, t=2500){ const el=document.getElementById('toast'); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), t); }

/* Active teacher/session detection (tries multiple keys) */
const sessionCandidates = ['active_teacher','teacher_active_user','active_user','active_org_user'];
let teacher = null;
for(const k of sessionCandidates){ const v = safeParse(localStorage.getItem(k)); if(v && (v.email || v.name)){ teacher = v; break; } }
if(!teacher){ alert('Session expired â€” please login'); window.location.href='teacher-login.html'; throw new Error('No session'); }

/* ORG keys */
const ORG = teacher.org || localStorage.getItem('active_org') || 'FLAWLESS';
const safeEmail = (teacher.email||teacher.name||'unknown').replace(/[@\.\s]/g,'_').toLowerCase();

const CLASSES_KEY = `${ORG}_classes`;
const ASSIGN_KEY = `${ORG}_assignments`;
const ATT_KEY = `${ORG}_attendance`;
const TEACH_ATT_KEY = `${ORG}_teacher_attendance`;
const MSG_KEY = `${ORG}_messages`;
const NOTE_KEY = `${ORG}_lesson_notes`;
const TT_KEY = `${ORG}_timetable`;
const SETTINGS_KEY = `${ORG}_settings`;
const ACT_KEY = `${ORG}_activity`;

/* ensure keys exist */
if(!localStorage.getItem(CLASSES_KEY)) save(CLASSES_KEY, []);
if(!localStorage.getItem(ASSIGN_KEY)) save(ASSIGN_KEY, []);
if(!localStorage.getItem(ATT_KEY)) save(ATT_KEY, []);
if(!localStorage.getItem(TEACH_ATT_KEY)) save(TEACH_ATT_KEY, []);
if(!localStorage.getItem(MSG_KEY)) save(MSG_KEY, []);
if(!localStorage.getItem(NOTE_KEY)) save(NOTE_KEY, []);
if(!localStorage.getItem(TT_KEY)) save(TT_KEY, []);
if(!localStorage.getItem(SETTINGS_KEY)) save(SETTINGS_KEY, { idle_minutes:10 });
if(!localStorage.getItem(ACT_KEY)) save(ACT_KEY, []);

/* UI boot */
document.getElementById('orgName').textContent = ORG;
document.getElementById('teacherNameSmall').textContent = teacher.name || teacher.email;
document.getElementById('teacherEmailSmall').textContent = teacher.email || '';
document.getElementById('profilePreview').src = teacher.photoBase64 || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160"><rect width="100%" height="100%" fill="%230b1b2b"/></svg>';
document.getElementById('profilePhoto').src = teacher.photoBase64 || document.getElementById('profilePreview').src;

/* nav/tab wiring */
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    btn.classList.add('active');
    const sec = btn.dataset.section;
    document.querySelectorAll('main section').forEach(s=> s.style.display='none');
    document.getElementById(sec + 'Section').style.display = 'block';
    document.getElementById('pageTitle').textContent = btn.textContent;
  });
});

/* quick helpers for activity */
function pushActivity(text){
  const arr = read(ACT_KEY); arr.push({ text, time: new Date().toISOString() }); save(ACT_KEY, arr); renderActivity();
}

/* -------------------------
  CLASSES CRUD
------------------------- */
function getClasses(){ return read(CLASSES_KEY) }
function saveClasses(arr){ save(CLASSES_KEY, arr) }

function renderClasses(){
  const tb = document.querySelector('#classesTable tbody'); tb.innerHTML = '';
  const arr = getClasses();
  arr.forEach((c,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(c.name)}</td><td>${escapeHtml(c.subject||'')}</td><td>${(c.students||[]).length}</td>
      <td>
        <button onclick="editClass('${c.id}')">Edit</button>
        <button onclick="manageStudents('${c.id}')">Students</button>
        <button onclick="deleteClass('${c.id}')">Delete</button>
      </td>`;
    tb.appendChild(tr);
  });
  document.getElementById('k_classes').textContent = arr.length;
  populateClassSelects();
  renderClassPreview();
}
document.getElementById('newClassBtn').addEventListener('click', ()=>{ document.getElementById('className').value=''; document.getElementById('classSubject').value=''; document.getElementById('className').focus(); });
document.getElementById('saveClassBtn').addEventListener('click', ()=>{
  const name = document.getElementById('className').value.trim(); const subject = document.getElementById('classSubject').value.trim();
  if(!name) return alert('Enter class name');
  const arr = getClasses(); arr.push({ id:'c_'+Date.now(), name, subject, students:[] }); saveClasses(arr); renderClasses(); pushActivity(`Created class: ${name}`); toast('Class created');
});
function editClass(id){
  const arr = getClasses(); const c = arr.find(x=>x.id===id); if(!c) return alert('Not found');
  const name = prompt('Class name', c.name); if(name===null) return; const subject = prompt('Subject', c.subject||'')||c.subject;
  c.name=name; c.subject=subject; saveClasses(arr); renderClasses(); pushActivity(`Edited class: ${name}`); toast('Class updated');
}
function deleteClass(id){ if(!confirm('Delete class?')) return; const arr = getClasses().filter(x=>x.id!==id); saveClasses(arr); renderClasses(); pushActivity('Deleted class'); toast('Deleted'); }
function manageStudents(classId){ document.querySelector('[data-section="students"]').click(); document.getElementById('selectClassForStudents').value = classId; renderStudentsForClass(classId); }

/* class preview */
function renderClassPreview(){
  const sel = document.getElementById('selectClassForStudents').value || (getClasses()[0] && getClasses()[0].id);
  if(!sel) { document.getElementById('classPreview').innerHTML = '<div class="tiny">No class</div>'; return; }
  const c = getClasses().find(x=>x.id===sel);
  if(!c) return;
  document.getElementById('classPreview').innerHTML = `<strong>${escapeHtml(c.name)}</strong><div class="tiny">${escapeHtml(c.subject||'')}</div><div style="margin-top:8px">${(c.students||[]).map(s=>escapeHtml(s.firstName+' '+(s.lastName||''))).slice(0,10).join(', ') || '<span class="tiny">No students</span>'}</div>`;
}

/* -------------------------
  STUDENTS CRUD
------------------------- */
function populateClassSelects(){
  const ids = ['selectClassForStudents','attClassSelect','assignClassSelect','noteClassSelect','ttClassSelect'];
  const arr = getClasses();
  ids.forEach(id=>{
    const el = document.getElementById(id); if(!el) return; el.innerHTML = '<option value="">-- select class --</option>';
    arr.forEach(c => el.appendChild(Object.assign(document.createElement('option'), { value:c.id, textContent:c.name })));
  });
}
function renderStudentsForClass(classId){
  const arr = getClasses(); const cls = arr.find(c=>c.id===classId);
  const tbody = document.querySelector('#studentsTable tbody'); tbody.innerHTML = '';
  if(!cls){ tbody.innerHTML = '<tr><td colspan="5">Select a class</td></tr>'; return; }
  (cls.students||[]).forEach((s,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(s.firstName + ' ' + (s.lastName||''))}</td><td>${escapeHtml(s.roll||'')}</td><td>${escapeHtml(s.phone||'')}</td><td><button onclick="editStudent('${classId}','${s.id}')">Edit</button> <button onclick="deleteStudent('${classId}','${s.id}')">Delete</button></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('k_students').textContent = getClasses().reduce((s,c)=> s + (c.students?c.students.length:0),0);
  renderClassPreview();
}
document.getElementById('newStudentBtn').addEventListener('click', ()=>{
  const classId = document.getElementById('selectClassForStudents').value;
  if(!classId) return alert('Select class');
  const fn = prompt('First name'); if(!fn) return; const ln = prompt('Last name','')||''; const roll = prompt('Roll','')||''; const phone = prompt('Phone','')||'';
  const arr = getClasses(); const c = arr.find(x=>x.id===classId); c.students = c.students||[]; c.students.push({ id:'s_'+Date.now(), firstName:fn, lastName:ln, roll, phone }); saveClasses(arr); renderStudentsForClass(classId); pushActivity(`Added student ${fn} to ${c.name}`); toast('Student added');
});
function editStudent(classId, studentId){
  const arr = getClasses(); const c = arr.find(x=>x.id===classId); if(!c) return; const s = c.students.find(x=>x.id===studentId); if(!s) return;
  const fn = prompt('First name', s.firstName); if(fn===null) return; s.firstName=fn; s.lastName = prompt('Last name', s.lastName||'')||''; s.roll = prompt('Roll', s.roll||'')||''; s.phone = prompt('Phone', s.phone||'')||''; saveClasses(arr); renderStudentsForClass(classId); pushActivity(`Edited student ${fn}`); toast('Student updated');
}
function deleteStudent(classId, studentId){ if(!confirm('Delete student?')) return; const arr=getClasses(); const c = arr.find(x=>x.id===classId); c.students = c.students.filter(s=>s.id!==studentId); saveClasses(arr); renderStudentsForClass(classId); pushActivity('Deleted student'); toast('Deleted'); }

/* select change wiring */
document.getElementById('selectClassForStudents').addEventListener('change', (e)=> renderStudentsForClass(e.target.value));

/* -------------------------
  ATTENDANCE (students)
------------------------- */
document.getElementById('openMarkBtn').addEventListener('click', renderAttendanceMarkArea);
function renderAttendanceMarkArea(){
  const classId = document.getElementById('attClassSelect').value;
  const date = document.getElementById('attDate').value;
  if(!classId) return alert('Select class');
  if(!date) return alert('Select date');
  const cls = getClasses().find(c=>c.id===classId);
  const area = document.getElementById('attendanceMarkArea'); area.innerHTML = '';
  if(!cls || !(cls.students||[]).length){ area.innerHTML = '<div class="tiny">No students</div>'; return; }
  const table = document.createElement('table'); const tbody = document.createElement('tbody');
  cls.students.forEach(s=>{
    const tr = document.createElement('tr'); tr.innerHTML = `<td>${s.firstName} ${s.lastName||''}</td><td><select id="att_${s.id}"><option value="present">Present</option><option value="absent">Absent</option></select></td>`;
    tbody.appendChild(tr);
  });
  table.appendChild(tbody); area.appendChild(table);
  const saveBtn = document.createElement('button'); saveBtn.className='btn prim'; saveBtn.textContent='Save Attendance';
  saveBtn.onclick = ()=>{ const map = {}; cls.students.forEach(s=> map[s.id] = document.getElementById('att_'+s.id).value ); recordAttendance(classId, date, map); };
  area.appendChild(saveBtn);
}
function recordAttendance(classId, dateStr, attendanceMap){
  const arr = read(ATT_KEY); arr.push({ id:'att_'+Date.now(), classId, date:dateStr, by: teacher.email, attendance:attendanceMap }); save(ATT_KEY, arr); toast('Attendance saved'); pushActivity(`Marked attendance for class ${classId}`); renderAttendanceHistory(classId); updateKPIs();
}
function renderAttendanceHistory(classId){
  const arr = read(ATT_KEY).filter(a=>a.classId===classId).slice().reverse();
  const out = document.getElementById('attendanceHistory'); out.innerHTML = '<h4>History</h4>';
  if(!arr.length){ out.innerHTML += '<div class="tiny">No records</div>'; return; }
  arr.forEach(r=> out.innerHTML += `<div class="tiny">${r.date} â€¢ ${Object.keys(r.attendance||{}).length} students</div>`);
}

/* -------------------------
  TEACHER CLOCK-IN / OUT (sync to TEACH_ATT_KEY and HR ATT_KEY)
------------------------- */
const teachAttArr = read(TEACH_ATT_KEY);
let myTeachRecord = teachAttArr.find(r => r.email === teacher.email);
if(!myTeachRecord){ myTeachRecord = { email: teacher.email, log: [] }; teachAttArr.push(myTeachRecord); save(TEACH_ATT_KEY, teachAttArr); }

const clockInBtn = document.getElementById('clockInBtn');
const clockOutBtn = document.getElementById('clockOutBtn');
const attStatusEl = document.getElementById('attStatus');
const recentAttEl = document.getElementById('recentAtt');

function updateTeacherAttendanceUI(){
  const last = myTeachRecord.log[myTeachRecord.log.length-1];
  if(!last || last.out){ attStatusEl.textContent = 'Status: Clocked Out'; }
  else { attStatusEl.textContent = 'Status: Clocked IN at ' + new Date(last.in).toLocaleTimeString(); }
  recentAttEl.innerHTML = myTeachRecord.log.slice().reverse().slice(0,10).map(r=>`<div class="tiny">${new Date(r.in).toLocaleString()}${r.out? ' â†’ ' + new Date(r.out).toLocaleTimeString():''}</div>`).join('');
  save(TEACH_ATT_KEY, teachAttArr); updateKPIs();
}

/* helpers to also push to HR ATT_KEY for dashboard view */
function pushHrAttendance(action){
  const hr = read(ATT_KEY); hr.push({ employeeEmail: teacher.email, action, date: new Date().toISOString() }); save(ATT_KEY, hr);
}

clockInBtn.addEventListener('click', ()=> {
  const now = new Date().toISOString();
  const last = myTeachRecord.log[myTeachRecord.log.length-1];
  if(!last || last.out){ myTeachRecord.log.push({ in: now, out: null }); save(TEACH_ATT_KEY, teachAttArr); pushHrAttendance('in'); updateTeacherAttendanceUI(); pushActivity('Teacher clocked IN'); toast('Clocked in'); }
  else toast('Already clocked in');
});
clockOutBtn.addEventListener('click', ()=> {
  const now = new Date().toISOString();
  const last = myTeachRecord.log[myTeachRecord.log.length-1];
  if(last && !last.out){ last.out = now; save(TEACH_ATT_KEY, teachAttArr); pushHrAttendance('out'); updateTeacherAttendanceUI(); pushActivity('Teacher clocked OUT'); toast('Clocked out'); }
  else toast('You are not clocked in');
});

/* -------------------------
  ASSIGNMENTS
------------------------- */
function getAssignments(){ return read(ASSIGN_KEY) }
document.getElementById('newAssignBtn').addEventListener('click', ()=>{
  const classId = document.getElementById('assignClassSelect').value; if(!classId) return alert('Select class');
  const title = prompt('Assignment title'); if(!title) return; const due = prompt('Due date (YYYY-MM-DD)','')||'';
  const arr = getAssignments(); arr.push({ id:'a_'+Date.now(), classId, title, due, createdAt: new Date().toISOString(), submissions:[], completed:false }); save(ASSIGN_KEY, arr); renderAssignments(); pushActivity('Created assignment'); toast('Assignment created');
});
function renderAssignments(){
  const arr = getAssignments().slice().reverse(); const out = document.getElementById('assignmentList'); out.innerHTML = '';
  if(!arr.length) return out.innerHTML = '<div class="tiny">No assignments</div>';
  arr.forEach(a=>{ const div=document.createElement('div'); div.style.padding='8px 0'; div.innerHTML = `<strong>${a.title}</strong> â€¢ due: ${a.due||'â€”'} â€¢ <span class="tiny">class: ${a.classId}</span> <div style="margin-top:6px"><button onclick="toggleAssignment('${a.id}')">${a.completed? 'Reopen':'Complete'}</button> <button onclick="viewSubmissions('${a.id}')">Submissions (${(a.submissions||[]).length})</button></div>`; out.appendChild(div); });
}
function toggleAssignment(id){ const arr = getAssignments().map(x=> x.id===id? {...x, completed:!x.completed}:x); save(ASSIGN_KEY, arr); renderAssignments(); toast('Assignment updated'); }
function viewSubmissions(id){ const arr = getAssignments(); const a = arr.find(x=>x.id===id); alert('Submissions: ' + JSON.stringify(a.submissions||[],null,2)); }

/* -------------------------
  MESSAGES + Notifications
------------------------- */
function getMessages(){ return read(MSG_KEY) }
function saveMessages(a){ save(MSG_KEY, a) }
document.getElementById('sendMsgBtn').addEventListener('click', ()=>{
  const subj = document.getElementById('msgSubject').value.trim(); const to = document.getElementById('msgTo').value.trim(); const body = document.getElementById('msgBody').value.trim();
  if(!subj || !body) return alert('Complete subject & message');
  const arr = getMessages(); arr.push({ id:'m_'+Date.now(), from: teacher.email, to, subject:subj, body, date:new Date().toISOString(), read:false }); saveMessages(arr); document.getElementById('msgSubject').value=''; document.getElementById('msgBody').value=''; renderMessages(); pushActivity('Sent message'); toast('Message sent');
});
function renderMessages(){ const arr = getMessages().slice().reverse(); const out = document.getElementById('msgList'); out.innerHTML=''; if(!arr.length) return out.innerHTML = '<div class="tiny">No messages</div>'; arr.forEach(m=>{ const d=document.createElement('div'); d.style.padding='8px 0'; d.innerHTML = `<strong>${escapeHtml(m.subject)}</strong> â€¢ <span class="tiny">${new Date(m.date).toLocaleString()}</span><div class="tiny">${escapeHtml(m.body)}</div>`; out.appendChild(d); }); updateNotifCount(); }
function updateNotifCount(){ const unread = getMessages().filter(m=>!m.read && (!m.to || m.to === teacher.email)).length; const el = document.getElementById('k_msgs'); el.textContent = unread; const bell = document.getElementById('notifCount'); if(unread){ bell.style.display='inline-block'; bell.textContent = unread } else bell.style.display='none'; }
document.getElementById('notifBell').addEventListener('click', ()=> { document.querySelector('[data-section="messages"]').click(); });

document.getElementById('exportMsgsBtn').addEventListener('click', ()=> {
  const data = getMessages(); const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`${ORG}_${safeEmail}_messages.json`; a.click();
});

/* -------------------------
  LESSON NOTES
------------------------- */
function getNotes(){ return read(NOTE_KEY) }
document.getElementById('saveNoteBtn').addEventListener('click', ()=>{
  const classId = document.getElementById('noteClassSelect').value; const title = document.getElementById('noteTitle').value.trim(); const body = document.getElementById('noteBody').value.trim();
  if(!classId || !title || !body) return alert('Complete note form');
  const arr = getNotes(); arr.push({ id:'n_'+Date.now(), classId, title, body, author: teacher.email, date:new Date().toISOString() }); save(NOTE_KEY, arr); renderNotes(); pushActivity('Saved lesson note'); toast('Note saved');
});
function renderNotes(){ const arr = getNotes().slice().reverse(); const out = document.getElementById('notesList'); out.innerHTML=''; if(!arr.length) return out.innerHTML = '<div class="tiny">No notes</div>'; arr.forEach(n=>{ const d=document.createElement('div'); d.style.padding='8px 0'; d.innerHTML = `<strong>${escapeHtml(n.title)}</strong> â€¢ <span class="tiny">${new Date(n.date).toLocaleString()}</span><div class="tiny">${escapeHtml(n.body)}</div>`; out.appendChild(d); }) }
document.getElementById('exportNotesBtn').addEventListener('click', ()=>{ const data = getNotes(); const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`${ORG}_${safeEmail}_notes.json`; a.click(); });

/* -------------------------
  TIMETABLE
------------------------- */
function getTT(){ return read(TT_KEY) }
document.getElementById('saveTTBtn').addEventListener('click', ()=>{
  const classId = document.getElementById('ttClassSelect').value; const day = document.getElementById('ttDay').value; const from = document.getElementById('ttFrom').value; const to = document.getElementById('ttTo').value;
  if(!classId || !day || !from || !to) return alert('Complete timetable entry');
  const arr = getTT(); arr.push({ id:'tt_'+Date.now(), classId, day, from, to, createdBy:teacher.email }); save(TT_KEY, arr); renderTT(); pushActivity('Added timetable'); toast('Timetable added');
});
function renderTT(){ const arr = getTT(); const el = document.getElementById('timetableList'); el.innerHTML = ''; if(!arr.length) return el.innerHTML = '<div class="tiny">No timetable entries</div>'; arr.forEach(t=> el.innerHTML += `<div class="tiny">${t.day} â€¢ ${t.from}â€“${t.to} â€¢ class: ${t.classId}</div>`); }

/* -------------------------
  KPIs & activity
------------------------- */
function updateKPIs(){
  const classes = getClasses(); const students = classes.reduce((s,c)=> s + (c.students?c.students.length:0),0);
  document.getElementById('k_classes').textContent = classes.length; document.getElementById('k_students').textContent = students;
  const attArr = read(ATT_KEY); const last30 = attArr.filter(a=> (Date.now() - new Date(a.date).getTime()) < (30*24*3600*1000));
  let presentCount=0,totalCount=0; last30.forEach(r=> Object.values(r.attendance||{}).forEach(v=>{ totalCount++; if(v==='present') presentCount++; })); const rate = totalCount? Math.round(presentCount/totalCount*100):100; document.getElementById('k_att').textContent = rate + '%';
  updateNotifCount();
  document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
}
function renderActivity(){ const arr = read(ACT_KEY).slice().reverse(); const el = document.getElementById('activityFeed'); el.innerHTML = arr.length? arr.slice(0,20).map(a=>`<div class="tiny">${escapeHtml(a.text)} â€” ${new Date(a.time).toLocaleString()}</div>`).join('') : '<div class="tiny">No activity</div>'; }

/* -------------------------
  SETTINGS & PHOTO UPLOAD
------------------------- */
document.getElementById('photoUpload').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader(); r.onload = ()=>{ teacher.photoBase64 = r.result; try{ localStorage.setItem('active_teacher', JSON.stringify(teacher)); }catch(e){}; document.getElementById('profilePreview').src = r.result; document.getElementById('profilePhoto').src = r.result; toast('Photo updated'); }; r.readAsDataURL(f);
});
document.getElementById('saveClassBtn').addEventListener('click', ()=>{}); // already wired

/* -------------------------
  EXPORTS & UTIL
------------------------- */
document.getElementById('exportClassesBtn').addEventListener('click', ()=> {
  const rows = getClasses().map(c=> ({ name:c.name, subject:c.subject, students:(c.students||[]).length }));
  const csv = toCsv(rows); downloadText(csv, `${ORG}_classes.csv`, 'text/csv'); toast('Exported classes');
});
function toCsv(rows){ if(!rows.length) return ''; const keys = Object.keys(rows[0]); const lines=[keys.join(',')]; rows.forEach(r=> lines.push(keys.map(k=>`"${String(r[k]||'').replace(/"/g,'""')}"`).join(','))); return lines.join('\n'); }
function downloadText(text, filename, type='text/plain'){ const blob = new Blob([text],{type}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download = filename; document.body.appendChild(a); a.click(); a.remove(); }

/* -------------------------
  STORAGE SYNC (live updates from HR / other tabs)
------------------------- */
window.addEventListener('storage', (e)=>{
  const keys = [CLASSES_KEY, ASSIGN_KEY, ATT_KEY, TEACH_ATT_KEY, MSG_KEY, NOTE_KEY, TT_KEY, SETTINGS_KEY, ACT_KEY];
  if(keys.includes(e.key)){
    renderAll();
    toast('Data updated (sync)');
  }
});

/* -------------------------
  INITIAL RENDER
------------------------- */
function renderAll(){
  renderClasses(); populateClassSelects(); renderStudentsForClass(document.getElementById('selectClassForStudents').value || (getClasses()[0] && getClasses()[0].id));
  renderAssignments(); renderMessages(); renderNotes(); renderTT(); renderActivity(); updateTeacherAttendanceUI(); updateKPIs();
  updateNotifCount();
}
renderAll();

/* small wrappers for render functions used before defined */
function renderAssignments(){ try{ const arr = getAssignments(); /* defined earlier */ }catch{}; const x = read(ASSIGN_KEY); /* ensure safe */ const node = document.getElementById('assignmentList'); node.innerHTML = ''; (x.slice().reverse()).forEach(a=>{ const div=document.createElement('div'); div.style.padding='8px 0'; div.innerHTML = `<strong>${escapeHtml(a.title)}</strong> â€¢ due: ${a.due || 'â€”'} â€¢ <span class="tiny">class: ${a.classId}</span>`; node.appendChild(div); }); }
function renderMessages(){ const arr = getMessages().slice().reverse(); const out = document.getElementById('msgList'); out.innerHTML=''; if(!arr.length) return out.innerHTML = '<div class="tiny">No messages</div>'; arr.forEach(m=>{ const d=document.createElement('div'); d.style.padding='8px 0'; d.innerHTML = `<strong>${escapeHtml(m.subject)}</strong> â€¢ <span class="tiny">${new Date(m.date).toLocaleString()}</span><div class="tiny">${escapeHtml(m.body)}</div>`; out.appendChild(d); }); updateNotifCount(); }
function renderNotes(){ const arr = getNotes().slice().reverse(); const out = document.getElementById('notesList'); out.innerHTML=''; if(!arr.length) return out.innerHTML = '<div class="tiny">No notes</div>'; arr.forEach(n=>{ const d=document.createElement('div'); d.style.padding='8px 0'; d.innerHTML = `<strong>${escapeHtml(n.title)}</strong> â€¢ <span class="tiny">${new Date(n.date).toLocaleString()}</span><div class="tiny">${escapeHtml(n.body)}</div>`; out.appendChild(d); }) }
function renderTT(){ const arr = getTT(); const el = document.getElementById('timetableList'); el.innerHTML = ''; if(!arr.length) return el.innerHTML = '<div class="tiny">No timetable entries</div>'; arr.forEach(t=> el.innerHTML += `<div class="tiny">${t.day} â€¢ ${t.from}â€“${t.to} â€¢ class: ${t.classId}</div>`); }

/* -------------------------
  Misc / Helpers
------------------------- */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* logout */
document.getElementById('logoutBtn').addEventListener('click', ()=>{ localStorage.removeItem('active_teacher'); localStorage.removeItem('teacher_active_user'); window.location.href = 'teacher.html'; });

/* theme toggle */
document.getElementById('themeBtn').addEventListener('click', ()=>{ document.body.classList.toggle('light'); toast('Theme toggled'); });

/* idle logout */
let idleMinutes = Number((read(SETTINGS_KEY)||{}).idle_minutes || 10);
document.getElementById('idleMinutes').value = idleMinutes;
let idleTimer;
function resetIdleTimer(){ clearTimeout(idleTimer); idleTimer = setTimeout(()=>{ toast('Logged out due to inactivity'); localStorage.removeItem('active_teacher'); setTimeout(()=> window.location.href='teacher.html', 900); }, idleMinutes*60*1000); }
['mousemove','keydown','click','touchstart'].forEach(ev=>window.addEventListener(ev, resetIdleTimer)); resetIdleTimer();

</script>
</body>
</html>
