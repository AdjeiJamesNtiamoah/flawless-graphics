<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teacher Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root {
  --primary:#0066ff;
  --bg:#f4f6fa;
  --card:#ffffff;
  --text:#1e293b;
  --muted:#64748b;
  --radius:14px;
}

body {
  margin:0;
  background:var(--bg);
  font-family:Inter,Roboto,Arial;
  color:var(--text);
  display:flex;
  min-height:100vh;
}

/* SIDEBAR */
.sidebar {
  width:260px;
  background:#0f172a;
  color:white;
  padding:20px;
  display:flex;
  flex-direction:column;
}

.sidebar h2 {
  text-align:center;
  margin:0 0 25px 0;
}

.nav-item {
  padding:12px 14px;
  border-radius:8px;
  cursor:pointer;
  margin-bottom:10px;
  display:flex;
  gap:12px;
  align-items:center;
  transition:.2s;
}
.nav-item:hover {
  background:#1e293b;
}

/* CONTENT */
.content {
  flex:1;
  padding:25px;
}

.header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:25px;
}

.card {
  background:var(--card);
  padding:20px;
  border-radius:var(--radius);
  margin-bottom:25px;
  box-shadow:0 4px 12px rgba(0,0,0,0.06);
}

.btn {
  padding:12px 18px;
  border-radius:var(--radius);
  background:var(--primary);
  color:white;
  border:none;
  cursor:pointer;
  font-weight:600;
  transition:.2s;
}
.btn:hover { opacity:.85; }

.status {
  padding:8px 14px;
  border-radius:var(--radius);
  font-size:14px;
  font-weight:600;
  display:inline-block;
}
.status.in { background:#10b981; color:white; }
.status.out { background:#ef4444; color:white; }

/* TABLE */
table { width:100%; border-collapse:collapse; margin-top:12px; }
th,td {
  padding:10px;
  border-bottom:1px solid #e2e8f0;
  text-align:left;
}

/* TOAST */
#toast {
  position:fixed; right:22px; bottom:22px;
  background:#1e293b; color:white;
  padding:12px 16px;
  border-radius:var(--radius);
  opacity:0;
  transform:translateY(10px);
  transition:.3s;
}
#toast.show { opacity:1; transform:none; }

</style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <h2>Teacher Panel</h2>
  <div class="nav-item"><i class="fa fa-user"></i> Profile</div>
  <div class="nav-item"><i class="fa fa-calendar-check"></i> Attendance</div>
  <div class="nav-item"><i class="fa fa-envelope"></i> Messages</div>
  <div class="nav-item" id="logoutBtn"><i class="fa fa-right-from-bracket"></i> Logout</div>
</div>

<!-- CONTENT -->
<div class="content">

  <div class="header">
    <h1>Welcome, <span id="teacherName">Teacher</span></h1>
    <span id="statusBadge" class="status out">Clocked Out</span>
  </div>

  <!-- CLOCK-IN / OUT -->
  <div class="card">
    <h2>Attendance</h2>
    <button id="clockInBtn" class="btn"><i class="fa fa-arrow-right-to-bracket"></i> Clock In</button>
    <button id="clockOutBtn" class="btn" style="background:#ef4444;"><i class="fa fa-arrow-right-from-bracket"></i> Clock Out</button>
  </div>

  <!-- HISTORY -->
  <div class="card">
    <h2>Attendance History</h2>
    <table>
      <thead>
        <tr>
          <th>Action</th>
          <th>Date</th>
          <th>Time</th>
        </tr>
      </thead>
      <tbody id="historyTable"></tbody>
    </table>
  </div>

</div>

<!-- TOAST -->
<div id="toast"></div>

<script>
/* ============================================================
   UTILITIES
   ============================================================ */
function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg; t.classList.add("show");
  setTimeout(()=> t.classList.remove("show"),2000);
}

function safeParse(v){ try{ return JSON.parse(v);}catch{return null;} }
function read(k){ return safeParse(localStorage.getItem(k)) || []; }
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

/* ============================================================
   LOADED TEACHER SESSION
   ============================================================ */
const teacher = safeParse(localStorage.getItem("active_teacher"));
if(!teacher){
  alert("Not logged in.");
  location.href="teacher-login.html";
}

document.getElementById("teacherName").textContent = teacher.name;

/* ============================================================
   ORG + HR keys
   ============================================================ */
const ACTIVE_ORG = localStorage.getItem("active_org") || "FLAWLESS";
const EMP_KEY = `${ACTIVE_ORG}_employees`;
const ATT_KEY = `${ACTIVE_ORG}_attendance`;
const T_ATT_KEY = `${ACTIVE_ORG}_teacher_attendance_${teacher.email}`;

/* ============================================================
   Sync teacher into HR Employees
   ============================================================ */
function ensureTeacherInHR(){
  let emps = read(EMP_KEY);
  let found = emps.find(e => e.email === teacher.email);

  if(found) return found.id;

  const newId = "e_" + Date.now();
  const obj = {
    id:newId,
    name:teacher.name,
    role:"Teacher",
    email:teacher.email,
    salary: teacher.salary || 0
  };

  emps.push(obj);
  save(EMP_KEY, emps);

  console.log("Teacher added to HR employee list:", obj);
  return newId;
}

const teacherEmpId = ensureTeacherInHR();

/* ============================================================
   CLOCK-IN / CLOCK-OUT
   ============================================================ */
function record(action){
  // Save personal teacher attendance history
  let tHist = read(T_ATT_KEY);
  const entry = {
    action,
    date: new Date().toISOString()
  };
  tHist.push(entry);
  save(T_ATT_KEY, tHist);

  // Sync to HR
  let hr = read(ATT_KEY);
  hr.push({
    employeeId: teacherEmpId,
    teacherEmail: teacher.email,
    action,
    date: entry.date
  });
  save(ATT_KEY, hr);

  updateHistory();
  updateStatus();
  toast("Attendance recorded: " + action.toUpperCase());
}

document.getElementById("clockInBtn").onclick = ()=> record("in");
document.getElementById("clockOutBtn").onclick = ()=> record("out");

/* ============================================================
   UPDATE STATUS
   ============================================================ */
function updateStatus(){
  const hist = read(T_ATT_KEY);
  const badge = document.getElementById("statusBadge");

  if(hist.length === 0){
    badge.textContent = "Clocked Out";
    badge.className = "status out";
    return;
  }

  const last = hist[hist.length-1];

  if(last.action === "in"){
    badge.textContent = "Clocked In";
    badge.className = "status in";
  } else {
    badge.textContent = "Clocked Out";
    badge.className = "status out";
  }
}

/* ============================================================
   RENDER TABLE
   ============================================================ */
function updateHistory(){
  const hist = read(T_ATT_KEY);
  const tbody = document.getElementById("historyTable");
  tbody.innerHTML = "";

  hist.slice().reverse().forEach(h=>{
    const d = new Date(h.date);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${h.action.toUpperCase()}</td>
      <td>${d.toLocaleDateString()}</td>
      <td>${d.toLocaleTimeString()}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ============================================================
   LOGOUT
   ============================================================ */
document.getElementById("logoutBtn").onclick = ()=>{
  localStorage.removeItem("active_teacher");
  location.href="teacher-login.html";
};

/* ============================================================
   INIT
   ============================================================ */
updateStatus();
updateHistory();
console.log("Teacher Profile Loaded with Sync Active");
</script>

</body>
</html>
