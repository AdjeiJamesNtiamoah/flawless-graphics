<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Edit Profile â€” Teacher</title>
  <link href="teacher-dashboard.css" rel="stylesheet">
</head>
<body>
  <header class="header">
    <div class="brand"><div class="logo">FG</div><div><h1>Profile</h1><div class="small">Edit your info</div></div></div>
    <div class="controls"><button class="btn" onclick="window.location.href='teacher-dashboard.html'">Back</button></div>
  </header>

  <div class="container">
    <div class="card">
      <h3>Profile</h3>
      <div style="display:flex;gap:12px;align-items:center">
        <img id="pfPhoto" src="assets/teacher-default.png" class="file-preview" alt="photo">
        <div style="flex:1">
          <input id="pfName" class="input" placeholder="Full name">
          <input id="pfEmail" class="input" placeholder="Email">
          <input id="pfPhone" class="input" placeholder="Phone">
          <input id="pfSubject" class="input" placeholder="Subject">
          <input id="pfPhotoFile" type="file" accept="image/*">
          <div style="margin-top:8px">
            <button id="saveProfile" class="btn primary">Save</button>
            <button id="changePw" class="btn">Change Password</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Security</h3>
      <p class="small">Change password (teacher account)</p>
      <input id="oldPw" class="input" type="password" placeholder="Old password">
      <input id="newPw" class="input" type="password" placeholder="New password">
      <button id="doChangePw" class="btn primary">Update Password</button>
    </div>
  </div>
<script>
const teacher = JSON.parse(localStorage.getItem("active_teacher"));
if (!teacher) {
    window.location.href = "teacher.html";
}
</script>

  <script>
    // simple profile logic (uses same org teacher list and teacher_accounts)
    function safeParse(s){ try{return JSON.parse(s)}catch(e){return null} }
    function read(k){ return safeParse(localStorage.getItem(k)) || [] }
    function save(k,v){ localStorage.setItem(k, JSON.stringify(v)) }

    const ACTIVE_ORG = (localStorage.getItem('active_org') || '').trim();
    if(!ACTIVE_ORG) { window.location.href='index.html'; }
    const TEACH_KEY = `${ACTIVE_ORG}_teachers`;
    const ACC_KEY = `${ACTIVE_ORG}_teacher_accounts`;
    const session = safeParse(localStorage.getItem('teacher_active_user') || '{}');
    if(!session || !session.email) window.location.href='teacher-login.html';

    // load profile
    const teachers = read(TEACH_KEY);
    const idx = teachers.findIndex(t=> t.email === session.email);
    const teacher = teachers[idx] || {};

    document.getElementById('pfName').value = teacher.fullName || '';
    document.getElementById('pfEmail').value = teacher.email || '';
    document.getElementById('pfPhone').value = teacher.phone || '';
    document.getElementById('pfSubject').value = teacher.subject || '';
    document.getElementById('pfPhoto').src = teacher.photo || 'assets/teacher-default.png';

    document.getElementById('pfPhotoFile').addEventListener('change', (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const r = new FileReader(); r.onload = ()=> document.getElementById('pfPhoto').src = r.result; r.readAsDataURL(f);
    });

    document.getElementById('saveProfile').addEventListener('click', ()=>{
      const name = document.getElementById('pfName').value.trim();
      const email = document.getElementById('pfEmail').value.trim().toLowerCase();
      const phone = document.getElementById('pfPhone').value.trim();
      const subject = document.getElementById('pfSubject').value.trim();
      const photo = document.getElementById('pfPhoto').src;
      if(idx >= 0){ teachers[idx] = { ...teachers[idx], fullName:name, email, phone, subject, photo }; save(TEACH_KEY, teachers); alert('Saved'); localStorage.setItem('teacher_active_user', JSON.stringify({ email, name })); }
      else alert('Profile not found');
    });

    document.getElementById('doChangePw').addEventListener('click', async ()=>{
      const oldPw = document.getElementById('oldPw').value;
      const newPw = document.getElementById('newPw').value;
      if(!oldPw || !newPw) return alert('Fill fields');
      // find account
      const accts = read(ACC_KEY);
      const accIdx = accts.findIndex(a=> a.email === session.email);
      if(accIdx === -1) return alert('Account missing');
      // hash compare
      async function sha(t){ try{ const enc = new TextEncoder(); const buf = enc.encode(t); const h = await crypto.subtle.digest('SHA-256', buf); return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join(''); }catch(e){return t;} }
      const oldHash = await sha(oldPw);
      if(oldHash !== accts[accIdx].passwordHash) return alert('Old password incorrect');
      accts[accIdx].passwordHash = await sha(newPw);
      save(ACC_KEY, accts); alert('Password changed');
    });
  </script>
</body>
</html>
