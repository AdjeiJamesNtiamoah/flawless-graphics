<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Finance Dashboard — Flawless Graphics</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Font Awesome -->
<link rel="stylesheet" 
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- jsPDF (PDF export) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root {
    --primary: #00c3ff;
    --secondary: #00ffbb;
    --dark: #001f3f;
    --light-dark: #0b2b55;
    --bg: #f2f6ff;
    --card-bg: #ffffff;
    --radius: 14px;
}

body {
    margin: 0;
    background: var(--bg);
    font-family: Poppins, Arial;
    display: flex;
    height: 100vh;
    overflow: hidden;
}

/* SIDEBAR */
.sidebar {
    width: 260px;
    background: var(--dark);
    color: white;
    padding: 25px 0;
    display: flex;
    flex-direction: column;
    box-shadow: 4px 0 14px rgba(0,0,0,0.25);
}

.sidebar h2 {
    text-align: center;
    margin-bottom: 25px;
    font-size: 22px;
    letter-spacing: 1px;
}

.nav-item {
    padding: 15px 25px;
    cursor: pointer;
    display: flex;
    gap: 14px;
    align-items: center;
    color: #cde6ff;
    transition: .2s;
}

.nav-item:hover {
    background: var(--light-dark);
    color: white;
}

.nav-item i {
    width: 22px;
}

/* MAIN CONTENT */
.content {
    flex: 1;
    padding: 25px;
    overflow-y: auto;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
}

.header .title {
    font-size: 26px;
    font-weight: 700;
    color: var(--dark);
}

.header-right {
    display: flex;
    gap: 10px;
}

.btn {
    padding: 10px 14px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
}

.btn.primary { background: var(--primary); color: white; }
.btn.success { background: var(--secondary); color: #002d1f; }
.btn.danger { background: #ff4444; color: white; }
.btn.light { background: #e6f0ff; color: #002244; }

/* CARDS */
.card {
    background: var(--card-bg);
    padding: 20px;
    border-radius: var(--radius);
    box-shadow: 0 4px 14px rgba(0,0,0,0.08);
    margin-bottom: 20px;
}

.card-title {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 10px;
}

/* GRID */
.grid {
    display: grid;
    gap: 20px;
}

.kpi {
    display: flex;
    align-items: center;
    gap: 15px;
    background: var(--card-bg);
    padding: 18px;
    border-radius: var(--radius);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.kpi i {
    font-size: 28px;
    color: var(--primary);
}

.kpi .value {
    font-size: 24px;
    font-weight: 800;
}

.kpi .label {
    color: #6c7a8a;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    padding: 12px;
    border-bottom: 1px solid #e2e8f0;
    font-size: 14px;
}

/* Toast */
#toast {
    position: fixed;
    right: 25px;
    bottom: 25px;
    background: var(--dark);
    color: white;
    padding: 14px 18px;
    border-radius: 10px;
    opacity: 0;
    transform: translateY(20px);
    transition: .3s;
}
#toast.show {
    opacity: 1;
    transform: translateY(0);
}
</style>
</head>
<body>

<!---------------- SIDEBAR ---------------->
<div class="sidebar">
    <h2>FINANCE</h2>
    <div class="nav-item" onclick="scrollToSection('dashboard')">
        <i class="fa fa-chart-line"></i> Dashboard
    </div>

    <div class="nav-item" onclick="scrollToSection('pendingPayroll')">
        <i class="fa fa-sack-dollar"></i> Pending Payroll
    </div>

    <div class="nav-item" onclick="scrollToSection('approvedPayroll')">
        <i class="fa fa-check-circle"></i> Approved Payroll
    </div>

    <div class="nav-item" onclick="scrollToSection('salaryAdvances')">
        <i class="fa fa-coins"></i> Salary Advances
    </div>

    <div class="nav-item" onclick="scrollToSection('messages')">
        <i class="fa fa-envelope"></i> Finance Messages
    </div>

    <div class="nav-item" onclick="scrollToSection('audit')">
        <i class="fa fa-history"></i> Audit Trail
    </div>

    <div class="nav-item" onclick="window.location.href='index.html'">
        <i class="fa fa-door-open"></i> Exit
    </div>
</div>

<!---------------- MAIN CONTENT ---------------->
<div class="content">
    
    <div class="header">
        <div class="title">Finance Dashboard — <span id="orgDisplay"></span></div>

        <div class="header-right">
            <button class="btn light" id="switchOrgBtn"><i class="fa fa-building"></i></button>
            <button class="btn success" id="exportFinancePDF"><i class="fa fa-file-pdf"></i> Export</button>
              <a href="welcome.html" style="color:var(--muted);text-decoration:none">← Home</a>
        </div>
    </div>

    <!-- KPI CARDS -->
    <div id="dashboard" class="grid" 
         style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));">

        <div class="kpi">
            <i class="fa fa-sack-dollar"></i>
            <div>
                <div class="value" id="kpiPending">0</div>
                <div class="label">Pending Payroll</div>
            </div>
        </div>

        <div class="kpi">
            <i class="fa fa-circle-check"></i>
            <div>
                <div class="value" id="kpiApproved">0</div>
                <div class="label">Approved This Month</div>
            </div>
        </div>

        <div class="kpi">
            <i class="fa fa-coins"></i>
            <div>
                <div class="value" id="kpiAdvances">0</div>
                <div class="label">Active Salary Advances</div>
            </div>
        </div>

        <div class="kpi">
            <i class="fa fa-users"></i>
            <div>
                <div class="value" id="kpiEmployees">0</div>
                <div class="label">Total Employees</div>
            </div>
        </div>
    </div>
    <!-- === Pending Payroll === -->
    <section id="pendingPayroll" class="card" style="margin-top:18px;">
      <div class="card-title">Pending Payroll Requests</div>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="tiny">HR submits payroll batches here for Finance approval / payment.</div>
        <div style="display:flex;gap:8px">
          <button class="btn" id="refreshPending">Refresh</button>
          <button class="btn primary" id="bulkApproveBtn">Approve All Visible</button>
        </div>
      </div>

      <div style="margin-top:12px; overflow:auto;">
        <table>
          <thead>
            <tr><th>#</th><th>Batch ID</th><th>Submitted By</th><th>Period</th><th>Total</th><th>Status</th><th>Actions</th></tr>
          </thead>
          <tbody id="pendingTable"></tbody>
        </table>
      </div>
    </section>

    <!-- === Approved Payroll === -->
    <section id="approvedPayroll" class="card" style="margin-top:18px; display:none;">
      <div class="card-title">Approved / Paid Payroll</div>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="tiny">History of approved payrolls and payments.</div>
        <div style="display:flex;gap:8px">
          <button class="btn" id="exportPayrollCsv">Export CSV</button>
          <button class="btn" id="exportPayrollPdf">Export PDF</button>
        </div>
      </div>

      <div style="margin-top:12px; overflow:auto;">
        <table>
          <thead><tr><th>#</th><th>Batch ID</th><th>Approved By</th><th>Period</th><th>Total</th><th>Paid On</th><th>Details</th></tr></thead>
          <tbody id="approvedTable"></tbody>
        </table>
      </div>
    </section>

    <!-- === Salary Advances === -->
    <section id="salaryAdvances" class="card" style="margin-top:18px; display:none;">
      <div class="card-title">Salary Advances</div>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="tiny">Employees can request advances; Finance approves/rejects.</div>
        <div>
          <button class="btn primary" id="newAdvanceBtn">New Advance</button>
        </div>
      </div>

      <div style="margin-top:12px; overflow:auto;">
        <table>
          <thead><tr><th>#</th><th>Request ID</th><th>Employee</th><th>Amount</th><th>Reason</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="advancesTable"></tbody>
        </table>
      </div>
    </section>

    <!-- === Messages (Finance ↔ HR) === -->
    <section id="messages" class="card" style="margin-top:18px; display:none;">
      <div class="card-title">Finance Messages</div>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="msgTo" placeholder="To (hr or email)" style="flex:1; padding:8px">
        <input id="msgSubject" placeholder="Subject" style="width:260px; padding:8px">
      </div>
      <textarea id="msgBody" rows="4" style="width:100%; margin-top:8px; padding:8px" placeholder="Message body"></textarea>
      <div style="margin-top:8px; display:flex; gap:8px;">
        <button class="btn primary" id="sendMsgBtn">Send</button>
        <button class="btn" id="loadMsgsBtn">Refresh</button>
      </div>

      <div style="margin-top:12px; max-height:320px; overflow:auto;">
        <table>
          <thead><tr><th>#</th><th>From</th><th>To</th><th>Subject</th><th>Date</th></tr></thead>
          <tbody id="messagesTable"></tbody>
        </table>
      </div>
    </section>

    <!-- === Audit Trail === -->
    <section id="audit" class="card" style="margin-top:18px; display:none;">
      <div class="card-title">Audit Trail</div>
      <div id="auditLog" style="max-height:420px; overflow:auto; margin-top:8px;"></div>
    </section>

    <!-- Toast -->
    <div id="toast"></div>
  </div> <!-- end .content -->
<div class="card">
    <div class="card-title">Pending Payroll Approval</div>
    <table id="pendingPayrollTable">
        <thead>
            <tr>
                <th>Employee</th>
                <th>Salary</th>
                <th>Month</th>
                <th>Status</th>
                <th>Pay</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
<div id="paymentModal" style="display:none; position:fixed; 
    top:0; left:0; width:100%; height:100%; 
    background:rgba(0,0,0,0.6); 
    align-items:center; justify-content:center;">
    
    <div style="background:white; padding:25px; width:420px; border-radius:14px;">
        <h3>Process Salary Payment</h3>

        <label>Choose Payment Method</label>
        <select id="paymentMethod" class="input">
            <option value="momo">Mobile Money</option>
            <option value="bank">Bank Transfer</option>
            <option value="wallet">Internal Wallet</option>
        </select>

        <label>Select Linked Account</label>
        <select id="linkedAccount" class="input"></select>

        <button class="btn primary" onclick="confirmPayment()">Confirm & Pay</button>
        <button class="btn danger" onclick="closePaymentModal()">Cancel</button>
    </div>
</div>
<div class="card">
    <div class="card-title">Linked Payment Accounts</div>

    <div id="linkedAccountsList"></div>

    <h4>Add New Account</h4>
    <select id="accType" class="input">
        <option value="momo">Mobile Money</option>
        <option value="bank">Bank Account</option>
        <option value="wallet">Internal Wallet</option>
    </select>

    <input id="accName" class="input" placeholder="Account Name">
    <input id="accNumber" class="input" placeholder="Account Number">

    <button class="btn success" onclick="addPaymentAccount()">Add Account</button>
</div>
<!-- ============================
     SCRIPT: Finance Logic
     ============================ -->
<script>
/* ---------- Utilities ---------- */
function safeParse(s){ try{ return JSON.parse(s) } catch(e){ return null } }
function read(key){ return safeParse(localStorage.getItem(key)) || [] }
function save(key,val){ localStorage.setItem(key, JSON.stringify(val)) }
function uid(prefix='id'){ return prefix + '_' + Date.now().toString(36) }
function show(msg, ms=2500){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), ms) }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }

/* ---------- Keys & Namespacing ---------- */
const ORG = localStorage.getItem('active_org') || 'FLAWLESS';
document.getElementById('orgDisplay').textContent = ORG;
const HR_PAYROLL_KEY = `${ORG}_hr_payroll_batches`;     // HR -> Finance pending batches
const FIN_APPROVED_KEY = `${ORG}_finance_approved_batches`; // Finance approved/payout history
const FIN_MSG_KEY = `${ORG}_finance_messages`;         // Finance messages
const FIN_AUDIT_KEY = `${ORG}_finance_audit`;          // Audit trail
const TEACH_ATT_KEY = `${ORG}_teacher_attendance`;     // teacher attendance sync (teacher pages push here)
const ORG_ATT_KEY = `${ORG}_attendance`;               // alternate teacher key

/* ensure keys exist */
if(!localStorage.getItem(HR_PAYROLL_KEY)) save(HR_PAYROLL_KEY, []);
if(!localStorage.getItem(FIN_APPROVED_KEY)) save(FIN_APPROVED_KEY, []);
if(!localStorage.getItem(FIN_MSG_KEY)) save(FIN_MSG_KEY, []);
if(!localStorage.getItem(FIN_AUDIT_KEY)) save(FIN_AUDIT_KEY, []);

/* ---------- NAV helper (sidebar scrolling) ---------- */
function scrollToSection(id){
  const sec = document.getElementById(id);
  if(!sec) return;
  // hide others and show target (mimic tabs)
  ['pendingPayroll','approvedPayroll','salaryAdvances','messages','audit'].forEach(sid=>{
    const el = document.getElementById(sid);
    if(el) el.style.display = (sid===id) ? 'block' : 'none';
  });
  // ensure dashboard visible state
  if(id === 'dashboard'){
    ['pendingPayroll','approvedPayroll','salaryAdvances','messages','audit'].forEach(sid=>{
      const el = document.getElementById(sid);
      if(el) el.style.display = 'none';
    });
    document.getElementById('dashboard').scrollIntoView({behavior:'smooth'});
  } else {
    document.getElementById('dashboard').scrollIntoView({behavior:'smooth'});
    document.getElementById(id).scrollIntoView({behavior:'smooth'});
  }
}

/* ---------- Audit ---------- */
function pushAudit(actor, action, payload=''){
  const arr = read(FIN_AUDIT_KEY);
  arr.push({ id: uid('audit'), actor, action, payload, time: new Date().toISOString() });
  save(FIN_AUDIT_KEY, arr);
  renderAudit();
}

/* ---------- Render audit ---------- */
function renderAudit(){
  const arr = read(FIN_AUDIT_KEY).slice().reverse();
  const out = document.getElementById('auditLog');
  if(!arr.length) { out.innerHTML = '<div class="tiny">No audit records</div>'; return; }
  out.innerHTML = arr.map(a => `<div style="padding:8px;border-bottom:1px solid rgba(0,0,0,0.06)"><strong>${escapeHtml(a.actor)}</strong> — ${escapeHtml(a.action)} <div class="tiny" style="color:#666">${new Date(a.time).toLocaleString()}</div><div class="tiny">${escapeHtml(a.payload)}</div></div>`).join('');
}

/* ---------- Pending payroll rendering ---------- */
function renderPending(){
  const arr = read(HR_PAYROLL_KEY).slice().reverse();
  const tbody = document.getElementById('pendingTable');
  tbody.innerHTML = '';
  arr.forEach((b, i) => {
    const status = b.status || 'pending';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td>
      <td>${escapeHtml(b.batchId)}</td>
      <td>${escapeHtml(b.submittedBy||'HR')}</td>
      <td>${escapeHtml(b.period||'—')}</td>
      <td>${formatCurrency(b.total || 0)}</td>
      <td>${escapeHtml(status)}</td>
      <td>
        <button onclick="viewBatch('${b.batchId}')">View</button>
        ${status === 'pending' ? `<button onclick="approveBatch('${b.batchId}')">Approve</button><button onclick="rejectBatch('${b.batchId}')">Reject</button>` : ''}
      </td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('kpiPending').textContent = arr.filter(x=> (x.status||'pending') === 'pending').length;
}

/* ---------- Approved payroll rendering ---------- */
function renderApproved(){
  const arr = read(FIN_APPROVED_KEY).slice().reverse();
  const tbody = document.getElementById('approvedTable');
  tbody.innerHTML = '';
  arr.forEach((b,i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td>
      <td>${escapeHtml(b.batchId)}</td>
      <td>${escapeHtml(b.approvedBy||'Finance')}</td>
      <td>${escapeHtml(b.period||'—')}</td>
      <td>${formatCurrency(b.total||0)}</td>
      <td>${b.paidOn ? new Date(b.paidOn).toLocaleString() : '—'}</td>
      <td><button onclick="viewApproved('${b.batchId}')">Details</button></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('kpiApproved').textContent = arr.length;
}

/* ---------- Salary advances rendering ---------- */
function getAdvances(){ return read(`${ORG}_salary_advances`) }
function saveAdvances(a){ save(`${ORG}_salary_advances`, a) }
if(!localStorage.getItem(`${ORG}_salary_advances`)) saveAdvances([]);

function renderAdvances(){
  const arr = getAdvances().slice().reverse();
  const tbody = document.getElementById('advancesTable'); tbody.innerHTML = '';
  arr.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${r.requestId}</td><td>${escapeHtml(r.employee)}</td><td>${formatCurrency(r.amount)}</td><td>${escapeHtml(r.reason||'')}</td><td>${escapeHtml(r.status)}</td>
      <td>
        ${r.status==='pending' ? `<button onclick="approveAdvance('${r.requestId}')">Approve</button><button onclick="rejectAdvance('${r.requestId}')">Reject</button>` : ''}
      </td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('kpiAdvances').textContent = arr.filter(x=>x.status==='approved').length;
}

/* ---------- Messages ---------- */
function getFinanceMsgs(){ return read(FIN_MSG_KEY) }
function saveFinanceMsgs(m){ save(FIN_MSG_KEY, m) }

document.getElementById('sendMsgBtn').addEventListener('click', ()=>{
  const to = document.getElementById('msgTo').value.trim();
  const subj = document.getElementById('msgSubject').value.trim();
  const body = document.getElementById('msgBody').value.trim();
  if(!subj || !body) return show('Complete subject & message');
  const arr = getFinanceMsgs();
  arr.push({ id: uid('msg'), from: 'finance@'+ORG.toLowerCase()+'.local', to, subject: subj, body, date: new Date().toISOString() });
  saveFinanceMsgs(arr);
  pushAudit('Finance', `Sent message to ${to}`, `${subj}`);
  renderMessages();
  show('Message sent');
  document.getElementById('msgTo').value=''; document.getElementById('msgSubject').value=''; document.getElementById('msgBody').value='';
});

function renderMessages(){
  const arr = getFinanceMsgs().slice().reverse();
  const tbody = document.getElementById('messagesTable'); tbody.innerHTML='';
  arr.forEach((m,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(m.from)}</td><td>${escapeHtml(m.to)}</td><td>${escapeHtml(m.subject)}</td><td>${new Date(m.date).toLocaleString()}</td>`;
    tbody.appendChild(tr);
  });
}

/* ---------- Batch view / approve / reject ---------- */
function viewBatch(batchId){
  const arr = read(HR_PAYROLL_KEY);
  const b = arr.find(x=>x.batchId===batchId);
  if(!b) return show('Batch not found');
  // show details in prompt (simpler than modal)
  const details = (b.items||[]).map(it=> `${it.employee} — ${formatCurrency(it.amount)} — ${it.bank||'N/A'}`).join('\\n');
  alert(`Batch ${b.batchId}\\nSubmitted by: ${b.submittedBy}\\nPeriod: ${b.period}\\nTotal: ${formatCurrency(b.total)}\\n\\nItems:\\n${details}`);
}

function approveBatch(batchId){
  const arr = read(HR_PAYROLL_KEY);
  const idx = arr.findIndex(x=>x.batchId===batchId);
  if(idx === -1) return show('Not found');
  const batch = arr[idx];
  if(batch.status && batch.status !== 'pending') return show('Batch already processed');

  // move to finance approved key
  const approved = read(FIN_APPROVED_KEY);
  const approvedRecord = Object.assign({}, batch, { approvedBy: 'finance@'+ORG.toLowerCase()+'.local', approvedAt: new Date().toISOString(), paidOn: new Date().toISOString(), status: 'approved' });
  approved.push(approvedRecord);
  save(FIN_APPROVED_KEY, approved);

  // mark original HR batch as approved
  batch.status = 'approved';
  batch.processedAt = new Date().toISOString();
  save(HR_PAYROLL_KEY, arr);

  pushAudit('Finance', 'Approved payroll batch', batch.batchId);
  // notify HR (message push)
  const msgs = getFinanceMsgs();
  msgs.push({ id: uid('msg'), from:'finance@'+ORG.toLowerCase()+'.local', to: batch.submittedBy || 'hr@'+ORG.toLowerCase()+'.local', subject: `Payroll batch ${batch.batchId} approved`, body: `Your payroll batch ${batch.batchId} has been approved and paid.`, date: new Date().toISOString() });
  saveFinanceMsgs(msgs);

  renderPending(); renderApproved(); show('Batch approved & paid');
}

function rejectBatch(batchId){
  const arr = read(HR_PAYROLL_KEY);
  const b = arr.find(x=>x.batchId===batchId);
  if(!b) return show('Not found');
  const reason = prompt('Reason for rejection', 'Incorrect totals');
  b.status = 'rejected';
  b.rejectedBy = 'finance@'+ORG.toLowerCase()+'.local';
  b.rejectionReason = reason || '';
  b.processedAt = new Date().toISOString();
  save(HR_PAYROLL_KEY, arr);
  pushAudit('Finance', 'Rejected payroll batch', `${batchId} — ${reason}`);
  // notify HR
  const msgs = getFinanceMsgs(); msgs.push({ id: uid('msg'), from: 'finance@'+ORG.toLowerCase()+'.local', to: b.submittedBy || 'hr@'+ORG.toLowerCase()+'.local', subject: `Payroll ${batchId} rejected`, body: reason || 'See notes', date: new Date().toISOString() }); saveFinanceMsgs(msgs);
  renderPending(); renderMessages(); show('Batch rejected');
}

/* Bulk approve visible */
document.getElementById('bulkApproveBtn').addEventListener('click', ()=>{
  const arr = read(HR_PAYROLL_KEY);
  const pending = arr.filter(x=> (x.status||'pending') === 'pending');
  if(!pending.length) return show('No pending batches');
  if(!confirm(`Approve ${pending.length} pending batches?`)) return;
  pending.forEach(b => approveBatch(b.batchId));
  show('Bulk approved');
});

/* ---------- Advance requests ---------- */
document.getElementById('newAdvanceBtn').addEventListener('click', ()=>{
  const employee = prompt('Employee name (email optional)');
  if(!employee) return show('Cancelled');
  const amount = Number(prompt('Amount', '0')||0);
  if(!amount) return show('Invalid amount');
  const reason = prompt('Reason','') || '';
  const arr = getAdvances();
  const req = { requestId: uid('adv'), employee, amount, reason, status: 'pending', requestedAt: new Date().toISOString() };
  arr.push(req); saveAdvances(arr); pushAudit('Finance', 'Created advance request', req.requestId); renderAdvances(); show('Advance requested');
});

function approveAdvance(requestId){
  const arr = getAdvances();
  const r = arr.find(x=>x.requestId===requestId);
  if(!r) return show('Not found');
  r.status = 'approved'; r.approvedAt = new Date().toISOString(); saveAdvances(arr);
  pushAudit('Finance', 'Approved advance', requestId);
  show('Advance approved');
  renderAdvances();
}

function rejectAdvance(requestId){
  const arr = getAdvances();
  const r = arr.find(x=>x.requestId===requestId);
  if(!r) return show('Not found');
  const reason = prompt('Reason for rejection','');
  r.status = 'rejected'; r.rejectionReason = reason || ''; saveAdvances(arr);
  pushAudit('Finance', 'Rejected advance', requestId+' — '+(reason||''));
  show('Advance rejected');
  renderAdvances();
}

/* ---------- View approved details ---------- */
function viewApproved(batchId){
  const arr = read(FIN_APPROVED_KEY);
  const b = arr.find(x=>x.batchId===batchId);
  if(!b) return show('Not found');
  const lines = (b.items||[]).map(it=> `${it.employee} — ${formatCurrency(it.amount)} — ${it.bank||'N/A'}`).join('\\n');
  alert(`Approved Batch ${b.batchId}\\nApproved by: ${b.approvedBy}\\nPeriod: ${b.period}\\nTotal: ${formatCurrency(b.total)}\\nPaid On: ${b.paidOn}\\n\\nItems:\\n${lines}`);
}

/* ---------- Exports ---------- */
document.getElementById('exportPayrollCsv').addEventListener('click', ()=>{
  const rows = read(FIN_APPROVED_KEY).map(b => ({ batchId: b.batchId, approvedBy: b.approvedBy, period: b.period, total: b.total, paidOn: b.paidOn }));
  if(!rows.length) return show('No approved payroll to export');
  exportCSV(rows, `${ORG}_approved_payroll_${Date.now()}.csv`);
});

document.getElementById('exportPayrollPdf').addEventListener('click', ()=>{
  const approved = read(FIN_APPROVED_KEY).slice().reverse();
  if(!approved.length) return show('No approved payroll');
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','pt','a4'); doc.setFontSize(14); doc.text(`${ORG} — Approved Payroll`, 40, 40); let y=70;
  approved.forEach((b,i)=>{
    doc.text(`${i+1}. ${b.batchId} • ${b.period} • ${formatCurrency(b.total)} • ${b.paidOn ? new Date(b.paidOn).toLocaleString() : '—'}`, 40, y);
    y+=14; if(y>720){ doc.addPage(); y=40; }
  });
  doc.save(`${ORG}_approved_payroll_${Date.now()}.pdf`);
});

/* ---------- CSV helper ---------- */
function exportCSV(rows, filename){
  if(!rows.length) return;
  const keys = Object.keys(rows[0]);
  const lines = [keys.join(',')];
  rows.forEach(r=> lines.push(keys.map(k=>`"${String(r[k]||'').replace(/"/g,'""')}"`).join(',')));
  const blob = new Blob([lines.join('\\n')], { type:'text/csv' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
}

/* ---------- Helper: format currency ---------- */
function formatCurrency(n){ const fmt = new Intl.NumberFormat(undefined,{ style:'currency', currency: 'GHS', maximumFractionDigits:2 }); try{ return fmt.format(Number(n||0)) }catch(e){ return 'GHS ' + Number(n||0).toFixed(2) } }

/* ---------- Teacher attendance sync rendering ---------- */
function renderTeacherSync(){
  const arr1 = read(TEACH_ATT_KEY) || [];
  const arr2 = read(ORG_ATT_KEY) || [];
  const all = (arr1.concat(arr2)).slice().reverse();
  const el = document.getElementById('kpiEmployees'); // reuse KPI to show employees count too
  document.getElementById('kpiEmployees').textContent = /* fallback count */ (read(`${ORG}_employees`) || []).length || all.length || 0;
  const widget = document.getElementById('teacherSync');
  const joined = all.slice(0,5).map(a => `${a.email||a.employee||a.name||'T'} ${a.action||''} @ ${new Date(a.date||a.time||a.createdAt||Date.now()).toLocaleTimeString()}`).join('\\n');
  widget && (widget.textContent = all.length ? (all[0].email||all[0].employee||'Teacher') + ' — ' + (all[0].action||'') + ' — ' + new Date(all[0].date||all[0].time||Date.now()).toLocaleString() : 'No teacher attendance records');
}

/* ---------- Seed / Demo helpers (only if HR batches empty) ---------- */
(function seedDemoPayroll(){
  const hr = read(HR_PAYROLL_KEY);
  if(hr.length) return;
  // create sample HR batch
  const sample = {
    batchId: 'BATCH_' + Date.now().toString(36).slice(-6).toUpperCase(),
    submittedBy: 'hr@' + ORG.toLowerCase() + '.local',
    period: new Date().toISOString().split('T')[0],
    items: [
      { employee: 'Adjei James', account: 'ACCT-001', bank: 'Bank A', amount: 1200 },
      { employee: 'Ama Serwaa', account: 'ACCT-002', bank: 'Bank B', amount: 1100 },
      { employee: 'Kofi Mensah', account: 'ACCT-003', bank: 'Bank C', amount: 1000 }
    ],
    total: 3300,
    status: 'pending',
    submittedAt: new Date().toISOString()
  };
  hr.push(sample);
  save(HR_PAYROLL_KEY, hr);
  pushAudit('System', 'Seeded demo payroll batch', sample.batchId);
})();

/* ---------- Render everything ---------- */
function renderAll(){
  renderPending();
  renderApproved();
  renderAdvances();
  renderMessages();
  renderAudit();
  renderTeacherSync();
}
renderAll();

/* ---------- Wire refresh button ---------- */
document.getElementById('refreshBtn').addEventListener('click', ()=>{ renderAll(); show('Refreshed') });
document.getElementById('refreshPending').addEventListener('click', ()=>{ renderPending(); show('Pending refreshed') });

/* ---------- Storage sync across tabs (teacher pages push attendance) ---------- */
window.addEventListener('storage', (e)=>{
  const keys = [HR_PAYROLL_KEY, FIN_APPROVED_KEY, `${ORG}_salary_advances`, FIN_MSG_KEY, FIN_AUDIT_KEY, TEACH_ATT_KEY, ORG_ATT_KEY];
  if(keys.includes(e.key)){
    // small debounce
    setTimeout(()=> renderAll(), 120);
  }
});

/* expose small API for HR pages to push payroll batches and teacher attendance */
window.financeAPI = {
  pushPayrollBatch: function(batch){
    const arr = read(HR_PAYROLL_KEY);
    batch.batchId = batch.batchId || uid('batch');
    batch.status = 'pending';
    batch.submittedAt = new Date().toISOString();
    arr.push(batch);
    save(HR_PAYROLL_KEY, arr);
    pushAudit('HR', 'Submitted payroll batch', batch.batchId);
    renderAll();
    return batch.batchId;
  },
  markApproved: function(batchId){
    approveBatch(batchId);
  },
  pushTeacherAttendance: function(rec){
    const arr = read(TEACH_ATT_KEY);
    arr.push(Object.assign({}, rec, { createdAt: new Date().toISOString() }));
    save(TEACH_ATT_KEY, arr);
    renderTeacherSync();
  }
};


      
function loadPendingPayroll() {
    const table = document.querySelector("#pendingPayrollTable tbody");
    table.innerHTML = "";

    const payroll = JSON.parse(localStorage.getItem("finance_pending_payroll") || "[]");

    payroll.forEach((p, index) => {
        table.innerHTML += `
            <tr>
                <td>${p.name}</td>
                <td>₵${p.salary}</td>
                <td>${p.month}</td>
                <td>${p.status || "Pending"}</td>
                <td>
                    <button class="btn success" onclick="openPaymentScreen(${index})">
                        Pay Now
                    </button>
                </td>
            </tr>
        `;
    });
}
loadPendingPayroll();
      
function addPaymentAccount() {
    let accounts = JSON.parse(localStorage.getItem("finance_accounts") || "[]");

    const type = accType.value;
    const name = accName.value.trim();
    const number = accNumber.value.trim();

    if (!name || !number) return alert("Fill all fields");

    accounts.push({ type, name, number });

    localStorage.setItem("finance_accounts", JSON.stringify(accounts));

    loadAccounts();
    alert("Account added!");
}

function loadAccounts() {
    let accounts = JSON.parse(localStorage.getItem("finance_accounts") || "[]");
    linkedAccountsList.innerHTML = "";
    linkedAccount.innerHTML = "";

    accounts.forEach(acc => {
        linkedAccountsList.innerHTML += `
            <p><strong>${acc.name}</strong> (${acc.type}) — ${acc.number}</p>
        `;

        linkedAccount.innerHTML += `
            <option>${acc.name} — ${acc.number}</option>
        `;
    });
}
loadAccounts();

let activePayrollIndex = null;

function openPaymentScreen(index) {
    activePayrollIndex = index;
    document.getElementById("paymentModal").style.display = "flex";
}

function closePaymentModal() {
    document.getElementById("paymentModal").style.display = "none";
}

function confirmPayment() {
    const payroll = JSON.parse(localStorage.getItem("finance_pending_payroll") || "[]");
    const pay = payroll[activePayrollIndex];

    pay.status = "Paid";
    pay.paidVia = paymentMethod.value;
    pay.account = linkedAccount.value;
    pay.paidAt = new Date().toISOString();

    // Save payment record
    let log = JSON.parse(localStorage.getItem("finance_payments") || "[]");
    log.push(pay);

    localStorage.setItem("finance_payments", JSON.stringify(log));
    localStorage.setItem("finance_pending_payroll", JSON.stringify(payroll));

    closePaymentModal();
    loadPendingPayroll();
    alert("Payment successful!");
}

</script>
</body>
</html>
