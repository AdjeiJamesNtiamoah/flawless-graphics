<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Finance Dashboard | Flawless Graphics</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
/* -------------------- COLORS -------------------- */
:root {
  --primary:#007bff;
  --primary-light:#3ba1ff;
  --accent:#00d98f;
  --danger:#ff4b4b;
  --warning:#ffb400;
  --bg:#f5f7fa;
  --sidebar-bg:#0e1a35;
  --text-dark:#1f2937;
  --card-bg:#ffffff;
  --radius:14px;
}

/* Dark mode */
.dark {
  --bg:#0d1117;
  --card-bg:#161b22;
  --sidebar-bg:#0b0f14;
  --text-dark:#e5e7eb;
  --primary:#3b82f6;
}

/* -------------------- BASE -------------------- */
body {
  margin:0;
  background:var(--bg);
  font-family:Poppins, Arial;
  color:var(--text-dark);
  display:flex;
  height:100vh;
  overflow:hidden;
}

/* -------------------- SIDEBAR -------------------- */
.sidebar {
  width:260px;
  background:var(--sidebar-bg);
  color:white;
  display:flex;
  flex-direction:column;
  padding:20px;
  box-shadow:4px 0 20px rgba(0,0,0,.25);
}

.sidebar h2 {
  text-align:center;
  margin:0 0 20px;
  font-size:22px;
  font-weight:700;
}

.nav-item {
  padding:14px 16px;
  margin-bottom:5px;
  cursor:pointer;
  display:flex;
  gap:12px;
  align-items:center;
  border-radius:10px;
  color:#d0d7e3;
  transition:.2s;
}
.nav-item:hover, .nav-item.active {
  background:#1b2a4a;
  color:white;
}

.nav-item i { width:22px; }

/* -------------------- CONTENT -------------------- */
.content {
  flex:1;
  overflow:auto;
  padding:25px;
}

/* Header */
.header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:25px;
}

.header .title {
  font-size:26px;
  font-weight:700;
}

.header-buttons {
  display:flex;
  gap:10px;
}

.btn {
  padding:10px 14px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
  transition:.2s;
}

.btn.primary { background:var(--primary); color:white; }
.btn.light { background:#e5e7eb; }
.btn.danger { background:var(--danger); color:white; }

/* KPI Cards */
.grid { display:grid; gap:18px; }

.kpi {
  background:var(--card-bg);
  padding:22px;
  border-radius:var(--radius);
  display:flex;
  align-items:center;
  gap:18px;
  box-shadow:0 4px 14px rgba(0,0,0,.08);
}

.kpi i {
  font-size:28px;
  padding:16px;
  background:rgba(59,130,246,0.18);
  border-radius:50%;
  color:var(--primary);
}

.kpi .value {
  font-size:26px;
  font-weight:700;
}

.kpi .label {
  color:gray;
  font-size:14px;
}

/* Section card */
.card {
  background:var(--card-bg);
  padding:22px;
  border-radius:var(--radius);
  margin-bottom:22px;
  box-shadow:0 6px 18px rgba(0,0,0,.09);
}

.card-title {
  font-size:20px;
  margin-bottom:12px;
  font-weight:700;
}

/* Transactions UI */
.tx-grid { display:grid; grid-template-columns: 1fr 420px; gap:18px; align-items:start; }
.form-row { display:flex; gap:8px; margin-bottom:8px; }
.input, select { padding:8px 10px; border-radius:8px; border:1px solid #e5e7eb; width:100%; }
.small { font-size:13px; color:#6b7280; }

.tx-table { width:100%; border-collapse:collapse; margin-top:8px; }
.tx-table th, .tx-table td { padding:10px; border-bottom:1px solid #eef2f7; font-size:14px; text-align:left; }

/* responsive adjustments */
@media(max-width:1100px){ .tx-grid{ grid-template-columns:1fr } .sidebar{display:none} }

/* Toast */
#toast {
  position:fixed;
  right:25px;
  bottom:25px;
  background:#1e293b;
  color:white;
  padding:14px 18px;
  border-radius:12px;
  opacity:0;
  transform:translateY(20px);
  transition:.3s;
}
#toast.show { opacity:1; transform:translateY(0); }

</style>
</head>

<body>

<!-- -------------------- SIDEBAR -------------------- -->
<div class="sidebar">

  <h2>FINANCE PANEL</h2>

  <div class="nav-item active" data-page="overview">
    <i class="fa fa-chart-line"></i> Overview
  </div>

  <div class="nav-item" data-page="transactions">
    <i class="fa fa-wallet"></i> Income & Expenses
  </div>

  <div class="nav-item" data-page="fees">
    <i class="fa fa-coins"></i> Fee Collection
  </div>

  <div class="nav-item" data-page="payroll">
    <i class="fa fa-money-bill-wave"></i> Payroll
  </div>

  <div class="nav-item" data-page="budget">
    <i class="fa fa-chart-pie"></i> Budget Planner
  </div>

  <div class="nav-item" data-page="audit">
    <i class="fa fa-clipboard-list"></i> Audit Logs
  </div>

  <div class="nav-item" data-page="settings">
    <i class="fa fa-cog"></i> Settings
  </div>

</div>

<!-- -------------------- CONTENT AREA -------------------- -->
<div class="content">

  <div class="header">
    <div class="title">Finance Dashboard — <span id="orgName">FLAWLESS</span></div>

    <div class="header-buttons">
      <button class="btn light" id="themeToggle"><i class="fa fa-moon"></i></button>
      <button class="btn primary" id="exportPDF">Export PDF</button>
    </div>
  </div>

  <!-- -------- KPI CARDS -------- -->
  <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); margin-bottom:20px;">

    <div class="kpi">
      <i class="fa fa-arrow-trend-up"></i>
      <div>
        <div class="value" id="totalIncome">₵0</div>
        <div class="label">Total Income</div>
      </div>
    </div>

    <div class="kpi">
      <i class="fa fa-arrow-trend-down"></i>
      <div>
        <div class="value" id="totalExpenses">₵0</div>
        <div class="label">Total Expenses</div>
      </div>
    </div>

    <div class="kpi">
      <i class="fa fa-wallet"></i>
      <div>
        <div class="value" id="netBalance">₵0</div>
        <div class="label">Net Balance</div>
      </div>
    </div>

    <div class="kpi">
      <i class="fa fa-coins"></i>
      <div>
        <div class="value" id="feesCollected">₵0</div>
        <div class="label">Fees Collected</div>
      </div>
    </div>

  </div>

  <!-- -------- OVERVIEW CHART -------- -->
  <div class="card">
    <div class="card-title">Finance Overview Chart</div>
    <canvas id="overviewChart" height="120"></canvas>
  </div>

  <!-- -------- SECTIONS (hidden/shown by nav) -------- -->
  <section id="overviewSection" class="card" style="margin-bottom:18px;">
    <h3 class="card-title">Quick Overview</h3>
    <div class="small">This overview summarizes recent financial activity; use the side nav to manage transactions, payroll and fees.</div>
    <div id="recentTx" style="margin-top:12px"></div>
  </section>

  <section id="transactionsSection" class="card" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><h3 class="card-title">Income & Expenses</h3><div class="small">Add and manage transactions.</div></div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="exportTxCSV">Export CSV</button>
        <button class="btn" id="clearTx">Clear Transactions</button>
      </div>
    </div>

    <div class="tx-grid" style="margin-top:12px">
      <!-- left: list -->
      <div>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <select id="filterType" class="input" style="width:160px">
            <option value="">All types</option>
            <option value="income">Income</option>
            <option value="expense">Expense</option>
          </select>
          <input id="filterSearch" class="input" placeholder="Search description or category">
          <input type="date" id="filterFrom" class="input" style="width:150px">
          <input type="date" id="filterTo" class="input" style="width:150px">
          <button class="btn" id="applyFilters">Apply</button>
        </div>

        <table class="tx-table">
          <thead>
            <tr><th>Date</th><th>Type</th><th>Category</th><th>Description</th><th style="text-align:right">Amount</th><th>Actions</th></tr>
          </thead>
          <tbody id="txTableBody"></tbody>
        </table>
      </div>

      <!-- right: add form and charts -->
      <div>
        <div style="margin-bottom:12px">
          <div class="card-title">Add Transaction</div>
          <div class="form-row"><select id="txType" class="input"><option value="income">Income</option><option value="expense">Expense</option></select></div>
          <div class="form-row"><input id="txDate" type="date" class="input"></div>
          <div class="form-row"><input id="txCategory" class="input" placeholder="Category (e.g. Tuition, Utilities)"></div>
          <div class="form-row"><input id="txDesc" class="input" placeholder="Description"></div>
          <div class="form-row"><input id="txAmount" class="input" placeholder="Amount (numeric)"></div>
          <div style="display:flex;gap:8px"><button class="btn primary" id="addTxBtn">Add</button><button class="btn" id="clearFormBtn">Clear</button></div>
        </div>

        <div style="margin-top:12px">
          <div class="card-title">Monthly Tx Chart</div>
          <canvas id="txChart" height="220"></canvas>
        </div>
      </div>
    </div>
  </section>

  <!-- fees, payroll, budget, audit, settings placeholders -->
  <section id="feesSection" class="card" style="display:none">

  <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
          <h3 class="card-title">Fee Collection</h3>
          <div class="small">Manage invoices, payments & balances</div>
      </div>

      <div style="display:flex; gap:8px;">
          <button class="btn" id="exportFeesCSV">Export CSV</button>
          <button class="btn primary" id="newInvoiceBtn"><i class="fa fa-file-invoice"></i> New Invoice</button>
      </div>
  </div>

  <div style="margin-top:15px; display:flex; gap:20px; align-items:flex-start;">
      
      <!-- LEFT: FEE LIST -->
      <div style="flex:2;">
          <div style="display:flex; gap:8px; margin-bottom:10px;">
              <input id="feeSearch" class="input" placeholder="Search student name or ID">
              <select id="feeClassFilter" class="input" style="width:160px;">
                  <option value="">All Classes</option>
                  <option value="KG1">KG1</option>
                  <option value="KG2">KG2</option>
                  <option value="Basic 1">Basic 1</option>
                  <option value="Basic 2">Basic 2</option>
                  <option value="Basic 3">Basic 3</option>
                  <option value="JHS 1">JHS 1</option>
                  <option value="JHS 2">JHS 2</option>
              </select>
              <button class="btn" id="applyFeeFilters">Apply</button>
          </div>

          <table class="tx-table">
              <thead>
                <tr>
                    <th>Student</th>
                    <th>Class</th>
                    <th>Invoice</th>
                    <th>Paid</th>
                    <th>Balance</th>
                    <th>Actions</th>
                </tr>
              </thead>
              <tbody id="feesTableBody"></tbody>
          </table>
      </div>

      <!-- RIGHT: INVOICE FORM -->
      <div style="flex:1; background:var(--card-bg); padding:18px; border-radius:var(--radius); box-shadow:0 6px 18px rgba(0,0,0,.1);">
          <h4 style="margin:0 0 10px 0;">Create / Update Invoice</h4>

          <input class="input" id="invStudent" placeholder="Student Name">
          <input class="input" id="invStudentID" placeholder="Student ID (unique)">
          <select class="input" id="invClass">
              <option value="">Select Class</option>
              <option>KG1</option><option>KG2</option>
              <option>Basic 1</option><option>Basic 2</option><option>Basic 3</option>
              <option>JHS 1</option><option>JHS 2</option>
          </select>
          <input class="input" id="invAmount" placeholder="Invoice Amount (e.g 200)">
          <input class="input" id="invDesc" placeholder="Description (e.g Tuition Fees)">
          
          <button class="btn primary" id="saveInvoiceBtn">Save Invoice</button>
          <button class="btn" id="clearInvoiceForm">Clear</button>

          <br><br>

          <h4>Record Payment</h4>
          <input class="input" id="payStudentID" placeholder="Student ID">
          <input class="input" id="payAmount" placeholder="Amount Paid">
          <button class="btn primary" id="recordPaymentBtn">Record Payment</button>
      </div>

  </div>

  <div style="margin-top:25px;">
      <h4>Payment History</h4>
      <table class="tx-table">
          <thead>
              <tr>
                  <th>Date</th>
                  <th>Student</th>
                  <th>Amount</th>
                  <th>Description</th>
              </tr>
          </thead>
          <tbody id="feeHistoryBody"></tbody>
      </table>
  </div>

</section>
<script>
/*
  PART 3 — Message 2
  Fees Collection / Payments engine
  - Requires the HTML block from Message 1
  - Uses ACTIVE_ORG if present; otherwise falls back to localStorage.active_org or 'FLAWLESS'
*/

(function(){

  // --- small helpers (use existing ones if present) ---
  function safeParse(s){ try{return JSON.parse(s)}catch(e){return null} }
  function read(key){ return safeParse(localStorage.getItem(key)) || []; }
  function save(key,val){ localStorage.setItem(key, JSON.stringify(val)); }
  function nlToast(msg,ms=2500){ const t=document.getElementById('toast'); if(!t) return alert(msg); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),ms); }

  // ACTIVE_ORG compatibility (re-use page constant if present)
  const ORG = (typeof ACTIVE_ORG !== 'undefined' && ACTIVE_ORG) ? ACTIVE_ORG : (localStorage.getItem('active_org') || 'FLAWLESS');
  const FEES_KEY = `${ORG}_fees`;
  const PAYMENTS_KEY = `${ORG}_fee_payments`;
  const STUDENT_INDEX_KEY = `${ORG}_students`; // optional, if you store students elsewhere

  // ensure storage keys exist
  if(!localStorage.getItem(FEES_KEY)) save(FEES_KEY, []);
  if(!localStorage.getItem(PAYMENTS_KEY)) save(PAYMENTS_KEY, []);

  /* -------------------------
     UI Elements
  ------------------------- */
  const feesTableBody = document.getElementById('feesTableBody');
  const feeHistoryBody = document.getElementById('feeHistoryBody');
  const feeSearch = document.getElementById('feeSearch');
  const feeClassFilter = document.getElementById('feeClassFilter');
  const applyFeeFiltersBtn = document.getElementById('applyFeeFilters');
  const newInvoiceBtn = document.getElementById('newInvoiceBtn');
  const saveInvoiceBtn = document.getElementById('saveInvoiceBtn');
  const clearInvoiceBtn = document.getElementById('clearInvoiceForm');
  const recordPaymentBtn = document.getElementById('recordPaymentBtn');
  const exportFeesCSVBtn = document.getElementById('exportFeesCSV');

  const invStudent = document.getElementById('invStudent');
  const invStudentID = document.getElementById('invStudentID');
  const invClass = document.getElementById('invClass');
  const invAmount = document.getElementById('invAmount');
  const invDesc = document.getElementById('invDesc');

  const payStudentID = document.getElementById('payStudentID');
  const payAmount = document.getElementById('payAmount');

  // local edit state
  let editingInvoiceId = null;

  /* -------------------------
     Core: Fees CRUD & Payments
  ------------------------- */
  function getFees(){ return read(FEES_KEY); }
  function getPayments(){ return read(PAYMENTS_KEY); }

  function persistFees(arr){ save(FEES_KEY, arr); renderFees(); updateFeeHistory(); updateFinanceKPIs(); nlToast('Fees saved'); }
  function persistPayments(arr){ save(PAYMENTS_KEY, arr); renderFees(); updateFeeHistory(); updateFinanceKPIs(); nlToast('Payment recorded'); }

  function createInvoice({ studentName, studentId, className, amount, desc }){
    if(!studentName || !studentId || !amount) return nlToast('Student, ID and amount required');
    const arr = getFees();
    const invoice = {
      id: 'f_' + Date.now(),
      studentName,
      studentId,
      className: className || '',
      amount: Number(amount) || 0,
      desc: desc || '',
      createdAt: new Date().toISOString(),
      payments: [] // payment ids (from PAYMENTS_KEY)
    };
    arr.push(invoice); persistFees(arr);
    pushFinanceActivity(`Invoice created for ${studentName} (${studentId}) ₵${invoice.amount}`);
    return invoice;
  }

  function updateInvoice(id, changes){
    const arr = getFees();
    const idx = arr.findIndex(x=>x.id===id);
    if(idx === -1) return nlToast('Invoice not found');
    arr[idx] = Object.assign({}, arr[idx], changes);
    persistFees(arr);
    pushFinanceActivity(`Invoice updated for ${arr[idx].studentName} (${arr[idx].studentId})`);
  }

  function deleteInvoice(id){
    if(!confirm('Delete invoice?')) return;
    const arr = getFees().filter(x=>x.id !== id);
    // also remove related payments
    const payments = getPayments().filter(p=> p.invoiceId !== id);
    persistPayments(payments);
    persistFees(arr);
    pushFinanceActivity(`Invoice ${id} deleted`);
  }

  function recordPayment({ invoiceId=null, studentId, studentName, amount, method='cash', note='' }){
    if(!studentId || !amount) return nlToast('Student ID and amount required');
    const payments = getPayments();
    const p = {
      id: 'p_' + Date.now(),
      invoiceId,
      studentId,
      studentName,
      amount: Number(amount) || 0,
      method,
      note,
      date: new Date().toISOString()
    };
    payments.push(p);
    persistPayments(payments);

    // attach payment to invoice if invoiceId provided
    if(invoiceId){
      const fees = getFees();
      const inv = fees.find(f=>f.id === invoiceId);
      if(inv){
        inv.payments = inv.payments || [];
        inv.payments.push(p.id);
        persistFees(fees);
      }
    }

    pushFinanceActivity(`Payment ₵${p.amount} recorded for ${p.studentName || p.studentId}`);
    return p;
  }

  /* -------------------------
     Rendering
  ------------------------- */
  function computeInvoiceStatus(inv){
    const payments = getPayments().filter(p => p.invoiceId === inv.id);
    const paid = payments.reduce((s,p)=> s + Number(p.amount||0), 0);
    const balance = Number(inv.amount || 0) - paid;
    return { paid, balance, payments };
  }

  function renderFees(filterText='', classFilter=''){
    const arr = getFees().slice().reverse(); // newest first
    feesTableBody.innerHTML = '';
    arr.filter(inv => {
      if(filterText){
        const t = filterText.toLowerCase();
        if(!(inv.studentName || '').toLowerCase().includes(t) && !(inv.studentId||'').toLowerCase().includes(t) && !(inv.desc||'').toLowerCase().includes(t)) return false;
      }
      if(classFilter && inv.className !== classFilter) return false;
      return true;
    }).forEach(inv => {
      const status = computeInvoiceStatus(inv);
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${escapeHtml(inv.studentName)}<div class="tiny">${escapeHtml(inv.studentId||'')}</div></td>
        <td>${escapeHtml(inv.className||'')}</td>
        <td>₵ ${Number(inv.amount||0).toLocaleString()}</td>
        <td>₵ ${Number(status.paid||0).toLocaleString()}</td>
        <td>₵ ${Number(status.balance||0).toLocaleString()}</td>
        <td>
          <button onclick="__fee_view('${inv.id}')">View</button>
          <button onclick="__fee_edit('${inv.id}')">Edit</button>
          <button onclick="__fee_pay('${inv.id}')">Pay</button>
          <button onclick="__fee_delete('${inv.id}')">Delete</button>
        </td>
      `;
      feesTableBody.appendChild(row);
    });
  }

  // Expose small functions to global so inline onclick handlers above work
  window.__fee_view = function(id){
    const inv = getFees().find(f=>f.id===id);
    if(!inv) return nlToast('Not found');
    const status = computeInvoiceStatus(inv);
    alert(`Invoice for ${inv.studentName} (${inv.studentId})\nAmount: ₵${inv.amount}\nPaid: ₵${status.paid}\nBalance: ₵${status.balance}\nDescription: ${inv.desc}\nCreated: ${new Date(inv.createdAt).toLocaleString()}`);
  };

  window.__fee_edit = function(id){
    const inv = getFees().find(f=>f.id===id);
    if(!inv) return nlToast('Not found');
    editingInvoiceId = id;
    invStudent.value = inv.studentName || '';
    invStudentID.value = inv.studentId || '';
    invClass.value = inv.className || '';
    invAmount.value = inv.amount || '';
    invDesc.value = inv.desc || '';
    invStudent.focus();
    nlToast('Editing invoice — Save to apply changes');
  };

  window.__fee_delete = function(id){ deleteInvoice(id); };

  window.__fee_pay = function(id){
    const inv = getFees().find(f=>f.id===id);
    if(!inv) return nlToast('Not found');
    const amt = prompt('Amount to pay', computeInvoiceStatus(inv).balance || inv.amount || 0);
    if(!amt) return;
    const p = recordPayment({ invoiceId: id, studentId: inv.studentId, studentName: inv.studentName, amount: Number(amt) || 0 });
    if(p) nlToast('Payment recorded');
  };

  /* Payment history render */
  function updateFeeHistory(){
    const payments = getPayments().slice().reverse();
    feeHistoryBody.innerHTML = '';
    payments.forEach(p => {
      const tr = document.createElement('tr');
      const dt = new Date(p.date).toLocaleString();
      tr.innerHTML = `<td class="tiny">${dt}</td><td>${escapeHtml(p.studentName||p.studentId)}</td><td>₵ ${Number(p.amount||0).toLocaleString()}</td><td class="tiny">${escapeHtml(p.note||p.method||'')}</td>`;
      feeHistoryBody.appendChild(tr);
    });
  }

  /* -------------------------
     Buttons & events
  ------------------------- */
  saveInvoiceBtn.addEventListener('click', ()=> {
    const studentName = invStudent.value.trim();
    const studentIdVal = invStudentID.value.trim();
    const className = invClass.value.trim();
    const amountVal = invAmount.value.trim();
    const descVal = invDesc.value.trim();

    if(!studentName || !studentIdVal || !amountVal) return nlToast('Student & amount required');

    if(editingInvoiceId){
      updateInvoice(editingInvoiceId, {
        studentName,
        studentId: studentIdVal,
        className,
        amount: Number(amountVal)||0,
        desc: descVal
      });
      editingInvoiceId = null;
      clearInvoiceForm();
      nlToast('Invoice updated');
    } else {
      createInvoice({ studentName, studentId: studentIdVal, className, amount: Number(amountVal)||0, desc: descVal });
      clearInvoiceForm();
    }
    renderFees(feeSearch.value, feeClassFilter.value);
    updateFeeHistory();
  });

  clearInvoiceBtn.addEventListener('click', ()=> { editingInvoiceId = null; clearInvoiceForm(); });

  newInvoiceBtn.addEventListener('click', ()=> { editingInvoiceId = null; clearInvoiceForm(); invStudent.focus(); });

  recordPaymentBtn.addEventListener('click', ()=> {
    const sid = payStudentID.value.trim();
    const amt = payAmount.value.trim();
    if(!sid || !amt) return nlToast('Student ID & amount required');
    // try to find invoice for this student with non-zero balance
    const inv = getFees().find(i => i.studentId === sid && computeInvoiceStatus(i).balance > 0);
    const invoiceId = inv ? inv.id : null;
    const studentName = inv ? inv.studentName : sid;
    recordPayment({ invoiceId, studentId: sid, studentName, amount: Number(amt)||0 });
    payStudentID.value = ''; payAmount.value = '';
    renderFees(feeSearch.value, feeClassFilter.value);
    updateFeeHistory();
  });

  applyFeeFiltersBtn.addEventListener('click', ()=> renderFees(feeSearch.value, feeClassFilter.value));
  feeSearch.addEventListener('keyup', (e)=> {
    if(e.key === 'Enter') renderFees(feeSearch.value, feeClassFilter.value);
  });

  exportFeesCSVBtn.addEventListener('click', ()=> {
    const rows = getFees().map(f => {
      const s = computeInvoiceStatus(f);
      return {
        studentName: f.studentName,
        studentId: f.studentId,
        className: f.className,
        amount: f.amount,
        paid: s.paid,
        balance: s.balance,
        desc: f.desc,
        createdAt: f.createdAt
      };
    });
    if(!rows.length) return nlToast('No fees to export');
    const csv = toCsv(rows);
    downloadText(csv, `${ORG}_fees_${(new Date()).toISOString().slice(0,10)}.csv`, 'text/csv');
  });

  /* -------------------------
     Utilities
  ------------------------- */
  function clearInvoiceForm(){
    invStudent.value = ''; invStudentID.value = ''; invClass.value = ''; invAmount.value = ''; invDesc.value = '';
  }

  function toCsv(rows){
    if(!rows || !rows.length) return '';
    const keys = Object.keys(rows[0]);
    const lines = [ keys.join(',') ];
    rows.forEach(r => {
      lines.push(keys.map(k=> `"${String(r[k]||'').replace(/"/g,'""')}"`).join(','));
    });
    return lines.join('\n');
  }
  function downloadText(text, filename, mime='text/plain'){
    const blob = new Blob([text], { type: mime });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  /* -------------------------
     Activity & KPIs integration
  ------------------------- */
  const FIN_ACT_KEY = `${ORG}_finance_activity`;
  if(!localStorage.getItem(FIN_ACT_KEY)) save(FIN_ACT_KEY, []);
  function pushFinanceActivity(text){
    const arr = read(FIN_ACT_KEY);
    arr.push({ text, time: new Date().toISOString() });
    save(FIN_ACT_KEY, arr);
    // if HR dashboard listens to ACT_KEY, save there too
    const HR_ACT_KEY = `${ORG}_activity`;
    const hrArr = read(HR_ACT_KEY = HR_ACT_KEY || HR_ACT_KEY); // no-op if undefined
    // we won't overwrite; instead push to HR activity if present
    try{
      const hrKey = `${ORG}_activity`;
      const current = read(hrKey);
      current.push({ text: '[Finance] ' + text, time: new Date().toISOString() });
      save(hrKey, current);
    }catch(e){}
  }

  function updateFinanceKPIs(){
    // Simple KPI: total outstanding fees, total paid, number invoices
    const fees = getFees();
    const payments = getPayments();
    const totalInvoices = fees.length;
    let totalAmount = 0, totalPaid = 0;
    fees.forEach(f => { totalAmount += Number(f.amount||0); const s = computeInvoiceStatus(f); totalPaid += Number(s.paid||0); });
    const totalOutstanding = totalAmount - totalPaid;
    // expose these to console and toasts — you can wire to any KPI display in your finance dashboard
    console.log('Finance KPIs', { totalInvoices, totalAmount, totalPaid, totalOutstanding, payments: payments.length });
    // Optionally save snapshot under a key
    save(`${ORG}_finance_kpis`, { totalInvoices, totalAmount, totalPaid, totalOutstanding, updated: new Date().toISOString() });
  }

  /* -------------------------
     Storage event sync (other tabs)
  ------------------------- */
  window.addEventListener('storage', (e)=> {
    if([FEES_KEY, PAYMENTS_KEY].includes(e.key)){
      renderFees(feeSearch.value, feeClassFilter.value);
      updateFeeHistory();
      updateFinanceKPIs();
    }
  });

  /* -------------------------
     Auto-sync with teacher attendance + students (optional)
     If teacher pages push to `${ORG}_teacher_attendance` or `${ORG}_students`, we can react.
  ------------------------- */
  function tryAutoLinkStudents(){
    // If STUDENT_INDEX_KEY exists and contains student objects {id,name,class}
    const students = read(STUDENT_INDEX_KEY);
    if(students && students.length){
      // populate quick datalist for invStudent / invStudentID (if you want)
      // simple autocomplete using first match on ID / name on save
      console.log('Found student index, automatic linking enabled');
    }
  }

  /* -------------------------
     Boot / initial render
  ------------------------- */
  renderFees();
  updateFeeHistory();
  updateFinanceKPIs();
  tryAutoLinkStudents();

  // expose some API for global convenience
  window.FIN_createInvoice = createInvoice;
  window.FIN_recordPayment = recordPayment;
  window.FIN_getFees = getFees;
  window.FIN_getPayments = getPayments;

})();
</script>

  <section id="payrollSection" class="card" style="display:none"><h3 class="card-title">Payroll</h3><div id="payrollArea"></div></section>
  <section id="budgetSection" class="card" style="display:none"><h3 class="card-title">Budget Planner</h3><div id="budgetArea"></div></section>
  <section id="auditSection" class="card" style="display:none"><h3 class="card-title">Audit Logs</h3><div id="auditArea"></div></section>
  <section id="settingsSection" class="card" style="display:none"><h3 class="card-title">Settings</h3><div id="settingsArea"></div></section>

</div>

<!-- Toast -->
<div id="toast"></div>

<script>
/* ----------------- Utilities ----------------- */
function safeParse(x){ try{return JSON.parse(x);}catch{return null;} }
function read(k){ return safeParse(localStorage.getItem(k)) || []; }
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function showToast(msg,ms=2200){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),ms); }

/* ----------------- Keys & Init ----------------- */
const ORG = localStorage.getItem('active_org') || 'FLAWLESS';
document.getElementById('orgName').textContent = ORG;

const TX_KEY = `${ORG}_finance_transactions`;
const FEE_KEY = `${ORG}_finance_fees`;
const PAY_KEY = `${ORG}_finance_payroll`;
const AUDIT_KEY = `${ORG}_finance_audit`;

if(!localStorage.getItem(TX_KEY)) save(TX_KEY, []);
if(!localStorage.getItem(FEE_KEY)) save(FEE_KEY, []);
if(!localStorage.getItem(PAY_KEY)) save(PAY_KEY, []);
if(!localStorage.getItem(AUDIT_KEY)) save(AUDIT_KEY, []);

/* ----------------- NAV TABS ----------------- */
document.querySelectorAll('.nav-item').forEach(el=>{
  el.addEventListener('click', ()=> {
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    el.classList.add('active');
    const page = el.dataset.page;
    // hide all sections
    ['overview','transactions','fees','payroll','budget','audit','settings'].forEach(p=>{
      const id = p+'Section';
      const s = document.getElementById(id);
      if(s) s.style.display = (p === page) ? 'block' : 'none';
    });
    // show overview by default
    if(page === 'overview') {
      document.getElementById('overviewSection').style.display = 'block';
    }
  });
});

/* show overview on load */
document.getElementById('overviewSection').style.display = 'block';

/* ----------------- TRANSACTIONS (CRUD + Filters) ----------------- */
const txTableBody = document.getElementById('txTableBody');
const txChartCtx = document.getElementById('txChart').getContext('2d');
let txChart = null;

function getTransactions(){ return read(TX_KEY).slice().reverse(); }
function saveTransactions(arr){ save(TX_KEY, arr.slice().reverse()); }

function renderTransactions(filters){
  const rows = read(TX_KEY).slice().reverse();
  let out = rows;

  // apply filters
  if(filters){
    if(filters.type) out = out.filter(r => r.type === filters.type);
    if(filters.search) {
      const q = filters.search.toLowerCase();
      out = out.filter(r => (r.description||'').toLowerCase().includes(q) || (r.category||'').toLowerCase().includes(q));
    }
    if(filters.from) out = out.filter(r => r.date >= filters.from);
    if(filters.to) out = out.filter(r => r.date <= filters.to);
  }

  txTableBody.innerHTML = '';
  out.forEach(tx => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${tx.date || ''}</td>
      <td>${tx.type}</td>
      <td>${tx.category || ''}</td>
      <td>${tx.description || ''}</td>
      <td style="text-align:right">₵ ${Number(tx.amount||0).toLocaleString()}</td>
      <td>
        <button data-id="${tx.id}" class="btn editTx">Edit</button>
        <button data-id="${tx.id}" class="btn danger delTx">Delete</button>
      </td>`;
    txTableBody.appendChild(tr);
  });

  // wire edit / delete
  document.querySelectorAll('.delTx').forEach(b=> b.addEventListener('click', (e)=> {
    const id = e.target.dataset.id;
    if(!confirm('Delete transaction?')) return;
    const arr = read(TX_KEY).filter(t=>t.id !== id);
    save(TX_KEY, arr);
    saveAudit(`Deleted transaction ${id}`);
    renderTransactions(filters);
    updateKPIs(); updateOverviewChart(); drawTxChart();
    showToast('Deleted transaction');
  }));
  document.querySelectorAll('.editTx').forEach(b=> b.addEventListener('click', (e)=>{
    const id = e.target.dataset.id;
    const arr = read(TX_KEY);
    const tx = arr.find(t=>t.id===id);
    if(!tx) return showToast('Not found');
    // prefill right panel and switch to transactions tab
    document.querySelector('[data-page="transactions"]').click();
    document.getElementById('txType').value = tx.type;
    document.getElementById('txDate').value = tx.date;
    document.getElementById('txCategory').value = tx.category || '';
    document.getElementById('txDesc').value = tx.description || '';
    document.getElementById('txAmount').value = tx.amount;
    // set temporary editId
    document.getElementById('addTxBtn').dataset.editId = id;
    showToast('Editing transaction — click Save (Add) to update');
  }));

  // update recent list (overview)
  const recent = rows.slice(0,6).map(r=>`${r.date} • ${r.type} • ₵${Number(r.amount||0).toLocaleString()} • ${r.category||''}`).join('<br>');
  document.getElementById('recentTx').innerHTML = recent || '<div class="small">No recent transactions</div>';
}

/* Add transaction */
document.getElementById('addTxBtn').addEventListener('click', ()=>{
  const type = document.getElementById('txType').value || 'income';
  const date = document.getElementById('txDate').value || new Date().toISOString().split('T')[0];
  const category = document.getElementById('txCategory').value.trim();
  const description = document.getElementById('txDesc').value.trim();
  const amount = Number(document.getElementById('txAmount').value) || 0;
  if(!amount) return showToast('Enter amount');

  let arr = read(TX_KEY);
  const editId = document.getElementById('addTxBtn').dataset.editId;
  if(editId){
    // update
    arr = arr.map(t => t.id === editId ? {...t, type, date, category, description, amount} : t);
    delete document.getElementById('addTxBtn').dataset.editId;
    save(TX_KEY, arr);
    saveAudit(`Updated transaction ${editId}`);
    showToast('Transaction updated');
  } else {
    const id = 'tx_' + Date.now();
    arr.push({ id, type, date, category, description, amount });
    save(TX_KEY, arr);
    saveAudit(`Added transaction ${id}`);
    showToast('Transaction added');
  }

  // clear form
  document.getElementById('txCategory').value = '';
  document.getElementById('txDesc').value = '';
  document.getElementById('txAmount').value = '';
  document.getElementById('txDate').value = '';

  renderTransactions(currentFilters());
  updateKPIs(); updateOverviewChart(); drawTxChart();
});

/* Clear form */
document.getElementById('clearFormBtn').addEventListener('click', ()=> {
  document.getElementById('txCategory').value = '';
  document.getElementById('txDesc').value = '';
  document.getElementById('txAmount').value = '';
  document.getElementById('txDate').value = '';
  delete document.getElementById('addTxBtn').dataset.editId;
});

/* Filters */
function currentFilters(){
  return {
    type: document.getElementById('filterType').value || '',
    search: document.getElementById('filterSearch').value.trim() || '',
    from: document.getElementById('filterFrom').value || '',
    to: document.getElementById('filterTo').value || ''
  };
}
document.getElementById('applyFilters').addEventListener('click', ()=> renderTransactions(currentFilters()));

/* Export CSV */
document.getElementById('exportTxCSV').addEventListener('click', ()=>{
  const rows = read(TX_KEY);
  if(!rows.length) return showToast('No transactions to export');
  const keys = ['id','date','type','category','description','amount'];
  const lines = [keys.join(',')];
  rows.forEach(r=>{
    lines.push(keys.map(k=> `"${String(r[k]||'').replace(/"/g,'""')}"`).join(','));
  });
  const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${ORG}_transactions.csv`; a.click();
});

/* Clear transactions */
document.getElementById('clearTx').addEventListener('click', ()=> {
  if(!confirm('Clear all transactions for this org?')) return;
  save(TX_KEY, []);
  saveAudit('Cleared all transactions');
  renderTransactions(); updateKPIs(); updateOverviewChart(); drawTxChart();
  showToast('Transactions cleared');
});

/* ----------------- Overview Chart & KPIs (update functions) ----------------- */
const overviewCtx = document.getElementById('overviewChart').getContext('2d');
let overviewChart = null;

function updateKPIs(){
  const tx = read(TX_KEY);
  const income = tx.filter(t=>t.type==='income').reduce((s,t)=> s + Number(t.amount||0), 0);
  const expenses = tx.filter(t=>t.type==='expense').reduce((s,t)=> s + Number(t.amount||0), 0);
  const fees = read(FEE_KEY).reduce((s,f)=> s + Number(f.amount||0), 0);

  document.getElementById('totalIncome').textContent = '₵' + income.toLocaleString();
  document.getElementById('totalExpenses').textContent = '₵' + expenses.toLocaleString();
  document.getElementById('netBalance').textContent = '₵' + (income - expenses).toLocaleString();
  document.getElementById('feesCollected').textContent = '₵' + fees.toLocaleString();
}

/* overview - last 6 months income/expense */
function updateOverviewChart(){
  const tx = read(TX_KEY);
  const months = [];
  const labels = [];
  const now = new Date();
  for(let m=5;m>=0;m--){
    const d = new Date(now.getFullYear(), now.getMonth()-m, 1);
    const key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
    months.push(key);
    labels.push(d.toLocaleString('default',{month:'short'}));
  }
  const incomeSeries = months.map(k => tx.filter(t=> t.date && t.date.startsWith(k)).filter(t=>t.type==='income').reduce((s,t)=> s + Number(t.amount||0),0));
  const expenseSeries = months.map(k => tx.filter(t=> t.date && t.date.startsWith(k)).filter(t=>t.type==='expense').reduce((s,t)=> s + Number(t.amount||0),0));

  if(overviewChart) overviewChart.destroy();
  overviewChart = new Chart(overviewCtx, {
    type:'bar',
    data:{ labels: labels, datasets:[
      { label:'Income', data: incomeSeries, backgroundColor: '#3b82f6' },
      { label:'Expenses', data: expenseSeries, backgroundColor: '#ef4444' }
    ]},
    options:{ responsive:true, plugins:{ legend:{ position:'top' } }, scales:{ y:{ beginAtZero:true } } }
  });
}

/* ----------------- Transaction chart (detailed) ----------------- */
function drawTxChart(){
  const rows = read(TX_KEY);
  // group last 12 months totals
  const months = [];
  const labels = [];
  const now = new Date();
  for(let m=11;m>=0;m--){
    const d = new Date(now.getFullYear(), now.getMonth()-m, 1);
    const key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
    months.push(key);
    labels.push(d.toLocaleString('default',{month:'short'}));
  }
  const incomeSeries = months.map(k => rows.filter(t=> t.date && t.date.startsWith(k) && t.type==='income').reduce((s,t)=> s + Number(t.amount||0),0));
  const expenseSeries = months.map(k => rows.filter(t=> t.date && t.date.startsWith(k) && t.type==='expense').reduce((s,t)=> s + Number(t.amount||0),0));

  if(txChart) txChart.destroy();
  txChart = new Chart(txChartCtx, {
    type:'line',
    data:{ labels, datasets:[
      { label:'Income', data: incomeSeries, borderColor: '#3b82f6', backgroundColor:'rgba(59,130,246,0.12)', fill:true },
      { label:'Expenses', data: expenseSeries, borderColor: '#ef4444', backgroundColor:'rgba(239,68,68,0.08)', fill:true }
    ]},
    options:{ responsive:true, plugins:{ legend:{ position:'top' } }, scales:{ y:{ beginAtZero:true } } }
  });
}

/* ----------------- Audit log helper ----------------- */
function saveAudit(text){
  const arr = read(AUDIT_KEY);
  arr.push({ text, time: new Date().toISOString() });
  save(AUDIT_KEY, arr);
}

/* ----------------- Storage sync & boot ----------------- */
window.addEventListener('storage', (e)=>{
  if([TX_KEY, FEE_KEY, PAY_KEY, AUDIT_KEY].includes(e.key)){
    renderTransactions(currentFilters());
    updateKPIs(); updateOverviewChart(); drawTxChart();
  }
});

/* initial render calls */
renderTransactions();
updateKPIs();
updateOverviewChart();
drawTxChart();

/* ----------------- UI helpers (theme, export PDF) ----------------- */
document.getElementById('themeToggle').addEventListener('click', ()=>{
  document.documentElement.classList.toggle('dark');
  const isDark = document.documentElement.classList.contains('dark');
  localStorage.setItem('finance_theme_dark', isDark ? '1' : '0');
});
if(localStorage.getItem('finance_theme_dark') === '1') document.documentElement.classList.add('dark');

document.getElementById('exportPDF').addEventListener('click', ()=>{
  // simple text export to new window — lightweight option
  const rows = read(TX_KEY);
  let html = `<h2>${ORG} — Finance Report</h2>`;
  html += `<p>Total transactions: ${rows.length}</p>`;
  html += `<table border="1" cellpadding="6" cellspacing="0"><tr><th>Date</th><th>Type</th><th>Category</th><th>Description</th><th>Amount</th></tr>`;
  rows.slice().reverse().slice(0,200).forEach(r => html += `<tr><td>${r.date}</td><td>${r.type}</td><td>${r.category||''}</td><td>${r.description||''}</td><td>₵${Number(r.amount||0)}</td></tr>`);
  html += `</table>`;
  const w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
  w.print();
});

/* quick CSV export helper (for entire page) available globally */
window.exportAllTransactions = function(){ document.getElementById('exportTxCSV').click(); };

/* --- render audit, fees, payroll placeholders --- */
function renderAudit(){ const arr = read(AUDIT_KEY).slice().reverse(); const el = document.getElementById('auditArea'); el.innerHTML = ''; arr.forEach(a=> el.innerHTML += `<div class="small">${a.time} • ${a.text}</div>`); }
function renderFees(){ const arr = read(FEE_KEY); const el = document.getElementById('feesArea'); el.innerHTML = '<div class="small">Fees module coming — stored fees: '+arr.length+'</div>'; }
function renderPayroll(){ const arr = read(PAY_KEY); const el = document.getElementById('payrollArea'); el.innerHTML = '<div class="small">Payroll module coming — records: '+arr.length+'</div>'; }
function renderSettings(){ const el = document.getElementById('settingsArea'); el.innerHTML = '<div class="small">Settings: No special config yet.</div>'; }

renderAudit(); renderFees(); renderPayroll(); renderSettings();

/* initial audit push */
saveAudit('Finance dashboard loaded');

/* done */
console.log('Finance dashboard (Parts 1+2) loaded');
</script>
</body>
</html>
