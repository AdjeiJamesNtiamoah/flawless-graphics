<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Finance Dashboard — Payroll System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root {
    --primary:#00c3ff;
    --secondary:#00ffbb;
    --dark:#001f3f;
    --light-dark:#0b2b55;
    --bg:#f2f6ff;
    --card-bg:#fff;
    --radius:14px;
}

body {
    margin:0;
    background:var(--bg);
    font-family:Poppins,Arial;
    display:flex;
    height:100vh;
    overflow:hidden;
}

/* ---------------- SIDEBAR ---------------- */
.sidebar {
    width:260px;
    background:var(--dark);
    color:white;
    padding:25px 0;
    display:flex; flex-direction:column;
    box-shadow:4px 0 14px rgba(0,0,0,0.25);
}
.sidebar h2 {
    text-align:center;
    margin-bottom:25px;
    font-size:22px;
}
.nav-item {
    padding:15px 25px;
    cursor:pointer;
    display:flex; gap:14px;
    color:#cde6ff;
}
.nav-item:hover {
    background:var(--light-dark); color:white;
}

/* ---------------- MAIN CONTENT ---------------- */
.content {
    flex:1; padding:25px;
    overflow-y:auto;
}
.header {
    display:flex; justify-content:space-between; align-items:center;
    margin-bottom:25px;
}
.header .title {
    font-size:26px; font-weight:700; color:var(--dark);
}

.btn {
    padding:10px 14px; border:none; border-radius:10px;
    cursor:pointer; font-weight:600;
}
.btn.primary { background:var(--primary); color:white; }
.btn.success { background:var(--secondary); color:#003322; }
.btn.danger { background:#ff4444; color:white; }
.btn.light { background:#e6f0ff; color:#002244; }

.card {
    background:white;
    padding:20px;
    border-radius:var(--radius);
    box-shadow:0 4px 14px rgba(0,0,0,0.08);
    margin-bottom:20px;
}
.card-title { font-size:18px; font-weight:700; margin-bottom:10px; }

.grid {
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    gap:20px;
}

.kpi {
    background:white;
    padding:18px; border-radius:var(--radius);
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
    display:flex; align-items:center; gap:15px;
}
.kpi i { font-size:28px; color:var(--primary); }
.kpi .value { font-size:24px; font-weight:800; }
.kpi .label { color:#6c7a8a; }

/* TABLE */
table { width:100%; border-collapse:collapse; }
th,td { padding:12px; border-bottom:1px solid #e2e8f0; font-size:14px; }

/* Toast */
#toast {
    position:fixed; right:25px; bottom:25px;
    background:var(--dark); color:white;
    padding:14px 18px; border-radius:10px;
    opacity:0; transform:translateY(20px);
    transition:.3s;
}
#toast.show { opacity:1; transform:translateY(0); }

/* Payment Modal */
#paymentModal {
    display:none;
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.6);
    align-items:center; justify-content:center;
}
.modal-box {
    background:white; padding:25px; width:420px;
    border-radius:14px; box-shadow:0 4px 20px rgba(0,0,0,0.2);
}
.input {
    width:100%; padding:10px; margin-top:8px;
    border-radius:8px; border:1px solid #ccd;
}
</style>
</head>

<body>

<!-- ================== SIDEBAR ================== -->
<div class="sidebar">
    <h2>FINANCE</h2>
    <div class="nav-item" onclick="showSection('dashboard')"><i class="fa fa-chart-line"></i> Dashboard</div>
    <div class="nav-item" onclick="showSection('pendingPayroll')"><i class="fa fa-sack-dollar"></i> Pending Payroll</div>
    <div class="nav-item" onclick="showSection('approvedPayroll')"><i class="fa fa-check-circle"></i> Approved Payroll</div>
    <div class="nav-item hrOnly" onclick="showSection('salaryAdvances')"><i class="fa fa-coins"></i> Salary Advances</div>
    <div class="nav-item financeOnly" onclick="showSection('audit')"><i class="fa fa-history"></i> Audit Trail</div>
    <div class="nav-item" onclick="logout()"><i class="fa fa-door-open"></i> Logout</div>
</div>

<!-- ================== MAIN CONTENT ================== -->
<div class="content">

<div class="header">
    <div class="title">Finance Dashboard — <span id="orgDisplay"></span> (<span id="roleDisplay"></span>)</div>

    <div class="header-right">
        <button class="btn light" id="switchOrgBtn"><i class="fa fa-building"></i></button>
        <button class="btn success" id="exportFinancePDF"><i class="fa fa-file-pdf"></i> Export</button>
        <a href="login.html" style="text-decoration:none;margin-left:10px;color:#333">← Login</a>
    </div>
</div>

<!-- ===== KPI CARDS ===== -->
<div id="dashboard" class="grid">
    <div class="kpi"><i class="fa fa-sack-dollar"></i><div><div class="value" id="kpiPending">0</div><div class="label">Pending Payroll</div></div></div>
    <div class="kpi"><i class="fa fa-circle-check"></i><div><div class="value" id="kpiApproved">0</div><div class="label">Approved This Month</div></div></div>
    <div class="kpi"><i class="fa fa-coins"></i><div><div class="value" id="kpiAdvances">0</div><div class="label">Active Salary Advances</div></div></div>
    <div class="kpi"><i class="fa fa-users"></i><div><div class="value" id="kpiEmployees">0</div><div class="label">Total Employees</div></div></div>
</div>

<!-- ================== PAYMENT MODAL ================== -->
<div id="paymentModal">
    <div class="modal-box">
        <h3>Process Salary Payment</h3>

        <label>Payment Method</label>
        <select id="paymentMethod" class="input">
            <option value="momo">Mobile Money</option>
            <option value="bank">Bank Transfer</option>
            <option value="wallet">Internal Wallet</option>
        </select>

        <label>Select Linked Account</label>
        <select id="linkedAccount" class="input"></select>

        <button class="btn primary" onclick="confirmPayment()">Confirm & Pay</button>
        <button class="btn danger" onclick="closePaymentModal()">Cancel</button>
    </div>
</div>

<!-- STOP HERE — PART 2 WILL CONTAIN LOGIC + TABLES -->
<!-- ================== SECTIONS: Pending / Approved / Advances / Messages / Audit ================== -->

<!-- Pending Payroll -->
<section id="pendingPayroll" class="card" style="margin-top:18px; display:none;">
  <div class="card-title">Pending Payroll Requests</div>

  <div style="display:flex;justify-content:space-between;align-items:center">
    <div class="tiny">HR submits payroll batches here for Finance approval / payment.</div>
    <div style="display:flex;gap:8px">
      <button class="btn" id="refreshPending">Refresh</button>
      <button class="btn primary" id="bulkApproveBtn">Approve All Visible</button>
    </div>
  </div>

  <div style="margin-top:12px; overflow:auto;" class="table-wrap">
    <table>
      <thead>
        <tr><th>#</th><th>Batch ID</th><th>Submitted By</th><th>Period</th><th>Total</th><th>Status</th><th>Actions</th></tr>
      </thead>
      <tbody id="pendingTable"></tbody>
    </table>
  </div>
</section>

<!-- Approved Payroll -->
<section id="approvedPayroll" class="card" style="margin-top:18px; display:none;">
  <div class="card-title">Approved / Paid Payroll</div>
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div class="tiny">History of approved payrolls and payments.</div>
    <div style="display:flex;gap:8px">
      <button class="btn" id="exportPayrollCsv">Export CSV</button>
      <button class="btn" id="exportPayrollPdf">Export PDF</button>
    </div>
  </div>

  <div style="margin-top:12px; overflow:auto;" class="table-wrap">
    <table>
      <thead><tr><th>#</th><th>Batch ID</th><th>Approved By</th><th>Period</th><th>Total</th><th>Paid On</th><th>Details</th></tr></thead>
      <tbody id="approvedTable"></tbody>
    </table>
  </div>
</section>

<!-- Salary Advances -->
<section id="salaryAdvances" class="card" style="margin-top:18px; display:none;">
  <div class="card-title">Salary Advances</div>
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div class="tiny">Employees can request advances; Finance approves/rejects.</div>
    <div>
      <button class="btn primary" id="newAdvanceBtn">New Advance</button>
    </div>
  </div>

  <div style="margin-top:12px; overflow:auto;" class="table-wrap">
    <table>
      <thead><tr><th>#</th><th>Request ID</th><th>Employee</th><th>Amount</th><th>Reason</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="advancesTable"></tbody>
    </table>
  </div>
</section>

<!-- Messages -->
<section id="messages" class="card" style="margin-top:18px; display:none;">
  <div class="card-title">Finance Messages</div>
  <div style="display:flex;gap:8px;align-items:center">
    <input id="msgTo" placeholder="To (hr or email)" style="flex:1; padding:8px">
    <input id="msgSubject" placeholder="Subject" style="width:260px; padding:8px">
  </div>
  <textarea id="msgBody" rows="4" style="width:100%; margin-top:8px; padding:8px" placeholder="Message body"></textarea>
  <div style="margin-top:8px; display:flex; gap:8px;">
    <button class="btn primary" id="sendMsgBtn">Send</button>
    <button class="btn" id="loadMsgsBtn">Refresh</button>
  </div>

  <div style="margin-top:12px; max-height:320px; overflow:auto;">
    <table>
      <thead><tr><th>#</th><th>From</th><th>To</th><th>Subject</th><th>Date</th></tr></thead>
      <tbody id="messagesTable"></tbody>
    </table>
  </div>
</section>

<!-- Audit -->
<section id="audit" class="card" style="margin-top:18px; display:none;">
  <div class="card-title">Audit Trail</div>
  <div id="auditLog" style="max-height:420px; overflow:auto; margin-top:8px;"></div>
</section>

<!-- Linked Accounts & Payment Accounts panel -->
<section class="card" style="margin-top:18px;">
  <div class="card-title">Linked Payment Accounts</div>

  <div id="linkedAccountsList" style="margin-bottom:12px"></div>

  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
    <select id="accType" class="input" style="width:140px;">
      <option value="momo">Mobile Money</option>
      <option value="bank">Bank Account</option>
      <option value="wallet">Internal Wallet</option>
    </select>
    <input id="accName" class="input" placeholder="Account Name (e.g., School Wallet)" style="width:220px;">
    <input id="accNumber" class="input" placeholder="Account Number / Phone" style="width:200px;">
    <button class="btn success" onclick="addPaymentAccount()">Add Account</button>
  </div>
</section>

<!-- Pending Payroll Table (for pay now demo) -->
<div class="card" style="margin-top:18px;">
  <div class="card-title">Pending Payroll Approval (per-employee)</div>
  <table id="pendingPayrollTable">
    <thead>
      <tr><th>Employee</th><th>Salary</th><th>Month</th><th>Status</th><th>Pay</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- ================== SCRIPTS: Logic, Payments, Bank Mock, Role UI ================== -->
<script>
/* ---------------------------
   Utilities
----------------------------*/
function safeParse(s){ try{ return JSON.parse(s) }catch(e){ return null } }
function read(key){ return safeParse(localStorage.getItem(key)) || [] }
function save(key,val){ localStorage.setItem(key, JSON.stringify(val)) }
function uid(pref='id'){ return pref + '_' + Date.now().toString(36) }
function showToast(msg, ms=3000){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), ms) }
function formatCurrency(n){ try{ return new Intl.NumberFormat(undefined,{ style:'currency', currency:'GHS', maximumFractionDigits:2 }).format(Number(n||0)) } catch(e){ return 'GHS ' + Number(n||0).toFixed(2) } }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }

/* ---------------------------
   Keys & Namespaces
----------------------------*/
const ORG = localStorage.getItem('active_org') || 'FLAWLESS';
document.getElementById('orgDisplay').textContent = ORG;

const HR_PAYROLL_KEY = `${ORG}_hr_payroll_batches`;        // HR -> Finance pending batches
const FIN_APPROVED_KEY = `${ORG}_finance_approved_batches`;
const FIN_MSG_KEY = `${ORG}_finance_messages`;
const FIN_AUDIT_KEY = `${ORG}_finance_audit`;
const ACCOUNTS_KEY = `${ORG}_finance_accounts`;
const PENDING_EMP_PAY_KEY = `${ORG}_employee_pending_payments`; // per-employee pending
const SALARY_SHEETS_KEY = `${ORG}_salary_sheets`; // unified salary sheets
const PAYMENTS_LOG_KEY = `${ORG}_finance_payments_log`;

/* ensure keys exist */
if(!localStorage.getItem(HR_PAYROLL_KEY)) save(HR_PAYROLL_KEY, []);
if(!localStorage.getItem(FIN_APPROVED_KEY)) save(FIN_APPROVED_KEY, []);
if(!localStorage.getItem(FIN_MSG_KEY)) save(FIN_MSG_KEY, []);
if(!localStorage.getItem(FIN_AUDIT_KEY)) save(FIN_AUDIT_KEY, []);
if(!localStorage.getItem(ACCOUNTS_KEY)) save(ACCOUNTS_KEY, []);
if(!localStorage.getItem(PENDING_EMP_PAY_KEY)) save(PENDING_EMP_PAY_KEY, []);
if(!localStorage.getItem(SALARY_SHEETS_KEY)) save(SALARY_SHEETS_KEY, []);
if(!localStorage.getItem(PAYMENTS_LOG_KEY)) save(PAYMENTS_LOG_KEY, []);

/* ---------------------------
   Role-Based UI (login simulation)
----------------------------*/
/*
  Simple role-based UI. Two sample users seeded if not present:
   - hr@org.local  / password: hr123   (role: hr)
   - finance@org.local / password: fin123 (role: finance)
  Stored in localStorage key: ORG_users
*/
const USERS_KEY = `${ORG}_users`;
if(!localStorage.getItem(USERS_KEY)){
  save(USERS_KEY, [
    { email: 'hr@'+ORG.toLowerCase()+'.local', password: 'hr123', role: 'hr', name:'HR Admin' },
    { email: 'finance@'+ORG.toLowerCase()+'.local', password: 'fin123', role: 'finance', name:'Finance Officer' }
  ]);
}

/* get current session */
let session = safeParse(localStorage.getItem(`${ORG}_session`)) || null;

function requireLogin(){
  if(!session){
    // simple modal-less prompt for demo (you can hook this to a login.html)
    const email = prompt('Login email (eg hr@... or finance@...)');
    if(!email) return alert('Login required');
    const pwd = prompt('Password');
    const users = read(USERS_KEY);
    const u = users.find(x=> x.email.toLowerCase() === (email||'').toLowerCase() && x.password === pwd);
    if(!u) { alert('Invalid credentials'); return requireLogin(); }
    session = { email: u.email, role: u.role, name: u.name };
    localStorage.setItem(`${ORG}_session`, JSON.stringify(session));
    showToast(`Signed in as ${session.name} (${session.role})`);
  }
  applyRoleUI();
}
function logout(){
  localStorage.removeItem(`${ORG}_session`);
  session = null;
  showToast('Logged out');
  setTimeout(()=> requireLogin(), 300);
}

/* apply UI visibility rules based on role */
function applyRoleUI(){
  document.getElementById('roleDisplay').textContent = (session && session.role) ? session.role.toUpperCase() : 'GUEST';
  // toggle elements
  document.querySelectorAll('.hrOnly').forEach(el=> el.style.display = (session && session.role === 'hr') ? 'flex' : 'none');
  document.querySelectorAll('.financeOnly').forEach(el=> el.style.display = (session && session.role === 'finance') ? 'flex' : 'none');
  // If HR, pre-open dashboard and show pending; if finance, open pending
  if(session.role === 'hr') {
    showSection('dashboard');
  } else {
    showSection('pendingPayroll');
  }
}

/* initial login */
requireLogin();

/* ---------------------------
   UI Helpers, section switcher
----------------------------*/
function showSection(id){
  // hide all sections
  document.querySelectorAll('section, #dashboard, .card').forEach(el=>{
    // keep sidebar and header; hide only sections with id matching our named areas
    if(el.id && ['dashboard','pendingPayroll','approvedPayroll','salaryAdvances','messages','audit'].includes(el.id)){
      el.style.display = (el.id === id) ? 'block' : 'none';
    }
  });
  // special handling: dashboard is grid with id "dashboard"
  if(id === 'dashboard'){
    document.getElementById('dashboard').style.display = 'grid';
  }
}

/* ---------------------------
   Audit functions
----------------------------*/
function pushAudit(actor, action, payload=''){
  const arr = read(FIN_AUDIT_KEY);
  arr.push({ id: uid('audit'), actor, action, payload, time: new Date().toISOString() });
  save(FIN_AUDIT_KEY, arr);
  renderAudit();
}
function renderAudit(){
  const arr = read(FIN_AUDIT_KEY).slice().reverse();
  const out = document.getElementById('auditLog');
  if(!arr.length) { out.innerHTML = '<div class="tiny">No audit records</div>'; return; }
  out.innerHTML = arr.map(a=> `<div style="padding:8px;border-bottom:1px solid rgba(0,0,0,0.06)"><strong>${escapeHtml(a.actor)}</strong> — ${escapeHtml(a.action)} <div class="tiny" style="color:#666">${new Date(a.time).toLocaleString()}</div><div class="tiny">${escapeHtml(a.payload)}</div></div>`).join('');
}

/* ---------------------------
   Pending / Approved rendering
----------------------------*/
function renderPending(){
  const arr = read(HR_PAYROLL_KEY).slice().reverse();
  const tbody = document.getElementById('pendingTable');
  tbody.innerHTML = '';
  arr.forEach((b,i)=>{
    const status = b.status || 'pending';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td>
      <td>${escapeHtml(b.batchId)}</td>
      <td>${escapeHtml(b.submittedBy||'HR')}</td>
      <td>${escapeHtml(b.period||'—')}</td>
      <td>${formatCurrency(b.total||0)}</td>
      <td>${escapeHtml(status)}</td>
      <td>
        <button onclick="viewBatch('${b.batchId}')">View</button>
        ${status==='pending' ? `<button onclick="approveBatch('${b.batchId}')">Approve</button><button onclick="rejectBatch('${b.batchId}')">Reject</button>` : ''}
      </td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('kpiPending').textContent = arr.filter(x=> (x.status||'pending') === 'pending').length;
}

function renderApproved(){
  const arr = read(FIN_APPROVED_KEY).slice().reverse();
  const tbody = document.getElementById('approvedTable'); tbody.innerHTML = '';
  arr.forEach((b,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(b.batchId)}</td><td>${escapeHtml(b.approvedBy||'Finance')}</td><td>${escapeHtml(b.period||'—')}</td><td>${formatCurrency(b.total||0)}</td><td>${b.paidOn? new Date(b.paidOn).toLocaleString():'—'}</td><td><button onclick="viewApproved('${b.batchId}')">Details</button></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('kpiApproved').textContent = arr.length;
}

/* ---------------------------
   Approve / Reject / Bulk approve
----------------------------*/
function viewBatch(batchId){
  const arr = read(HR_PAYROLL_KEY);
  const b = arr.find(x=> x.batchId === batchId);
  if(!b) return showToast('Batch not found');
  const details = (b.items||[]).map(it=> `${it.employee} — ${formatCurrency(it.amount)} — ${it.account||'N/A'}`).join('\\n');
  alert(`Batch ${b.batchId}\\nSubmitted by: ${b.submittedBy}\\nPeriod: ${b.period}\\nTotal: ${formatCurrency(b.total)}\\n\\nItems:\\n${details}`);
}

function approveBatch(batchId){
  if(!session || session.role !== 'finance') return showToast('Only finance can approve');
  const arr = read(HR_PAYROLL_KEY);
  const idx = arr.findIndex(x=> x.batchId === batchId);
  if(idx === -1) return showToast('Not found');
  const batch = arr[idx];
  if(batch.status && batch.status !== 'pending') return showToast('Batch already processed');

  // simulate payment processing per item via mock API (will mark paid when all succeeded)
  processBatchPayment(batch).then(result => {
    if(result.success){
      // save to approved
      const approved = read(FIN_APPROVED_KEY);
      const approvedRecord = Object.assign({}, batch, { approvedBy: session.email, approvedAt: new Date().toISOString(), paidOn: new Date().toISOString(), status:'approved', paymentDetails: result.details });
      approved.push(approvedRecord); save(FIN_APPROVED_KEY, approved);

      // mark pending batch as approved
      batch.status = 'approved'; batch.processedAt = new Date().toISOString();
      save(HR_PAYROLL_KEY, arr);

      // push audit & notify
      pushAudit('Finance', 'Approved payroll batch', batch.batchId);
      const msgs = read(FIN_MSG_KEY); msgs.push({ id: uid('msg'), from: session.email, to: batch.submittedBy||'hr@'+ORG.toLowerCase()+'.local', subject:`Payroll ${batch.batchId} approved`, body:`Batch ${batch.batchId} paid.`, date: new Date().toISOString() }); save(FIN_MSG_KEY, msgs);

      renderPending(); renderApproved(); renderMessages(); showToast('Batch approved & paid');
    } else {
      pushAudit('Finance', 'Payment failed', batch.batchId + ' — ' + (result.error||'unknown'));
      showToast('Payment failed: ' + (result.error || 'unknown'));
    }
  });
}

function rejectBatch(batchId){
  if(!session || session.role !== 'finance') return showToast('Only finance can reject');
  const arr = read(HR_PAYROLL_KEY);
  const b = arr.find(x=> x.batchId === batchId);
  if(!b) return showToast('Not found');
  const reason = prompt('Reason for rejection', 'Incorrect totals');
  b.status = 'rejected';
  b.rejectedBy = session.email;
  b.rejectionReason = reason || '';
  b.processedAt = new Date().toISOString();
  save(HR_PAYROLL_KEY, arr);
  pushAudit('Finance', 'Rejected payroll batch', `${batchId} — ${reason}`);
  const msgs = read(FIN_MSG_KEY); msgs.push({ id:uid('msg'), from:session.email, to: b.submittedBy||'hr@'+ORG.toLowerCase()+'.local', subject:`Payroll ${batchId} rejected`, body: reason || 'See notes', date: new Date().toISOString() }); save(FIN_MSG_KEY, msgs);
  renderPending(); renderMessages(); showToast('Batch rejected');
}

/* Bulk approve visible */
document.getElementById('bulkApproveBtn').addEventListener('click', ()=>{
  if(!session || session.role !== 'finance') return showToast('Only finance can approve');
  const arr = read(HR_PAYROLL_KEY);
  const pending = arr.filter(x=> (x.status||'pending') === 'pending');
  if(!pending.length) return showToast('No pending batches');
  if(!confirm(`Approve ${pending.length} pending batches?`)) return;
  // approve sequentially
  (async ()=>{
    for(const b of pending){ await approveBatch(b.batchId); }
    showToast('Bulk approved (attempted)');
  })();
});

/* ---------------------------
   Advances rendering
----------------------------*/
function getAdvances(){ return read(`${ORG}_salary_advances`) }
function saveAdvances(a){ save(`${ORG}_salary_advances`, a) }
if(!localStorage.getItem(`${ORG}_salary_advances`)) saveAdvances([]);

function renderAdvances(){
  const arr = getAdvances().slice().reverse();
  const tbody = document.getElementById('advancesTable'); tbody.innerHTML = '';
  arr.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${r.requestId}</td><td>${escapeHtml(r.employee)}</td><td>${formatCurrency(r.amount)}</td><td>${escapeHtml(r.reason||'')}</td><td>${escapeHtml(r.status)}</td>
      <td>${r.status==='pending' ? `<button onclick="approveAdvance('${r.requestId}')">Approve</button><button onclick="rejectAdvance('${r.requestId}')">Reject</button>` : ''}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('kpiAdvances').textContent = arr.filter(x=> x.status==='approved').length;
}

document.getElementById('newAdvanceBtn').addEventListener('click', ()=>{
  if(!session) return requireLogin();
  const employee = prompt('Employee name (email optional)');
  if(!employee) return showToast('Cancelled');
  const amount = Number(prompt('Amount','0')||0);
  if(!amount) return showToast('Invalid amount');
  const reason = prompt('Reason','')||'';
  const arr = getAdvances();
  const req = { requestId: uid('adv'), employee, amount, reason, status:'pending', requestedAt: new Date().toISOString() };
  arr.push(req); saveAdvances(arr); pushAudit('Finance','Created advance request', req.requestId); renderAdvances(); showToast('Advance requested');
});

function approveAdvance(requestId){
  if(!session || session.role !== 'finance') return showToast('Only finance can approve');
  const arr = getAdvances();
  const r = arr.find(x=> x.requestId===requestId);
  if(!r) return showToast('Not found');
  r.status = 'approved'; r.approvedAt = new Date().toISOString(); saveAdvances(arr); pushAudit('Finance','Approved advance', requestId); renderAdvances(); showToast('Advance approved');
}
function rejectAdvance(requestId){
  if(!session || session.role !== 'finance') return showToast('Only finance can reject');
  const arr = getAdvances();
  const r = arr.find(x=> x.requestId===requestId);
  if(!r) return showToast('Not found');
  const reason = prompt('Reason for rejection','');
  r.status = 'rejected'; r.rejectionReason = reason || ''; saveAdvances(arr); pushAudit('Finance','Rejected advance', requestId+' — '+(reason||'')); renderAdvances(); showToast('Advance rejected');
}

/* ---------------------------
   Messages (Finance ↔ HR)
----------------------------*/
function getFinanceMsgs(){ return read(FIN_MSG_KEY) }
function saveFinanceMsgs(m){ save(FIN_MSG_KEY, m) }
document.getElementById('sendMsgBtn').addEventListener('click', ()=>{
  if(!session) return requireLogin();
  const to = document.getElementById('msgTo').value.trim();
  const subj = document.getElementById('msgSubject').value.trim();
  const body = document.getElementById('msgBody').value.trim();
  if(!subj || !body) return showToast('Complete subject & message');
  const arr = getFinanceMsgs();
  arr.push({ id: uid('msg'), from: session.email, to, subject: subj, body, date: new Date().toISOString() });
  saveFinanceMsgs(arr);
  pushAudit('Finance', `Sent message to ${to}`, `${subj}`);
  renderMessages(); showToast('Message sent');
  document.getElementById('msgTo').value=''; document.getElementById('msgSubject').value=''; document.getElementById('msgBody').value='';
});
function renderMessages(){
  const arr = getFinanceMsgs().slice().reverse(); const tbody = document.getElementById('messagesTable'); tbody.innerHTML = '';
  arr.forEach((m,i)=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(m.from)}</td><td>${escapeHtml(m.to)}</td><td>${escapeHtml(m.subject)}</td><td>${new Date(m.date).toLocaleString()}</td>`; tbody.appendChild(tr); });
}

/* ---------------------------
   Teacher attendance widget stub
----------------------------*/
function renderTeacherSync(){
  const arr1 = read(`${ORG}_teacher_attendance`) || [];
  const arr2 = read(`${ORG}_attendance`) || [];
  const all = (arr1.concat(arr2)).slice().reverse();
  document.getElementById('kpiEmployees').textContent = (read(`${ORG}_employees`) || []).length || all.length || 0;
  const widget = document.getElementById('teacherSync');
  if(widget) widget.textContent = all.length ? `${all[0].email||all[0].employee||'Teacher'} — ${all[0].action||''} — ${new Date(all[0].date||Date.now()).toLocaleString()}` : 'No teacher attendance records';
}

/* ---------------------------
   Linked Accounts (bank/momo/wallet)
----------------------------*/
function addPaymentAccount(){
  const type = document.getElementById('accType').value;
  const name = document.getElementById('accName').value.trim();
  const number = document.getElementById('accNumber').value.trim();
  if(!name || !number) return alert('Fill account fields');
  const arr = read(ACCOUNTS_KEY); arr.push({ id: uid('acc'), type, name, number }); save(ACCOUNTS_KEY, arr); loadAccounts(); showToast('Account added');
}
function loadAccounts(){
  const arr = read(ACCOUNTS_KEY);
  const list = document.getElementById('linkedAccountsList'); const sel = document.getElementById('linkedAccount');
  list.innerHTML = ''; sel.innerHTML = '';
  arr.forEach(a=> {
    list.innerHTML += `<div style="padding:8px;border-bottom:1px solid #eee"><strong>${escapeHtml(a.name)}</strong> (${escapeHtml(a.type)}) — ${escapeHtml(a.number)}</div>`;
    sel.innerHTML += `<option value="${escapeHtml(a.id)}">${escapeHtml(a.name)} — ${escapeHtml(a.number)}</option>`;
  });
}
loadAccounts();

/* ---------------------------
   Per employee pending payments (demo)
----------------------------*/
function loadPendingPayrollTable(){
  const table = document.querySelector('#pendingPayrollTable tbody');
  table.innerHTML = '';
  const pending = read(PENDING_EMP_PAY_KEY) || [];
  pending.forEach((p,i)=>{
    table.innerHTML += `<tr><td>${escapeHtml(p.name)}</td><td>${formatCurrency(p.salary)}</td><td>${escapeHtml(p.month)}</td><td>${escapeHtml(p.status||'Pending')}</td><td><button class="btn success" onclick="openPaymentScreen(${i})">Pay Now</button></td></tr>`;
  });
}
loadPendingPayrollTable();

/* ---------------------------
   Payment modal / confirm
----------------------------*/
let activePayrollIndex = null;
function openPaymentScreen(index){
  activePayrollIndex = index;
  document.getElementById('paymentModal').style.display = 'flex';
}
function closePaymentModal(){
  document.getElementById('paymentModal').style.display = 'none';
}
function confirmPayment(){
  const pending = read(PENDING_EMP_PAY_KEY);
  if(activePayrollIndex == null || !pending[activePayrollIndex]) return showToast('Select payroll record');
  const payRec = pending[activePayrollIndex];
  const method = document.getElementById('paymentMethod').value;
  const accountId = document.getElementById('linkedAccount').value;
  const accounts = read(ACCOUNTS_KEY);
  const acc = accounts.find(a=> a.id === accountId);
  // call mock API
  mockBankApiPay({ to: payRec.name, amount: payRec.salary, method, account: acc }).then(res=>{
    if(res.success){
      payRec.status = 'Paid';
      payRec.paidVia = method;
      payRec.accountRef = acc ? acc.id : null;
      payRec.paidAt = new Date().toISOString();
      // update storage and logs
      save(PENDING_EMP_PAY_KEY, pending);
      const logs = read(PAYMENTS_LOG_KEY); logs.push({ id: uid('pay'), payRec, result: res, paidBy: session ? session.email : 'local' }); save(PAYMENTS_LOG_KEY, logs);
      showToast('Payment successful');
      pushAudit(session ? session.email : 'system', 'Paid salary', `${payRec.name} • ${formatCurrency(payRec.salary)} via ${method}`);
      loadPendingPayrollTable();
      closePaymentModal();
      // update approved list optionally
    } else {
      showToast('Payment failed: ' + (res.error || 'unknown'));
    }
  });
}

/* ---------------------------
   Mock Bank / MoMo API (stub)
   - returns a promise simulating async call
----------------------------*/
function mockBankApiPay({ to, amount, method, account }){
  // This is a stub for demo. In real app you'd call a backend which calls bank/MoMo SDK.
  return new Promise((resolve) => {
    // small delay
    setTimeout(()=>{
      // make "random" success for demo but deterministic: succeed if amount < 10000
      if(Number(amount) <= 1000000){
        const details = { provider: method, account: account ? account.number : 'n/a', txRef: uid('tx') };
        resolve({ success: true, details });
      } else {
        resolve({ success:false, error: 'Amount too large for demo gateway' });
      }
    }, 900 + Math.random()*900);
  });
}

/* ---------------------------
   Payments / Payslip exports (per-employee)
----------------------------*/
function generatePayslipPdf(employee, month, gross, deductions, net, extras = {}) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','pt','a4');
  doc.setFontSize(16); doc.text(`${ORG} — Payslip`, 40, 40);
  doc.setFontSize(11);
  doc.text(`Employee: ${employee}`, 40, 70);
  doc.text(`Month: ${month}`, 40, 86);
  doc.text(`Gross: ${formatCurrency(gross)}`, 40, 102);
  doc.text(`Deductions: ${formatCurrency(deductions)}`, 40, 118);
  doc.text(`Net Pay: ${formatCurrency(net)}`, 40, 134);
  if(extras.notes) doc.text(`Notes: ${extras.notes}`, 40, 150);
  return doc;
}

/* helper that creates PDF for each employee in a batch and zips? (demo: export single PDF per employee) */
function exportPayslipsForBatch(batchId){
  const hr = read(HR_PAYROLL_KEY);
  const batch = hr.find(b => b.batchId === batchId);
  if(!batch) return showToast('Batch not found');
  (batch.items || []).forEach(it=>{
    const doc = generatePayslipPdf(it.employee, batch.period || '—', it.gross || it.amount, it.deductions || 0, it.net || it.amount, { notes: it.notes || '' });
    doc.save(`${batchId}_${it.employee.replace(/\s+/g,'_')}_payslip.pdf`);
  });
  showToast('Payslips exported (one-by-one)');
}

/* ---------------------------
   Exports (CSV/PDF for approved)
----------------------------*/
document.getElementById('exportPayrollCsv').addEventListener('click', ()=>{
  const rows = read(FIN_APPROVED_KEY).map(b=> ({ batchId:b.batchId, approvedBy:b.approvedBy, period:b.period, total:b.total, paidOn:b.paidOn }));
  if(!rows.length) return showToast('No approved payroll to export');
  exportCSV(rows, `${ORG}_approved_payroll_${Date.now()}.csv`);
});
document.getElementById('exportPayrollPdf').addEventListener('click', ()=>{
  const approved = read(FIN_APPROVED_KEY).slice().reverse();
  if(!approved.length) return showToast('No approved payroll');
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','pt','a4'); doc.setFontSize(14); doc.text(`${ORG} — Approved Payroll`, 40, 40); let y = 70;
  approved.forEach((b,i)=>{ doc.text(`${i+1}. ${b.batchId} • ${b.period} • ${formatCurrency(b.total)} • ${b.paidOn || '—'}`, 40, y); y+=14; if(y>720){ doc.addPage(); y=40; } });
  doc.save(`${ORG}_approved_payroll_${Date.now()}.pdf`);
});

/* CSV export helper */
function exportCSV(rows, filename){
  if(!rows.length) return;
  const keys = Object.keys(rows[0]);
  const lines = [keys.join(',')];
  rows.forEach(r => lines.push(keys.map(k=>`"${String(r[k]||'').replace(/"/g,'""')}"`).join(',')));
  const blob = new Blob([lines.join('\\n')], { type:'text/csv' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
}

/* ---------------------------
   Seed demo data if empty
----------------------------*/
(function seedDemo(){
  if(!read(HR_PAYROLL_KEY).length){
    const sample = {
      batchId: 'BATCH_' + Date.now().toString(36).slice(-6).toUpperCase(),
      submittedBy: 'hr@'+ORG.toLowerCase()+'.local',
      period: new Date().toISOString().split('T')[0],
      items: [
        { employee:'Adjei James', account:'ACCT-001', bank:'Bank A', amount:1200, gross:1200, deductions:120, net:1080 },
        { employee:'Ama Serwaa', account:'ACCT-002', bank:'Bank B', amount:1100, gross:1100, deductions:110, net:990 },
        { employee:'Kofi Mensah', account:'ACCT-003', bank:'Bank C', amount:1000, gross:1000, deductions:100, net:900 }
      ],
      total: 3300,
      status: 'pending',
      submittedAt: new Date().toISOString()
    };
    const hr = read(HR_PAYROLL_KEY); hr.push(sample); save(HR_PAYROLL_KEY, hr);
    // seed per-employee pending pay
    const pemp = [
      { name:'Adjei James', salary:1200, month:'2025-11', status:'Pending' },
      { name:'Ama Serwaa', salary:1100, month:'2025-11', status:'Pending' },
      { name:'Kofi Mensah', salary:1000, month:'2025-11', status:'Pending' }
    ];
    save(PENDING_EMP_PAY_KEY, pemp);
    pushAudit('System', 'Seeded demo payroll batch', sample.batchId);
  }
})();

/* ---------------------------
   Render all and wire events
----------------------------*/
function renderAll(){
  renderPending(); renderApproved(); renderAdvances(); renderMessages(); renderAudit(); renderTeacherSync(); loadAccounts(); loadPendingPayrollTable();
}
renderAll();

document.getElementById('refreshPending').addEventListener('click', ()=>{ renderPending(); showToast('Pending refreshed') });
document.getElementById('loadMsgsBtn').addEventListener('click', renderMessages);

/* expose a small API to HR pages for pushing payroll batches (cross-tab) */
window.financeAPI = {
  pushPayrollBatch: function(batch){
    const arr = read(HR_PAYROLL_KEY);
    batch.batchId = batch.batchId || uid('batch');
    batch.status = 'pending';
    batch.submittedAt = new Date().toISOString();
    arr.push(batch);
    save(HR_PAYROLL_KEY, arr);
    pushAudit('HR','Submitted payroll batch', batch.batchId);
    renderAll();
    return batch.batchId;
  },
  markApproved: function(batchId){ approveBatch(batchId); },
  pushEmployeePending: function(emp){ const arr = read(PENDING_EMP_PAY_KEY); arr.push(emp); save(PENDING_EMP_PAY_KEY, arr); loadPendingPayrollTable(); }
};

/* sync across tabs */
window.addEventListener('storage', (e)=>{
  const keys = [HR_PAYROLL_KEY, FIN_APPROVED_KEY, `${ORG}_salary_advances`, FIN_MSG_KEY, FIN_AUDIT_KEY, ACCOUNTS_KEY, PENDING_EMP_PAY_KEY];
  if(keys.includes(e.key)) { setTimeout(()=> renderAll(), 120); }
});

</script>

</body>
</html>
