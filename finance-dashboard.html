<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Finance Dashboard — Flawless Graphics (Glassmorphism)</title>

<!-- Icons & libs -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  /* ===== Glassmorphism Premium Theme ===== */
  :root{
    --bg: linear-gradient(180deg, rgba(245,248,251,1) 0%, rgba(239,246,255,1) 100%);
    --glass-bg: rgba(255,255,255,0.62);
    --glass-border: rgba(255,255,255,0.45);
    --panel-shadow: 0 10px 30px rgba(8,20,40,0.08);
    --accent1: #6b5fff;
    --accent2: #00e0ff;
    --muted: #6b7280;
    --text: #072031;
    --radius: 14px;
    --glass-blur: 10px;
    --success: #10b981;
    --danger: #ef4444;
  }

  html,body{height:100%;margin:0;font-family:Inter, "Poppins", system-ui, Arial; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;}

  .app {
    max-width:1200px;
    margin:28px auto;
    display:grid;
    grid-template-columns: 260px 1fr;
    gap:20px;
    align-items:start;
    padding:0 18px;
  }

  /* ----- SIDEBAR (glass) ----- */
  .sidebar{
    background: linear-gradient(180deg, rgba(255,255,255,0.45), rgba(255,255,255,0.30));
    border-radius:var(--radius);
    padding:18px;
    backdrop-filter: blur(var(--glass-blur));
    border:1px solid var(--glass-border);
    box-shadow:var(--panel-shadow);
    height:calc(100vh - 56px);
    position:sticky; top:28px;
  }
  .brand { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
  .logo { width:46px; height:46px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:800;
    background:linear-gradient(135deg,var(--accent1),var(--accent2)); color:#031224; box-shadow:0 8px 20px rgba(107,95,255,0.12);}
  .orgName { font-weight:800; font-size:16px;}
  .small { color:var(--muted); font-size:13px; }

  .nav { margin-top:10px; display:flex; flex-direction:column; gap:8px; }
  .nav .item { display:flex; gap:12px; align-items:center; padding:10px; border-radius:10px; cursor:pointer; color: #072031; font-weight:700; background: rgba(255,255,255,0.4); border:1px solid transparent; transition:all .18s; }
  .nav .item:hover { transform:translateY(-3px); box-shadow:0 8px 22px rgba(3,18,36,0.06); background: linear-gradient(90deg, rgba(255,255,255,0.86), rgba(255,255,255,0.72)); }
  .nav .item.active { background: linear-gradient(90deg,var(--accent1),var(--accent2)); color:#021; box-shadow:0 12px 36px rgba(107,95,255,0.12); }

  .sidebar .footer { margin-top:auto; display:flex; gap:8px; align-items:center; justify-content:space-between; }

  /* ----- MAIN area ----- */
  .main {
    min-height:calc(100vh - 56px);
    background: linear-gradient(180deg, rgba(255,255,255,0.7), rgba(250,252,255,0.92));
    border-radius:var(--radius);
    padding:18px;
    backdrop-filter: blur(6px);
    border:1px solid var(--glass-border);
    box-shadow:var(--panel-shadow);
  }

  .header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:16px; }
  .title { font-size:18px; font-weight:800; display:flex; gap:12px; align-items:center;}
  .controls { display:flex; gap:8px; align-items:center; }

  .btn { padding:8px 12px; border-radius:10px; border:0; cursor:pointer; font-weight:800; }
  .btn.ghost { background:transparent; border:1px solid rgba(3,18,36,0.05); color:var(--text); }
  .btn.primary { background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:#021; box-shadow:0 10px 26px rgba(11,27,46,0.08); }
  .btn.success { background:var(--success); color:white; }
  .btn.danger { background:var(--danger); color:white; }

  /* KPI grid */
  .kpi-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:12px; margin-bottom:14px; }
  .kpi { padding:14px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.8), rgba(255,255,255,0.7)); border:1px solid rgba(3,18,36,0.03); box-shadow:0 10px 24px rgba(8,20,40,0.04); display:flex; gap:12px; align-items:center; }
  .kpi i{ padding:8px; border-radius:8px; background:rgba(3,18,36,0.04); color:var(--accent2); }
  .kpi .value { font-weight:900; font-size:20px; }
  .kpi .label { color:var(--muted); font-size:13px; }

  /* card sections */
  .card { margin-bottom:14px; border-radius:12px; padding:14px; background: linear-gradient(180deg, rgba(255,255,255,0.75), rgba(255,255,255,0.72)); border:1px solid rgba(3,18,36,0.03); box-shadow:0 10px 30px rgba(8,20,40,0.04); }
  .card-title { font-weight:800; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; }
  .table-wrap { overflow:auto; border-radius:10px; }
  table { width:100%; border-collapse:collapse; min-width:700px; }
  thead th { text-align:left; font-size:13px; color:var(--muted); padding:10px; border-bottom:1px solid rgba(3,18,36,0.06); position:sticky; top:0; background:transparent; }
  tbody td { padding:10px; border-bottom:1px solid rgba(3,18,36,0.03); font-size:14px; color:var(--text); }

  .status-pill { display:inline-block; padding:6px 10px; border-radius:999px; font-weight:800; font-size:12px; color:#fff; }
  .pending { background:#f59e0b; }
  .approved { background:var(--success); }
  .paid { background:var(--success); }
  .rejected { background:var(--danger); }

  /* teacher widget */
  #teacherSync { margin-bottom:12px; padding:12px; border-radius:12px; background:linear-gradient(90deg, rgba(0,224,255,0.06), rgba(107,95,255,0.04)); color:var(--text); }

  /* modal */
  .modal-backdrop { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(3,18,36,0.35); z-index:999; }
  .modal-backdrop.show { display:flex; }
  .modal { width:720px; max-width:94%; border-radius:12px; padding:18px; background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9)); border:1px solid rgba(3,18,36,0.04); box-shadow:0 20px 50px rgba(3,18,36,0.18); }
  .form-row { display:flex; gap:8px; margin-bottom:8px; }
  .input, select, textarea { padding:10px 12px; border-radius:10px; border:1px solid rgba(3,18,36,0.06); background:rgba(255,255,255,0.9); color:var(--text); width:100%; }
  textarea { min-height:96px; resize:vertical; }

  /* responsive */
  @media (max-width:980px){
    .app { grid-template-columns: 1fr; margin:12px; }
    .sidebar{ position:relative; height:auto; top:auto; }
    .modal{ width:92%; }
  }

  /* toast */
  #toast { position:fixed; right:20px; bottom:20px; background:linear-gradient(90deg,var(--accent2),var(--accent1)); color:#021; padding:10px 14px; border-radius:12px; font-weight:800; display:none; box-shadow:0 12px 36px rgba(3,18,36,0.12); z-index:1000; }
  #toast.show{ display:block; }
</style>
</head>
<body>

<div class="app" role="application">
  <!-- SIDEBAR -->
  <aside class="sidebar" aria-label="Finance navigation">
    <div class="brand">
      <div class="logo">F</div>
      <div>
        <div class="orgName" id="orgName">FLAWLESS</div>
        <div class="small">Finance Portal</div>
      </div>
    </div>

    <nav class="nav" id="nav">
      <div class="item active" data-section="dashboard"><i class="fa fa-chart-line"></i> Dashboard</div>
      <div class="item" data-section="pendingPayroll"><i class="fa fa-sack-dollar"></i> Pending Payroll</div>
      <div class="item" data-section="approvedPayroll"><i class="fa fa-check-circle"></i> Approved Payroll</div>
      <div class="item" data-section="salaryAdvances"><i class="fa fa-coins"></i> Salary Advances</div>
      <div class="item" data-section="messages"><i class="fa fa-envelope"></i> Messages</div>
      <div class="item" data-section="audit"><i class="fa fa-history"></i> Audit Trail</div>
    </nav>

    <div class="footer small" style="margin-top:auto">
      <div>Theme</div>
      <div>
        <button class="btn ghost" id="toggleDark"><i class="fa fa-moon"></i></button>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main" id="main">
    <div class="header">
      <div>
        <div class="title">Finance Dashboard — <span id="orgTitle">FLAWLESS</span></div>
        <div class="small">Glassmorphism premium interface</div>
      </div>
      <div class="controls">
        <select id="orgSwitcher" class="input" style="width:160px"></select>
        <button class="btn ghost" id="refreshBtn" title="Refresh"><i class="fa fa-rotate"></i></button>
        <button class="btn primary" id="exportAllBtn"><i class="fa fa-file-export"></i> Export</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpi-grid">
      <div class="kpi"><i class="fa fa-sack-dollar"></i><div><div class="value" id="kPending">0</div><div class="label">Pending Payroll</div></div></div>
      <div class="kpi"><i class="fa fa-circle-check"></i><div><div class="value" id="kApproved">0</div><div class="label">Approved / Paid</div></div></div>
      <div class="kpi"><i class="fa fa-coins"></i><div><div class="value" id="kAdvances">0</div><div class="label">Active Advances</div></div></div>
      <div class="kpi"><i class="fa fa-users"></i><div><div class="value" id="kEmployees">0</div><div class="label">Total Employees</div></div></div>
    </div>

    <!-- Teacher attendance quick -->
    <div id="teacherSync" class="card">
      <strong>Today's Teacher Attendance</strong>
      <div id="teacherSyncContent" class="small" style="margin-top:8px">Loading teacher attendance…</div>
    </div>

    <!-- Sections (cards) -->
    <section id="dashboardSection" class="card">
      <div class="card-title"><span>Overview</span>
        <div>
          <button class="btn ghost" id="btnLoadDemo">Seed Demo</button>
        </div>
      </div>

      <div class="table-wrap" style="margin-top:8px">
        <table aria-label="Recent activity">
          <thead><tr><th>#</th><th>Activity</th><th>Date</th></tr></thead>
          <tbody id="activityTable"></tbody>
        </table>
      </div>
    </section>

    <section id="pendingPayrollSection" class="card" style="display:none">
      <div class="card-title">
        <span>Pending Payroll Requests</span>
        <div>
          <button class="btn" id="btnApproveAll">Approve All</button>
          <button class="btn ghost" id="btnExportPending">Export CSV</button>
        </div>
      </div>

      <div class="table-wrap" style="margin-top:8px">
        <table>
          <thead><tr><th>#</th><th>Batch ID</th><th>Submitted By</th><th>Period</th><th>Total</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="pendingTable"></tbody>
        </table>
      </div>
    </section>

    <section id="approvedPayrollSection" class="card" style="display:none">
      <div class="card-title">
        <span>Approved / Paid Payroll</span>
        <div>
          <button class="btn ghost" id="exportApprovedCSV">Download CSV</button>
          <button class="btn ghost" id="exportApprovedPDF">Download PDF</button>
        </div>
      </div>

      <div class="table-wrap" style="margin-top:8px">
        <table>
          <thead><tr><th>#</th><th>Batch ID</th><th>Approved By</th><th>Period</th><th>Total</th><th>Paid On</th><th>Details</th></tr></thead>
          <tbody id="approvedTable"></tbody>
        </table>
      </div>
    </section>

    <section id="advancesSection" class="card" style="display:none">
      <div class="card-title">
        <span>Salary Advances</span>
        <div><button class="btn primary" id="btnNewAdvance">New Advance</button></div>
      </div>

      <div class="table-wrap" style="margin-top:8px">
        <table>
          <thead><tr><th>#</th><th>Request ID</th><th>Employee</th><th>Amount</th><th>Reason</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="advancesTable"></tbody>
        </table>
      </div>
    </section>

    <section id="messagesSection" class="card" style="display:none">
      <div class="card-title"><span>Finance Messages</span><div></div></div>

      <div style="display:flex; gap:8px; margin-top:8px; align-items:center">
        <input id="msgTo" class="input" placeholder="To (hr or email)" style="width:30%">
        <input id="msgSubject" class="input" placeholder="Subject" style="width:40%">
        <button class="btn primary" id="btnSendMsg">Send</button>
      </div>

      <textarea id="msgBody" class="input" placeholder="Message body" style="margin-top:8px"></textarea>

      <div class="table-wrap" style="margin-top:8px">
        <table>
          <thead><tr><th>#</th><th>From</th><th>To</th><th>Subject</th><th>Date</th></tr></thead>
          <tbody id="messagesTable"></tbody>
        </table>
      </div>
    </section>

    <section id="auditSection" class="card" style="display:none">
      <div class="card-title"><span>Audit Trail</span><div></div></div>
      <div id="auditLog" style="margin-top:8px; max-height:420px; overflow:auto"></div>
    </section>

    <!-- Linked accounts + payment modal trigger -->
    <section class="card" style="display:flex; gap:18px; align-items:flex-start; margin-top:12px">
      <div style="flex:1">
        <div class="card-title">Linked Payment Accounts</div>
        <div id="linkedAccountsList" class="small" style="margin-bottom:8px"></div>

        <div style="display:flex; gap:8px; margin-top:8px">
          <select id="accType" class="input" style="width:36%"><option value="momo">Mobile Money</option><option value="bank">Bank</option><option value="wallet">Wallet</option></select>
          <input id="accName" class="input" placeholder="Account name (e.g., Finance Wallet)">
          <input id="accNumber" class="input" placeholder="Number / IBAN / Identifier" style="width:28%">
          <button class="btn success" id="btnAddAccount">Add Account</button>
        </div>
      </div>

      <div style="width:360px">
        <div class="card-title">Quick Payment</div>
        <div style="display:flex; flex-direction:column; gap:8px">
          <select id="selectPendingForPayment" class="input"></select>
          <select id="paymentMethod" class="input"><option value="momo">Mobile Money</option><option value="bank">Bank Transfer</option><option value="wallet">Internal Wallet</option></select>
          <select id="linkedAccount" class="input"></select>
          <div style="display:flex; gap:8px">
            <button class="btn primary" id="btnPayNow">Pay Selected</button>
            <button class="btn ghost" id="btnCancelPay">Clear</button>
          </div>
        </div>
      </div>
    </section>

  </main>
</div>

<!-- Payment Modal (detail view) -->
<div class="modal-backdrop" id="paymentModal">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="payTitle">
    <h3 id="payTitle">Process Payment</h3>
    <div style="display:flex; gap:10px; margin-top:8px">
      <div style="flex:1">
        <label class="small">Batch</label>
        <input id="modalBatchId" class="input" readonly />
        <label class="small" style="margin-top:6px">Amount</label>
        <input id="modalAmount" class="input" readonly />
        <label class="small" style="margin-top:6px">Method</label>
        <select id="modalMethod" class="input"><option value="momo">Mobile Money</option><option value="bank">Bank Transfer</option><option value="wallet">Internal Wallet</option></select>
        <label class="small" style="margin-top:6px">Linked Account</label>
        <select id="modalLinkedAccount" class="input"></select>
      </div>
      <div style="width:280px">
        <label class="small">Notes</label>
        <textarea id="modalNotes" class="input" placeholder="Payment reference / notes"></textarea>
        <div style="display:flex; gap:8px; margin-top:8px">
          <button class="btn ghost" id="modalCancel">Cancel</button>
          <button class="btn primary" id="modalConfirmPay">Confirm & Pay</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" role="status" aria-live="polite"></div>

<script>
/* ============================
   Finance Dashboard JS (modular)
   Glassmorphism Premium UI
   ============================ */

/* ---------- Utilities ---------- */
function uid(prefix='id'){ return prefix + '_' + Date.now().toString(36) }
function read(key){ return JSON.parse(localStorage.getItem(key) || '[]') }
function save(key,val){ localStorage.setItem(key, JSON.stringify(val)) }
function showToast(msg, ms=2600){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); t.style.display='block'; setTimeout(()=>{ t.classList.remove('show'); t.style.display='none'; }, ms); }

/* ---------- Namespaced keys ---------- */
const ORG = localStorage.getItem('active_org') || 'FLAWLESS';
document.getElementById('orgName').textContent = ORG;
document.getElementById('orgTitle').textContent = ORG;
const HR_PAYROLL_KEY = `${ORG}_hr_payroll_batches`;
const FIN_APPROVED_KEY = `${ORG}_finance_approved_batches`;
const FIN_MSG_KEY = `${ORG}_finance_messages`;
const FIN_AUDIT_KEY = `${ORG}_finance_audit`;
const FIN_ADV_KEY = `${ORG}_salary_advances`;
const TEACH_ATT_KEY = `${ORG}_teacher_attendance`;
const ORG_ATT_KEY = `${ORG}_attendance`;
const ACCOUNTS_KEY = `${ORG}_payment_accounts`;
const FIN_PAYMENTS_KEY = `${ORG}_payments_log`;

/* ensure storage initializations */
if(!localStorage.getItem(HR_PAYROLL_KEY)) save(HR_PAYROLL_KEY, []);
if(!localStorage.getItem(FIN_APPROVED_KEY)) save(FIN_APPROVED_KEY, []);
if(!localStorage.getItem(FIN_MSG_KEY)) save(FIN_MSG_KEY, []);
if(!localStorage.getItem(FIN_AUDIT_KEY)) save(FIN_AUDIT_KEY, []);
if(!localStorage.getItem(FIN_ADV_KEY)) save(FIN_ADV_KEY, []);
if(!localStorage.getItem(ACCOUNTS_KEY)) save(ACCOUNTS_KEY, []);
if(!localStorage.getItem(FIN_PAYMENTS_KEY)) save(FIN_PAYMENTS_KEY, []);

/* ---------- UI wiring (nav sections) ---------- */
const navItems = document.querySelectorAll('.nav .item');
function showSection(id){
  document.querySelectorAll('[id$="Section"]').forEach(s=> s.style.display = 'none');
  document.getElementById(id + 'Section').style.display = 'block';
  navItems.forEach(n=> n.classList.remove('active'));
  document.querySelector('.nav .item[data-section="'+id+'"]').classList.add('active');
}
navItems.forEach(n=> n.addEventListener('click', ()=> showSection(n.dataset.section)));
showSection('dashboard');

/* ---------- Render helpers ---------- */
function formatCurrency(n){
  try { return new Intl.NumberFormat(undefined, {style:'currency', currency:'GHS'}).format(Number(n||0)); }
  catch(e){ return '₵' + Number(n||0).toFixed(2); }
}

/* ---------- Audit ---------- */
function pushAudit(actor, action, payload=''){
  const arr = read(FIN_AUDIT_KEY);
  arr.push({ id: uid('audit'), actor, action, payload, time: new Date().toISOString() });
  save(FIN_AUDIT_KEY, arr);
  renderAudit();
}
function renderAudit(){
  const arr = read(FIN_AUDIT_KEY).slice().reverse();
  const el = document.getElementById('auditLog');
  if(!arr.length){ el.innerHTML = '<div class="small">No audit records</div>'; return; }
  el.innerHTML = arr.map(a=> `<div style="padding:8px;border-bottom:1px solid rgba(3,18,36,0.04)"><strong>${a.actor}</strong> — ${a.action} <div class="small" style="color:var(--muted)">${new Date(a.time).toLocaleString()}</div><div class="small">${a.payload||''}</div></div>`).join('');
}

/* ---------- Messages ---------- */
function renderMessages(){
  const arr = read(FIN_MSG_KEY).slice().reverse();
  const t = document.getElementById('messagesTable'); t.innerHTML = '';
  arr.forEach((m,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${m.from}</td><td>${m.to}</td><td>${m.subject}</td><td>${new Date(m.date).toLocaleString()}</td>`; t.appendChild(tr); });
}
document.getElementById('btnSendMsg').addEventListener('click', ()=>{
  const to = document.getElementById('msgTo').value.trim();
  const subject = document.getElementById('msgSubject').value.trim();
  const body = document.getElementById('msgBody').value.trim();
  if(!to || !subject || !body) return showToast('Fill message fields');
  const arr = read(FIN_MSG_KEY);
  arr.push({ id: uid('msg'), from: 'finance@'+ORG.toLowerCase()+'.local', to, subject, body, date: new Date().toISOString() });
  save(FIN_MSG_KEY, arr);
  pushAudit('Finance','Sent message', subject);
  document.getElementById('msgTo').value = ''; document.getElementById('msgSubject').value = ''; document.getElementById('msgBody').value = '';
  renderMessages();
  showToast('Message sent');
});

/* ---------- Pending payroll rendering ---------- */
function renderPending(){
  const arr = read(HR_PAYROLL_KEY).slice().reverse();
  const tbody = document.getElementById('pendingTable'); tbody.innerHTML = '';
  const selectPending = document.getElementById('selectPendingForPayment');
  selectPending.innerHTML = '<option value="">Select batch to pay…</option>';
  arr.forEach((b,i)=>{
    const tr = document.createElement('tr');
    const status = (b.status || 'pending');
    tr.innerHTML = `<td>${i+1}</td><td>${b.batchId}</td><td>${b.submittedBy||'HR'}</td><td>${b.period||'—'}</td><td>${formatCurrency(b.total)}</td><td><span class="status-pill ${status==='pending'?'pending':status==='approved'?'approved':status==='paid'?'paid':'rejected'}">${status.toUpperCase()}</span></td>
      <td>
        <button class="btn ghost" onclick="viewBatch('${b.batchId}')">View</button>
        ${status==='pending' ? `<button class="btn primary" onclick="approveBatch('${b.batchId}')">Approve</button><button class="btn danger" onclick="rejectBatch('${b.batchId}')">Reject</button>` : ''}
        ${status!=='paid' ? `<button class="btn success" onclick="openPaymentModal('${b.batchId}')">Pay</button>` : ''}
      </td>`;
    tbody.appendChild(tr);
    // populate quick select
    selectPending.innerHTML += `<option value="${b.batchId}">${b.batchId} — ${formatCurrency(b.total)}</option>`;
  });
  document.getElementById('kPending').textContent = arr.filter(x=> (x.status||'pending')==='pending').length;
}

/* ---------- Approved rendering ---------- */
function renderApproved(){
  const arr = read(FIN_APPROVED_KEY).slice().reverse();
  const tbody = document.getElementById('approvedTable'); tbody.innerHTML = '';
  arr.forEach((b,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${b.batchId}</td><td>${b.approvedBy||'Finance'}</td><td>${b.period}</td><td>${formatCurrency(b.total)}</td><td>${b.paidOn?new Date(b.paidOn).toLocaleString():'—'}</td><td><button class="btn ghost" onclick="viewApproved('${b.batchId}')">Details</button></td>`; tbody.appendChild(tr); });
  document.getElementById('kApproved').textContent = arr.length;
}

/* ---------- Advances ---------- */
function renderAdvances(){
  const arr = read(FIN_ADV_KEY).slice().reverse();
  const tbody = document.getElementById('advancesTable'); tbody.innerHTML = '';
  arr.forEach((r,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${r.requestId}</td><td>${r.employee}</td><td>${formatCurrency(r.amount)}</td><td>${r.reason||''}</td><td><span class="status-pill ${r.status==='approved'?'approved':r.status==='rejected'?'rejected':'pending'}">${r.status.toUpperCase()}</span></td><td>${r.status==='pending'?`<button class="btn primary" onclick="approveAdvance('${r.requestId}')">Approve</button><button class="btn danger" onclick="rejectAdvance('${r.requestId}')">Reject</button>`:''}</td>`; tbody.appendChild(tr); });
  document.getElementById('kAdvances').textContent = arr.filter(x=>x.status==='approved').length;
}
document.getElementById('btnNewAdvance').addEventListener('click', ()=>{
  const employee = prompt('Employee name / email');
  if(!employee) return;
  const amount = Number(prompt('Amount','0')||0);
  if(!amount) return showToast('Invalid amount');
  const reason = prompt('Reason','')||'';
  const arr = read(FIN_ADV_KEY);
  arr.push({ requestId: uid('adv'), employee, amount, reason, status:'pending', requestedAt: new Date().toISOString() });
  save(FIN_ADV_KEY, arr);
  pushAudit('Finance','Created advance', employee+' • '+formatCurrency(amount));
  renderAdvances();
  showToast('Advance requested');
});
function approveAdvance(id){ const arr = read(FIN_ADV_KEY); const r = arr.find(x=>x.requestId===id); if(!r) return; r.status='approved'; r.approvedAt=new Date().toISOString(); save(FIN_ADV_KEY, arr); pushAudit('Finance','Approved advance', id); renderAdvances(); showToast('Approved'); }
function rejectAdvance(id){ const arr = read(FIN_ADV_KEY); const r = arr.find(x=>x.requestId===id); if(!r) return; r.status='rejected'; r.rejectionReason = prompt('Rejection reason',''); r.rejectedAt=new Date().toISOString(); save(FIN_ADV_KEY, arr); pushAudit('Finance','Rejected advance', id); renderAdvances(); showToast('Rejected'); }

/* ---------- Batch operations: view / approve / reject ---------- */
function viewBatch(batchId){
  const arr = read(HR_PAYROLL_KEY);
  const b = arr.find(x=>x.batchId===batchId);
  if(!b) return showToast('Batch not found');
  const details = (b.items||[]).map(it=> `${it.employee} — ${formatCurrency(it.amount)} — ${it.bank||'N/A'}`).join('\\n');
  alert(`Batch ${b.batchId}\\nSubmitted by: ${b.submittedBy}\\nPeriod: ${b.period}\\nTotal: ${formatCurrency(b.total)}\\n\\nItems:\\n${details}`);
}
function approveBatch(batchId){
  const arr = read(HR_PAYROLL_KEY);
  const idx = arr.findIndex(x=>x.batchId===batchId);
  if(idx===-1) return showToast('Not found');
  const batch = arr[idx];
  if(batch.status && batch.status !== 'pending') return showToast('Already processed');
  // move to approved
  const approved = read(FIN_APPROVED_KEY);
  const approvedRecord = Object.assign({}, batch, { approvedBy:'finance@'+ORG.toLowerCase()+'.local', approvedAt:new Date().toISOString(), paidOn:new Date().toISOString(), status:'paid' });
  approved.push(approvedRecord); save(FIN_APPROVED_KEY, approved);
  // update original
  batch.status='paid'; batch.processedAt=new Date().toISOString(); arr[idx]=batch; save(HR_PAYROLL_KEY, arr);
  pushAudit('Finance','Approved payroll', batchId);
  // notify HR via message
  const msgs = read(FIN_MSG_KEY); msgs.push({ id: uid('msg'), from:'finance@'+ORG.toLowerCase()+'.local', to: batch.submittedBy || 'hr@'+ORG.toLowerCase()+'.local', subject:`Payroll ${batchId} approved`, body:`Batch ${batchId} approved and paid.`, date:new Date().toISOString() }); save(FIN_MSG_KEY, msgs);
  renderPending(); renderApproved(); renderMessages(); showToast('Batch approved & paid');
}
function rejectBatch(batchId){
  const arr = read(HR_PAYROLL_KEY); const b = arr.find(x=>x.batchId===batchId); if(!b) return showToast('Not found');
  const reason = prompt('Reason for rejection','Incorrect totals') || '';
  b.status='rejected'; b.rejectedBy='finance@'+ORG.toLowerCase()+'.local'; b.rejectionReason = reason; b.processedAt=new Date().toISOString(); save(HR_PAYROLL_KEY, arr);
  pushAudit('Finance','Rejected payroll', batchId+' — '+reason);
  // notify HR
  const msgs=read(FIN_MSG_KEY); msgs.push({ id:uid('msg'), from:'finance@'+ORG.toLowerCase()+'.local', to:b.submittedBy||'hr@'+ORG.toLowerCase()+'.local', subject:`Payroll ${batchId} rejected`, body:reason, date:new Date().toISOString() }); save(FIN_MSG_KEY, msgs);
  renderPending(); renderMessages(); showToast('Batch rejected');
}

/* ---------- Payments: linked accounts + modal ---------- */
function loadAccounts(){
  const accounts = read(ACCOUNTS_KEY);
  const list = document.getElementById('linkedAccountsList');
  const linked = document.getElementById('linkedAccount');
  const modalLinked = document.getElementById('modalLinkedAccount');
  list.innerHTML = ''; linked.innerHTML = '<option value="">Select account</option>'; modalLinked.innerHTML = '<option value="">Select account</option>';
  accounts.forEach(a=>{
    list.innerHTML += `<div style="padding:8px;border-radius:8px;border:1px solid rgba(3,18,36,0.03); margin-bottom:6px"><strong>${a.name}</strong> <div class="small">${a.type} — ${a.number}</div></div>`;
    const label = `${a.name} — ${a.number}`;
    linked.innerHTML += `<option value="${a.name}|${a.number}|${a.type}">${label}</option>`;
    modalLinked.innerHTML += `<option value="${a.name}|${a.number}|${a.type}">${label}</option>`;
  });
}
document.getElementById('btnAddAccount').addEventListener('click', ()=>{
  const type = document.getElementById('accType').value;
  const name = document.getElementById('accName').value.trim();
  const number = document.getElementById('accNumber').value.trim();
  if(!name || !number) return showToast('Fill account name & identifier');
  const arr = read(ACCOUNTS_KEY); arr.push({ id: uid('acc'), type, name, number }); save(ACCOUNTS_KEY, arr); loadAccounts();
  document.getElementById('accName').value=''; document.getElementById('accNumber').value='';
  showToast('Account added');
});

/* Quick pay UI */
document.getElementById('btnPayNow').addEventListener('click', ()=>{
  const selected = document.getElementById('selectPendingForPayment').value;
  if(!selected) return showToast('Choose pending batch');
  const method = document.getElementById('paymentMethod').value;
  const accountVal = document.getElementById('linkedAccount').value;
  if(!accountVal) return showToast('Choose linked account');
  openPaymentModal(selected, method, accountVal);
});
document.getElementById('btnCancelPay').addEventListener('click', ()=> { document.getElementById('selectPendingForPayment').value=''; document.getElementById('linkedAccount').value=''; document.getElementById('paymentMethod').value='momo'; });

/* Open Payment Modal */
function openPaymentModal(batchId, method=null, accountVal=null){
  const arr = read(HR_PAYROLL_KEY);
  const b = arr.find(x=>x.batchId===batchId);
  if(!b) return showToast('Batch not found');
  document.getElementById('modalBatchId').value = b.batchId;
  document.getElementById('modalAmount').value = formatCurrency(b.total);
  document.getElementById('modalMethod').value = method || 'momo';
  const modalLinked = document.getElementById('modalLinkedAccount');
  if(accountVal) modalLinked.value = accountVal;
  document.getElementById('modalNotes').value = '';
  document.getElementById('paymentModal').classList.add('show');
}
document.getElementById('modalCancel').addEventListener('click', ()=> document.getElementById('paymentModal').classList.remove('show'));

/* Confirm & perform payment */
document.getElementById('modalConfirmPay').addEventListener('click', ()=>{
  const batchId = document.getElementById('modalBatchId').value;
  const method = document.getElementById('modalMethod').value;
  const accountVal = document.getElementById('modalLinkedAccount').value;
  const notes = document.getElementById('modalNotes').value.trim();
  if(!batchId) return;
  // perform local "payment" (record in payments log)
  const hr = read(HR_PAYROLL_KEY);
  const idx = hr.findIndex(x=> x.batchId === batchId);
  if(idx === -1) return showToast('Batch missing');
  const batch = hr[idx];
  batch.status = 'paid';
  batch.paidVia = method;
  batch.paidTo = accountVal;
  batch.paidOn = new Date().toISOString();
  batch.paymentNotes = notes;
  // update HR pending list
  hr[idx] = batch; save(HR_PAYROLL_KEY, hr);
  // push into approved/payout history
  const approved = read(FIN_APPROVED_KEY);
  approved.push(Object.assign({}, batch, { approvedBy:'finance@'+ORG.toLowerCase()+'.local', approvedAt:new Date().toISOString() }));
  save(FIN_APPROVED_KEY, approved);
  // payments log
  const payments = read(FIN_PAYMENTS_KEY);
  payments.push({ id: uid('pay'), batchId, amount: batch.total, method, account: accountVal, notes, date: new Date().toISOString() });
  save(FIN_PAYMENTS_KEY, payments);
  pushAudit('Finance','Processed payment', `${batchId} • ${method} • ${accountVal}`);
  // notify HR
  const msgs = read(FIN_MSG_KEY); msgs.push({ id: uid('msg'), from:'finance@'+ORG.toLowerCase()+'.local', to: batch.submittedBy || 'hr@'+ORG.toLowerCase()+'.local', subject:`Payroll ${batchId} paid`, body:`Batch ${batchId} paid via ${method}. Notes: ${notes}`, date:new Date().toISOString() }); save(FIN_MSG_KEY, msgs);
  renderPending(); renderApproved(); renderMessages();
  document.getElementById('paymentModal').classList.remove('show');
  showToast('Payment recorded & notified HR');
});

/* ---------- Teacher attendance / timetable / notes sync ---------- */
function renderTeacherSync(){
  const arr1 = read(TEACH_ATT_KEY) || [];
  const arr2 = read(ORG_ATT_KEY) || [];
  const all = arr1.concat(arr2);
  const content = document.getElementById('teacherSyncContent');
  if(!all || !all.length){ content.textContent = 'No teacher attendance records.'; return; }
  const last = all.slice().reverse()[0];
  content.textContent = `${last.email||last.name||last.employee} • ${last.action||'in/out'} • ${new Date(last.date||last.time||last.createdAt||Date.now()).toLocaleString()}`;
  // quick KPI for total teachers (unique)
  const uniqueTeachers = new Set(all.map(a=> a.email || a.employee || a.name)).size;
  document.getElementById('kEmployees').textContent = uniqueTeachers || (read(`${ORG}_employees`) || []).length || 0;
}

/* ---------- Activity / KPI ---------- */
function renderActivity(){
  const act = read(FIN_AUDIT_KEY).slice().reverse();
  const t = document.getElementById('activityTable'); t.innerHTML = '';
  act.slice(0,50).forEach((a,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${a.action} • ${a.payload||''}</td><td>${new Date(a.time).toLocaleString()}</td>`; t.appendChild(tr); });
}

/* ---------- Exports ---------- */
function exportCSVFromRows(rows, filename){
  if(!rows.length) return showToast('No data to export');
  const keys = Object.keys(rows[0]);
  const lines = [keys.join(',')];
  rows.forEach(r=> lines.push(keys.map(k=> `"${String(r[k]||'').replace(/"/g,'""')}"`).join(',')));
  const blob = new Blob([lines.join('\\n')], { type:'text/csv' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
}
document.getElementById('exportAllBtn').addEventListener('click', ()=>{
  const payload = { payroll: read(HR_PAYROLL_KEY), approved: read(FIN_APPROVED_KEY), payments: read(FIN_PAYMENTS_KEY), accounts: read(ACCOUNTS_KEY), audit: read(FIN_AUDIT_KEY) };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type:'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${ORG}_finance_backup_${Date.now()}.json`; a.click();
  showToast('Exported JSON');
});
document.getElementById('btnExportPending').addEventListener('click', ()=> exportCSVFromRows(read(HR_PAYROLL_KEY), `${ORG}_pending_payroll.csv`));
document.getElementById('exportApprovedCSV').addEventListener('click', ()=> exportCSVFromRows(read(FIN_APPROVED_KEY), `${ORG}_approved_payroll.csv`));
document.getElementById('exportApprovedPDF').addEventListener('click', ()=>{
  const approved = read(FIN_APPROVED_KEY);
  if(!approved.length) return showToast('No approved records');
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','pt','a4'); doc.setFontSize(14); doc.text(`${ORG} — Approved Payroll`, 40, 40);
  let y = 70;
  approved.slice().reverse().forEach((b,i)=>{ doc.text(`${i+1}. ${b.batchId} • ${b.period} • ${formatCurrency(b.total)} • ${b.paidOn?new Date(b.paidOn).toLocaleString():'—'}`, 40, y); y+=14; if(y>740){ doc.addPage(); y=40; } });
  doc.save(`${ORG}_approved_payroll_${Date.now()}.pdf`);
});

/* ---------- Seed demo (for first load) ---------- */
document.getElementById('btnLoadDemo').addEventListener('click', seedDemo);
function seedDemo(){
  // create a sample HR payroll batch if none exists
  const hr = read(HR_PAYROLL_KEY);
  if(!hr.length){
    const sample = {
      batchId: 'BATCH_'+Date.now().toString(36).slice(-6).toUpperCase(),
      submittedBy: 'hr@'+ORG.toLowerCase()+'.local',
      period: new Date().toISOString().split('T')[0],
      items: [
        { employee:'Adjei James', account:'ACCT-001', bank:'Bank A', amount:1200 },
        { employee:'Ama Serwaa', account:'ACCT-002', bank:'Bank B', amount:1100 },
        { employee:'Kofi Mensah', account:'ACCT-003', bank:'Bank C', amount:1000 }
      ],
      total: 3300,
      status: 'pending',
      submittedAt: new Date().toISOString()
    };
    hr.push(sample); save(HR_PAYROLL_KEY, hr);
    pushAudit('System','Seeded demo payroll', sample.batchId);
  }
  // seed an account
  const accs = read(ACCOUNTS_KEY);
  if(!accs.length) { accs.push({ id: uid('acc'), type:'bank', name:'Main Bank', number:'0123456789' }, { id: uid('acc'), type:'momo', name:'Finance MoMo', number:'0551234567' }); save(ACCOUNTS_KEY, accs); }
  renderAll();
  showToast('Demo seeded');
}

/* ---------- Quick view helpers ---------- */
function viewApproved(batchId){
  const arr = read(FIN_APPROVED_KEY);
  const b = arr.find(x=>x.batchId===batchId);
  if(!b) return showToast('Not found');
  const lines = (b.items||[]).map(it=> `${it.employee} — ${formatCurrency(it.amount)} — ${it.bank||'N/A'}`).join('\\n');
  alert(`Approved Batch ${b.batchId}\\nApproved by: ${b.approvedBy}\\nPeriod: ${b.period}\\nTotal: ${formatCurrency(b.total)}\\nPaid On: ${b.paidOn || '—'}\\n\\nItems:\\n${lines}`);
}

/* ---------- Approve all visible ---------- */
document.getElementById('btnApproveAll').addEventListener('click', ()=>{
  const arr = read(HR_PAYROLL_KEY);
  const pending = arr.filter(x=> (x.status||'pending')==='pending');
  if(!pending.length) return showToast('No pending batches');
  if(!confirm(`Approve ${pending.length} pending batches?`)) return;
  pending.forEach(p => approveBatch(p.batchId));
  renderAll();
  showToast('Bulk approved');
});

/* ---------- Storage sync (across tabs) ---------- */
window.addEventListener('storage', (e)=>{
  const watched = [HR_PAYROLL_KEY, FIN_APPROVED_KEY, FIN_MSG_KEY, FIN_AUDIT_KEY, FIN_ADV_KEY, TEACH_ATT_KEY, ORG_ATT_KEY, ACCOUNTS_KEY, FIN_PAYMENTS_KEY];
  if(watched.includes(e.key)) setTimeout(renderAll, 120);
});

/* ---------- Render all ---------- */
function renderAll(){
  renderPending();
  renderApproved();
  renderAdvances();
  renderMessages();
  renderAudit();
  renderTeacherSync();
  renderActivity();
  loadAccounts();
}
renderAll();

/* ---------- Buttons wiring ---------- */
document.getElementById('refreshBtn').addEventListener('click', ()=>{ renderAll(); showToast('Refreshed') });
document.getElementById('selectPendingForPayment').addEventListener('change', (e)=> {
  const val = e.target.value;
  if(!val) return;
  // set quick fields by batch
  const batch = read(HR_PAYROLL_KEY).find(b=>b.batchId===val);
  if(batch) document.getElementById('paymentMethod').value = 'momo';
});
document.getElementById('exportAllBtn').addEventListener('click', ()=> { /* handled above */ });

/* ---------- Utility: approve/reject/bulk done earlier ---------- */

/* ---------- Expose financeAPI for HR pages ---------- */
window.financeAPI = {
  pushPayrollBatch: function(batch){
    const arr = read(HR_PAYROLL_KEY);
    batch.batchId = batch.batchId || uid('batch');
    batch.status = batch.status || 'pending';
    batch.submittedAt = new Date().toISOString();
    arr.push(batch); save(HR_PAYROLL_KEY, arr);
    pushAudit('HR','Submitted payroll batch', batch.batchId);
    renderAll();
    return batch.batchId;
  },
  markApproved: function(batchId){ approveBatch(batchId); },
  pushTeacherAttendance: function(rec){
    const arr = read(TEACH_ATT_KEY); arr.push(Object.assign({}, rec, { createdAt: new Date().toISOString() })); save(TEACH_ATT_KEY, arr); renderTeacherSync();
  },
  pushTimetable: function(t){ save(`${ORG}_teacher_timetable`, t || []); },
  pushNotes: function(notes){ save(`${ORG}_teacher_notes`, notes || []); }
};

/* ---------- Small helpers & initial load ---------- */
function loadAccounts(){ /* load accounts defined earlier */ } // function declared above
loadAccounts();

/* ---------- Initial demo if empty ---------- */
(function initIfEmpty(){
  if(!read(HR_PAYROLL_KEY).length) seedDemo();
})();
</script>

</body>
</html>
